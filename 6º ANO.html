<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Estudos - 6¬∫ Ano</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f1f8 100%);
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
            width: 90%;
            max-width: 700px;
            min-height: 400px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            background: linear-gradient(45deg, #dc3545, #d90429);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 20px;
        }
        h2 { text-align: center; color: #444; }

        /* --- Controle de Abas e Cards --- */
        .question-card, .results-card, .intro-card, #roteiro-content-tab, #apostila-content-tab, #vocab-quiz-card { 
            display: none; 
            flex-direction: column; 
        }
        
        .intro-card { 
            text-align: center; 
        }
        .intro-card input { padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; }
        
        #student-code {
            text-transform: uppercase;
        }

        /* --- (NOVO) Estilo de Abas de Navega√ß√£o (Colorido) --- */
        .tab-buttons {
            display: flex;
            flex-wrap: wrap; /* Permite quebra de linha */
            justify-content: space-around;
            margin-bottom: 25px;
            gap: 8px; /* Espa√ßamento entre os bot√µes */
        }
        .tab-buttons button {
            border: 1px solid transparent; /* Borda sutil */
            font-weight: 600;
            padding: 12px 10px; /* Mais preenchimento */
            border-radius: 8px;
            transition: all 0.3s ease;
            flex-grow: 1; /* Ocupa espa√ßo igual */
            flex-basis: 180px; /* Largura m√≠nima (cria 2 ou 3 colunas) */
            text-align: center;
            cursor: pointer;
            font-size: 0.95rem; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Cores Espec√≠ficas das Abas (Inativas) */
        .tab-buttons .tab-inicio { 
            background-color: #e9ecef; /* Cinza claro */
            color: #495057; /* Cinza escuro */
            border-color: #dee2e6;
        }
        .tab-buttons .tab-quiz-g { 
            background-color: #e6f2ff; /* Azul claro */
            color: #0056b3; /* Azul escuro */
            border-color: #b3d7ff;
        }
        .tab-buttons .tab-quiz-v { 
            background-color: #eafff0; /* Verde claro */
            color: #155724; /* Verde escuro */
            border-color: #b9f0c8;
        }
        .tab-buttons .tab-roteiro { 
            background-color: #fdf5e6; /* Creme */
            color: #c55a11; /* Laranja escuro */
            border-color: #fce3c0;
        }
        .tab-buttons .tab-apostila { 
            background-color: #f4efff; /* Lil√°s claro */
            color: #3b1c6b; /* Roxo escuro */
            border-color: #dcd0ff;
        }
        .tab-buttons .tab-resultados { 
            background-color: #ffeef0; /* Rosa claro */
            color: #721c24; /* Vermelho escuro */
            border-color: #ffd0d6;
        }
        
        .tab-buttons button:hover {
            opacity: 0.85; /* Leve transpar√™ncia */
            transform: translateY(-2px); /* Efeito de levantar */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* O bot√£o ATIVO fica branco e destacado */
        .tab-buttons button.active {
            background-color: #fff; /* Fundo branco */
            color: #007bff; /* Texto azul */
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.25); /* Sombra azul */
            transform: translateY(-3px);
            opacity: 1;
            border-color: #007bff; /* Borda azul */
        }

        /* --- Estilos do Quiz --- */
        .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 25px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { width: 0%; height: 20px; background: linear-gradient(90deg, #007bff, #0056b3); text-align: center; line-height: 20px; color: white; font-weight: bold; transition: width 0.4s ease-in-out; }

        .audio-container {
            width: 100%;
            margin-bottom: 15px;
        }
        .audio-container audio {
            display: none;
        }
        
        #audio-play-container, 
        #vocab-audio-play-container { /* ADICIONADO #vocab-audio-play-container AQUI */
            width: 100%;
            text-align: center; 
            margin-bottom: 15px;
        }
        .audio-play-btn {
            background: linear-gradient(45deg, #17a2b8, #117a8b);
            color: white;
            font-size: 1.1rem;
            width: 80%;
            max-width: 300px;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .audio-play-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }


        .question-text-wrapper {
            display: flex;
            align-items: center; 
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.2rem;
            flex-grow: 1; 
            min-height: 50px; 
            display: flex;
            justify-content: flex-start; 
            align-items: center;
            text-align: left; 
        }

        .translate-btn {
            background: transparent; 
            border: none;            
            color: #007bff;          
            font-size: 2.5rem;       
            cursor: pointer;
            flex-shrink: 0;
            padding: 0;
            margin: 0;
            line-height: 1;
            transition: transform 0.2s; 
        }
        .translate-btn:hover {
            transform: scale(1.15); 
        }
        .translate-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }


        .translation-text {
            margin-top: -15px; 
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 5px solid #ffc107; 
            border-radius: 5px;
            font-style: italic;
            display: none; 
        }


        .options-list { list-style: none; padding: 0; margin: 0; }

        .option-item { 
            background-color: #fff;
            border: 2px solid #ccc; /* <-- Borda padr√£o mais real√ßada (da corre√ß√£o anterior) */
            padding: 16px; 
            margin-bottom: 10px; 
            border-radius: 8px;
            cursor: pointer; 
            font-weight: 500;
            transition: all 0.2s ease; 
        }
        .option-item:hover { 
            background-color: #f8f9fa; 
            border-color: #007bff;
            color: #007bff;
            transform: scale(1.01);
        }
        .option-item.correct { 
            background-color: #d4edda; 
            border-color: #28a745; 
            color: #155724; 
            transform: scale(1.02); 
            font-weight: 700;
        }
        .option-item.incorrect { 
            background-color: #f8d7da; 
            border-color: #dc3545; 
            color: #721c24; 
            animation: shake 0.5s ease-in-out; 
            font-weight: 700;
        }

        .justification { margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-left: 5px solid #007bff; border-radius: 5px; display: block; }

        /* --- Estilo de Bot√£o Geral Aprimorado --- */
        .btn, .next-btn, .skip-btn, .hint-btn { 
            border: none; 
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer; 
            font-size: 1rem;
            font-weight: 600;
            margin-top: 20px; 
            text-decoration: none; 
            display: inline-block; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover, .next-btn:hover, .skip-btn:hover, .hint-btn:hover,
        .start-btn:hover, .restart-btn:hover, .send-report-btn:hover, 
        .print-btn:hover, .share-btn:hover, .save-report-btn:hover, 
        .continue-btn:hover, .check-btn:hover, .performance-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        
        .next-btn, .skip-btn { float: right; margin-left: 10px; }
        
        /* Gradientes nos Bot√µes */
        .next-btn { background: linear-gradient(45deg, #007bff, #0056b3); color: white; display: none; }
        .skip-btn { background: linear-gradient(45deg, #ffc107, #e0a800); color: #333; display: none; }
        .hint-btn { background: linear-gradient(45deg, #6a0dad, #510a83); color: white; float: none; }
        .hint-btn:disabled { background: #ccc; }

        .hint-text { margin-top: 15px; padding: 10px; background-color: #e9ecef; border-left: 5px solid #6c757d; border-radius: 5px; font-style: italic; display: none; white-space: pre-wrap; }

        .question-actions { display: flex; justify-content: flex-end; align-items: center; flex-wrap: wrap; margin-top: 15px; }
        
        .start-btn, .restart-btn, .send-report-btn, .print-btn, .share-btn, .save-report-btn, .continue-btn, .check-btn { 
            display: inline-block; 
            color: white; 
            border: none; 
            padding: 14px 28px; 
            border-radius: 8px;
            cursor: pointer; 
            font-size: 1rem;
            font-weight: 600;
            margin-top: 20px; 
            text-align: center; 
            text-decoration: none; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .start-btn, .continue-btn { 
            background: linear-gradient(45deg, #28a745, #218838); /* Gradiente Verde */
            animation: pulse 2s infinite; 
        }
        
        .restart-btn { 
            background: linear-gradient(45deg, #dc3545, #c82333); /* Gradiente Vermelho */
        }
        .send-report-btn { 
            background: linear-gradient(45deg, #6c757d, #5a6268); /* Gradiente Cinza */
        }
        .print-btn { 
            background: linear-gradient(45deg, #17a2b8, #117a8b); /* Gradiente Ciano */
        } 
        .share-btn { 
            background: linear-gradient(45deg, #25d366, #128C7E); /* Gradiente WhatsApp */
        }
        .share-btn img { width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; }
        .save-report-btn { 
            background: linear-gradient(45deg, #007bff, #0056b3); /* Gradiente Azul */
        }

        .results-actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        .results-card h2 { margin-bottom: 20px; }
        .results-card p { font-size: 1.1rem; line-height: 1.5; }
        .results-card .score-display { font-size: 2.2rem; font-weight: bold; color: #007bff; }

        .question-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; color: #555; }
        
        .full-report-list { margin-top: 30px; padding-top: 20px; border-top: 2px solid #ccc; }
        .full-report-list h3 { color: #007bff; }
        .report-question-item { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .report-question-item p { margin: 5px 0; }
        .report-question-item .option-item-report.correct { background-color: #d4edda; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
        .report-question-item .option-item-report.incorrect { background-color: #f8d7da; padding: 2px 5px; border-radius: 3px; font-weight: bold; }

        .classification-red { color: red; }
        .classification-blue { color: #007bff; }
        .classification-orange { color: #FFA500; font-weight: bold; animation: blink-text 1s linear infinite; }

        .performance-btn { 
            background: linear-gradient(45deg, #FFA500, #e08e00);
            color: white; 
            margin-right: auto; 
        }
        .performance-display { width: 100%; margin-top: 10px; padding: 10px; background-color: #fff3cd; border-left: 5px solid #ffc107; border-radius: 5px; font-weight: bold; color: #856404; text-align: left; }

        #fill-in-input { padding: 12px; width: 100%; border-radius: 8px; border: 2px solid #ccc; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; transition: border-color 0.2s; }
        #fill-in-input:focus { border-color: #007bff; outline: none; }
        #fill-in-input.correct { border: 2px solid #28a745; background-color: #f0fffb; }
        #fill-in-input.incorrect { border: 2px solid #dc3545; background-color: #fff5f5; }
        .check-btn { 
            background: linear-gradient(45deg, #fca311, #e69100);
            color: #14213d; 
            float: left; 
        }
        
        #drop-zone { padding: 15px 25px; border: 2px dashed #007bff; border-radius: 8px; background-color: #f8f9fa; display: inline-block; margin: 0 5px; transition: background-color 0.3s; min-width: 150px; text-align: center; font-style: italic; color: #6c757d; vertical-align: middle; }
        #drop-zone.over { background-color: #e0e9ed; }
        #drop-zone.correct { border-style: solid; border-color: #28a745; background-color: #d4edda; font-style: normal; color: #155724; }
        #drop-zone.incorrect { border-style: solid; border-color: #dc3545; background-color: #f8d7da; font-style: normal; color: #721c24; }
        
        .drag-options-wrapper { margin-top: 20px; text-align: center; }
        .drag-option { padding: 10px 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #e9ecef; cursor: move; margin: 5px; display: inline-block; user-select: none; transition: background-color 0.2s; }
        .drag-option:hover { background-color: #d1e0e6; }
        .drag-option.dragging { opacity: 0.5; }
        
        .personal-summary-item {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .personal-summary-item h4 {
            margin-top: 0;
            color: #856404;
        }
        .personal-summary-item p {
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        /* --- ESTILOS DA ABA DE CONTE√öDO (PDF) --- */
        #roteiro-content-tab, #apostila-content-tab {
            text-align: left; /* Alinhamento padr√£o */
            padding: 10px;
            line-height: 1.6;
        }
        /* Painel de Admin */
        .admin-panel {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .admin-panel h2 {
            margin-top: 0;
            color: #856404;
        }
        .admin-panel code {
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 4px;
            color: #c82333;
            font-family: monospace;
        }
        /* Vis√£o do Aluno */
        .student-content-view {
            text-align: center; /* Centraliza os bot√µes */
        }
        .student-content-view .btn {
            width: 80%; /* Bot√µes maiores */
            margin: 10px auto;
            display: block;
        }
        

        /* --- ESTILOS DO MODAL DE LEITURA --- */
        .modal-overlay {
            display: none; /* Escondido por padr√£o */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
.modal-header h2 {
            margin: 0;
            color: #007bff;
        }
        .modal-close-btn {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #333;
        }
        .btn-night-mode {
            background: #495047;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-night-mode:hover {
            background: #343a40;
        }
        .modal-body {
            /* (Alterado) Otimizado para <iframe> */
            padding: 0;
            height: 70vh; /* Altura fixa para o PDF */
            overflow: hidden; /* Iframe vai cuidar do scroll */
            line-height: 1.6;
            text-align: left;
        }
        
        /* ESTILOS DO MODO NOTURNO */
        .modal-content.night-mode {
            background-color: #2c2c2c; /* Fundo escuro */
            color: #f1f1f1; /* Texto claro */
            border-color: #555;
        }
        .modal-content.night-mode .modal-header { border-bottom-color: #555; }
        .modal-content.night-mode .modal-header h2 { color: #58a6ff; } /* Azul claro */
        .modal-content.night-mode .modal-close-btn { color: #999; }
        .modal-content.night-mode .modal-close-btn:hover { color: #f1f1f1; }
        

        /* --- Anima√ß√µes --- */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); } 50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5); } 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); } }
        @keyframes blink-text { 50% { opacity: 0; } }

        
        /* --- Estilos de Impress√£o --- */
        @media print { 
            body { background-color: #fff; padding-top: 0; display: block; }
            .container { box-shadow: none; border: none; width: 100%; max-width: none; }
            
            .tab-buttons, #intro-card, #question-card, #vocab-quiz-card, #roteiro-content-tab, #apostila-content-tab, .results-actions, .progress-bar-container, .question-header { 
                display: none !important; 
            }
            #results-card { display: block !important; }
            .modal-overlay { display: none !important; } /* Esconde modal na impress√£o */
            
            .full-report-list { 
                border-top: 1px solid #ccc; 
                padding-top: 10px; 
            }
            .report-question-item { page-break-inside: avoid; border: 1px solid #ddd; }
            
            #print-personal-btn {
                display: none !important;
            }
        }
        
        /* --- Ajustes para Celular --- */
        @media (max-width: 600px) {
            body {
                padding-top: 15px; 
            }

            .container {
                width: 95%; 
                padding: 15px; 
                min-height: 0; 
            }

            h1 { font-size: 2.2rem; }
            h2 { font-size: 1.3rem; }
            
            .tab-buttons {
                padding: 3px;
                gap: 5px; /* Espa√ßamento menor no celular */
            }
            .tab-buttons button {
                padding: 10px 5px;
                font-size: 0.8rem;
                flex-basis: 100px; /* Permite 3 bot√µes por linha */
            }

            .question-text { font-size: 1.1rem; }
            .translate-btn { font-size: 2.0rem; padding-left: 10px; }
            .option-item { padding: 12px; }
            .btn, .next-btn, .skip-btn, .hint-btn, .check-btn { padding: 14px 20px; font-size: 1rem; }
            
            .question-actions { flex-direction: column; align-items: stretch; }

            .next-btn, .skip-btn { float: none; width: 100%; margin-left: 0; margin-top: 10px; box-sizing: border-box; }
            .check-btn { float: none; width: 100%; margin-top: 10px; box-sizing: border-box; }

            #performance-btn, #summary-button, #hint-button { width: 100%; margin-top: 10px; box-sizing: border-box; }
            #performance-btn { margin-right: 0; order: 3; }
            #summary-button { order: 2; }
            #hint-button { order: 1; }
            
            .results-actions { flex-direction: column; gap: 10px; }
            .results-actions .btn, .results-actions .send-report-btn, .results-actions .restart-btn, .results-actions .share-btn { width: 100%; margin: 5px 0; box-sizing: border-box; }

            .audio-play-btn { width: 100%; }
            #fill-in-input { width: 100%; margin-bottom: 10px; }
            
            #drop-zone { display: block; margin: 10px 0; min-width: 0; }
            .drag-options-wrapper { margin-top: 15px; }
            .drag-option { display: block; margin: 8px 0; }
            
            /* Ajustes do Modal para Celular */
            .modal-content { width: 95%; max-height: 90vh; padding: 20px 15px; }
            .modal-header { flex-direction: column; gap: 10px; }
            .modal-header h2 { font-size: 1.4rem; }
            .modal-close-btn { position: absolute; top: 10px; right: 15px; }
            
            /* Ajuste Painel Admin */
            .admin-panel { padding: 10px; }
            .admin-panel ol { padding-left: 20px; }
        }
        
    </style>
</head>
<body>

    <div class="container">
        
        <h1>AVALIA√á√ÉO DO 4¬∫ BIMESTRE!!!</h1>

        <div class="tab-buttons">
            <button class="tablinks tab-inicio" onclick="showCard('intro-card', this)">In√≠cio</button>
            <button class="tablinks tab-quiz-g" onclick="checkLoginAndShow('question-card', this)">Quiz - Grammar</button> <button class="tablinks tab-quiz-v" onclick="startVocabQuiz(this)">Quiz - Vocabulary</button> <button class="tablinks tab-roteiro" onclick="checkLoginAndShow('roteiro-content-tab', this)">Roteiro de Estudos</button> <button class="tablinks tab-apostila" onclick="checkLoginAndShow('apostila-content-tab', this)">Apostila Conclu√≠da</button> <button id="results-tab-btn" class="tablinks tab-resultados" onclick="checkLoginAndShowResults('results-card', this)">Resultados</button> </div>


        <div id="intro-card" class="intro-card">
            <h2>English Grammar and Vocabulary Quiz</h2> 
            <p id="personalized-welcome" style="font-size: 1.2rem; font-weight: bold; margin-top: 10px; display: none; color: #dc3545;">Seja bem-vindo(a) e boa sorte!</p>
            <p id="quiz-description">Por favor, insira seu c√≥digo de acesso para iniciar o teste. Ele tem 40 quest√µes. Voc√™ tem tentativas <span id="intro-attempts-left">ilimitadas</span> para fazer este teste.</p>
            <input type="text" id="student-code" placeholder="Your Access Code!">
            <div id="start-actions">
                <button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>
            </div>
        </div>

        <div id="question-card" class="question-card">
<h2 style="text-align:center; color:#0056b3; margin-bottom:20px;">Quiz - Grammar</h2>
            <div id="progress-bar-container" class="progress-bar-container">
                <div id="progress-bar" class="progress-bar">0%</div>
            </div>
            <div class="question-header">
                <span class="question-counter"><span id="current-question-num">1</span> de 40</span>
                <span class="attempts-counter" style="display: none;">Tentativas restantes: <span id="attempts-left">Ilimitadas</span></span>
            </div>
            
            <div id="audio-container" class="audio-container"></div>
            
            <div class="question-text-wrapper">
                <div id="question-text" class="question-text"></div>
                <button id="translate-button" class="translate-btn" title="Traduzir Quest√£o">üåê</button>
            </div>
            <div id="translation-display" class="translation-text"></div>
            
            <div id="audio-play-container"></div> 
            
            <div id="options-list" class="options-list"></div>
            <div id="justification-container"></div>
            <div id="hint-container" style="margin-top: 15px;">
                <button id="hint-button" class="btn hint-btn">Dica</button>
                <div id="hint-text" class="hint-text"></div>
                <div id="summary-text" class="hint-text" style="border-left-color: #28a745;"></div>
            </div>
            <div class="question-actions">
                 <button id="performance-btn" class="btn performance-btn">DESEMPENHO</button>
                <button id="summary-button" class="start-btn" style="background-color: #28a745; display: none;">Resumo</button>
                <button id="skip-button" class="btn skip-btn">Pular Quest√£o</button>
                <button id="next-button" class="btn next-btn">Pr√≥xima Quest√£o</button>
                <div id="performance-display" class="performance-display" style="display: none; width: 100%; flex-basis: 100%; margin-top: 10px;"></div>
            </div>
        </div>
        
        <div id="vocab-quiz-card" class="question-card">
            <h2 style="color: #155724; text-align: center;">Quiz - Vocabulary</h2>
            
            <div id="vocab-progress-bar-container" class="progress-bar-container">
                <div id="vocab-progress-bar" class="progress-bar" style="width: 0%; background: linear-gradient(90deg, #155724, #28a745);">0%</div>
            </div>
            <div class="question-header">
                <span class="question-counter"><span id="vocab-current-question-num">1</span> de 20</span>
                <span class="attempts-counter" style="display: none;">Tentativas: <span id="vocab-attempts-left">Ilimitadas</span></span>
            </div>
            <div id="vocab-audio-play-container"></div>
            <div id="vocab-audio-container" class="audio-container"></div>
            <div class="question-text-wrapper">
                <div id="vocab-question-text" class="question-text">
                    As perguntas do quiz de vocabul√°rio aparecer√£o aqui.
                </div>
                <button id="vocab-translate-button" class="translate-btn" title="Traduzir Quest√£o">üåê</button>
            </div>
            <div id="vocab-translation-display" class="translation-text"></div>
            <div id="vocab-options-list" class="options-list">
                </div>
            <div id="vocab-justification-container"></div>
            <div id="vocab-hint-container" style="margin-top: 15px;">
                <button id="vocab-hint-button" class="btn hint-btn">Dica</button>
                <div id="vocab-hint-text" class="hint-text"></div>
                <div id="vocab-summary-text" class="hint-text" style="border-left-color: #28a745;"></div>
            </div>
            <div class="question-actions">
                 <button id="vocab-performance-btn" class="btn performance-btn">DESEMPENHO</button>
                <button id="vocab-summary-button" class="start-btn" style="background-color: #28a745; display: none;">Resumo</button>
                <button id="vocab-skip-button" class="btn skip-btn">Pular Quest√£o</button>
                <button id="vocab-next-button" class="btn next-btn">Pr√≥xima Quest√£o</button>
                <div id="vocab-performance-display" class="performance-display" style="display: none; width: 100%; flex-basis: 100%; margin-top: 10px;"></div>
            </div>
        </div>
        <div id="results-card" class="results-card">
            <h1>Relat√≥rio Final</h1>
            <p><strong>Nome:</strong> <span id="report-student-name"></span></p>
            <p><strong>C√≥digo de Acesso:</strong> <span id="report-student-code"></span></p>
            <p><strong>Pontua√ß√£o:</strong> <span id="score-display" class="score-display"></span></p>
            <p><strong>Percentual de Acerto:</strong> <span id="percentage-display"></span></p>
            <p><strong>Classifica√ß√£o:</strong> <span id="classification-display"></span></p>
            <div class="results-actions">
                <a id="send-report-link" class="send-report-btn" href="#" target="_blank">Enviar Relat√≥rio ao Professor</a>
                <button class="restart-btn" onclick="quizApp.restartQuiz()">Reiniciar Teste</button>
                <a id="share-whatsapp" class="share-btn" href="#" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"> Compartilhar
                </a>
                <button class="btn save-report-btn" onclick="quizApp.saveReport()">Salvar Relat√≥rio</button>
                <button class="btn print-btn" onclick="quizApp.printReport()">Imprimir Relat√≥rio Detalhado</button>
                <button class="btn skip-btn" style="float: none; display: inline-block;" onclick="quizApp.printPersonalReport()">Imprimir Resumo Pessoal</button>
            </div>
            <div id="full-report-container" class="full-report-list" style="display: none;"></div>
            <div id="personal-report-container" class="full-report-list" style="display: none; border-top: 2px solid #ffc107; margin-top: 20px;"></div>
        </div>

        <div id="roteiro-content-tab" class="tabcontent" style="text-align: left; display: none;">
            
            <div id="admin-panel-roteiro" class="admin-panel" style="display: none;">
                <h2>Painel do Professor (Roteiro)</h2>
                <p>Ol√°, Professor! Como voc√™ est√° logado, esta √© sua √°rea de administra√ß√£o.</p>
                <p><strong>Link do PDF (Roteiro de Estudos):</strong></p>
                <ol style="line-height: 1.6; padding-left: 30px;">
                    <li>Procure a linha de c√≥digo (perto da tag <code>&lt;script&gt;</code>) que diz: <code>const PDF_LINK_ROTEIRO = '...';</code></li>
                    <li>Cole o link do seu PDF (hospedado no Google Drive, etc.) dentro das aspas.</li>
                </ol>
                <p>O link atual √©: <code id="current-pdf-link-roteiro" style="font-weight: bold; color: #dc3545;"></code></p>
                <hr style="margin: 20px 0;">
            </div>
            
            <div id="student-content-view-roteiro" class="student-content-view">
                <h2 style="text-align: center;">Roteiro de Estudos</h2>
                <p style="text-align: center;">Acesse o material de revis√£o em PDF usando os bot√µes abaixo.</p>
                <div id="content-buttons-roteiro">
                    </div>
            </div>
        </div>
        
        <div id="apostila-content-tab" class="tabcontent" style="text-align: left; display: none;">
            
            <div id="admin-panel-apostila" class="admin-panel" style="display: none;">
                <h2>Painel do Professor (Apostila)</h2>
                <p><strong>Link do PDF (Apostila Conclu√≠da):</strong></p>
                <ol style="line-height: 1.6; padding-left: 30px;">
                    <li>Procure a linha de c√≥digo (perto da tag <code>&lt;script&gt;</code>) que diz: <code>const PDF_LINK_APOSTILA = '...';</code></li>
                    <li>Cole o link do seu PDF (hospedado no Google Drive, etc.) dentro das aspas.</li>
                </ol>
                <p>O link atual √©: <code id="current-pdf-link-apostila" style="font-weight: bold; color: #dc3545;"></code></p>
                <hr style="margin: 20px 0;">
            </div>
            
            <div id="student-content-view-apostila" class="student-content-view">
                <h2 style="text-align: center;">Apostila Conclu√≠da</h2>
                <p style="text-align: center;">Acesse a apostila completa em PDF usando os bot√µes abaixo.</p>
                <div id="content-buttons-apostila">
                    </div>
            </div>
        </div>

    </div>
    
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Material de Estudo</h2>
                <button id="night-mode-toggle" class="btn-night-mode">Modo Noturno üåô</button>
                <span id="modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div id="modal-body" class="modal-body">
                </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>

    <script>
        
        // --------------------------------------------------------------------
        // LINKS DOS PDFs - O PROFESSOR (JR123) DEVE COLAR OS LINKS AQUI
        // --------------------------------------------------------------------
        const PDF_LINK_ROTEIRO = 'https://drive.google.com/file/d/194vBM6m-YD2MhhZWcCJdcaU9KAm3Eih4/preview';   
        const PDF_LINK_APOSTILA = 'https://drive.google.com/file/d/11s6ZmlNdkkkWAx8zPmTUK52Jvw-qDq05/preview';  
        // --------------------------------------------------------------------


        // --- FUN√á√ÉO DE NAVEGA√á√ÉO POR ABAS ---
        function showCard(cardId, element) {
            const validIds = ['intro-card', 'question-card', 'vocab-quiz-card', 'results-card', 'roteiro-content-tab', 'apostila-content-tab'];
            
            validIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            const buttons = document.querySelectorAll('.tablinks');
            buttons.forEach(btn => btn.classList.remove('active'));

            const card = document.getElementById(cardId);
            if (card) {
                if (['intro-card', 'question-card', 'vocab-quiz-card', 'results-card'].includes(cardId)) {
                    card.style.display = 'flex';
                    card.style.flexDirection = 'column';
                } else {
                    card.style.display = 'block';
                }
            }
            if (element) {
                element.classList.add('active');
            } else {
                const firstBtn = document.querySelector('.tablinks');
                if (firstBtn) firstBtn.classList.add('active');
            }
        }
        
        // --- L√ìGICA DO PDF DO ROTEIRO DE ESTUDOS ---
        function setupAdminViewRoteiro(isAdmin) {
            const adminPanel = document.getElementById('admin-panel-roteiro');
            const studentView = document.getElementById('student-content-view-roteiro');
            const contentButtons = document.getElementById('content-buttons-roteiro');
            const currentPdfLinkEl = document.getElementById('current-pdf-link-roteiro');

            if (isAdmin) {
                adminPanel.style.display = 'block';
                currentPdfLinkEl.textContent = PDF_LINK_ROTEIRO || "(Nenhum link definido)";
            } else {
                adminPanel.style.display = 'none';
            }

            studentView.style.display = 'block';
            contentButtons.innerHTML = ''; 
            
            if (PDF_LINK_ROTEIRO && PDF_LINK_ROTEIRO !== 'COLE_O_LINK_DO_ROTEIRO_AQUI') {
                const readBtn = document.createElement('button');
                readBtn.className = 'btn save-report-btn'; 
                readBtn.innerHTML = 'Ler Roteiro Online üìñ';
                readBtn.onclick = () => openReadModal(PDF_LINK_ROTEIRO, 'Roteiro de Estudos'); 
                
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn start-btn'; 
                downloadBtn.innerHTML = 'Baixar Roteiro üíæ';
                downloadBtn.onclick = () => downloadContent(PDF_LINK_ROTEIRO); 
                
                contentButtons.appendChild(readBtn);
                contentButtons.appendChild(downloadBtn);
            } else {
                contentButtons.innerHTML = '<p style="text-align: center; font-weight: bold; color: #dc3545;">Nenhum roteiro em PDF foi carregado pelo professor ainda.</p>';
            }
        }
        
        // --- L√ìGICA DO PDF DA APOSTILA CONCLU√çDA ---
        function setupAdminViewApostila(isAdmin) {
            const adminPanel = document.getElementById('admin-panel-apostila');
            const studentView = document.getElementById('student-content-view-apostila');
            const contentButtons = document.getElementById('content-buttons-apostila');
            const currentPdfLinkEl = document.getElementById('current-pdf-link-apostila');

            if (isAdmin) {
                adminPanel.style.display = 'block';
                currentPdfLinkEl.textContent = PDF_LINK_APOSTILA || "(Nenhum link definido)";
            } else {
                adminPanel.style.display = 'none';
            }

            studentView.style.display = 'block';
            contentButtons.innerHTML = ''; 
            
            if (PDF_LINK_APOSTILA && PDF_LINK_APOSTILA !== 'COLE_O_LINK_DA_APOSTILA_AQUI') {
                const readBtn = document.createElement('button');
                readBtn.className = 'btn save-report-btn'; 
                readBtn.innerHTML = 'Ler Apostila Online üìñ'; 
                readBtn.onclick = () => openReadModal(PDF_LINK_APOSTILA, 'Apostila Conclu√≠da'); 
                
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn start-btn'; 
                downloadBtn.innerHTML = 'Baixar Apostila üíæ'; 
                downloadBtn.onclick = () => downloadContent(PDF_LINK_APOSTILA); 
                
                contentButtons.appendChild(readBtn);
                contentButtons.appendChild(downloadBtn);
            } else {
                contentButtons.innerHTML = '<p style="text-align: center; font-weight: bold; color: #dc3545;">Nenhuma apostila em PDF foi carregada pelo professor ainda.</p>';
            }
        }

        // --------------------------------------------------------------------
        // (PASSO 2) - FUN√á√ïES DE VERIFICA√á√ÉO DE LOGIN DAS ABAS
        // --------------------------------------------------------------------

        /**
         * Verifica se o usu√°rio est√° logado antes de mostrar um card simples.
         * Usado para Roteiro, Apostila e Quiz de Gram√°tica.
         */
        function checkLoginAndShow(cardId, element) {
            if (!quizApp.validatedStudentCode) {
                alert('Por favor, fa√ßa o login na aba "In√≠cio" primeiro!');
                showCard('intro-card', document.querySelector('.tab-inicio'));
                return;
            }
            // Se estiver logado, apenas mostra o card
            showCard(cardId, element);
        }

        /**
         * Verifica o login e, se logado, tenta mostrar o √∫ltimo relat√≥rio.
         * Usado para a aba "Resultados".
         */
        function checkLoginAndShowResults(cardId, element) {
            if (!quizApp.validatedStudentCode) {
                alert('Por favor, fa√ßa o login na aba "In√≠cio" primeiro!');
                showCard('intro-card', document.querySelector('.tab-inicio'));
                return;
            }

            // Se logado, verifica se h√° relat√≥rios para mostrar
            const code = quizApp.validatedStudentCode;
            const grammarReportJSON = localStorage.getItem(`quizReport_${code}`);
            const vocabReportJSON = localStorage.getItem(`vocabQuizReport_${code}`);

            if (grammarReportJSON) {
                quizApp.retrieveReport(code); // Isto j√° mostra o card de resultados
            } else if (vocabReportJSON) {
                vocabQuizApp.retrieveReport(code); // Isto j√° mostra o card de resultados
            } else {
                // Se n√£o houver relat√≥rios, avisa e volta ao in√≠cio
                alert("Voc√™ ainda n√£o completou nenhum quiz para ver os resultados. Termine um quiz primeiro!");
                showCard('intro-card', document.querySelector('.tab-inicio'));
            }
        }
        
        // (FIM DO PASSO 2)
        
        // --------------------------------------------------------------------
        // NOVO BLOCO DE QUEST√ïES E L√ìGICA DO QUIZ DE VOCABUL√ÅRIO
        // --------------------------------------------------------------------

        const vocabQuestions = [
            // --- 5 Quest√µes de M√∫ltipla Escolha (MCQ) ---
            { 
      type: 'mcq', 
      question: '1. Qual meio de transporte √© uma abreviatura de "recreational vehicle"?', 
      topic: "Transport", 
      hint: "DICA 1: Usado para longas viagens nos EUA.", 
      hint_2: "DICA 2: Home on wheels.", 
      options: [ 
        { "text": "Subway", "isCorrect": false, "rationale": "Incorreto. Subway √© o metr√¥." }, 
        { "text": "Motorhome", "isCorrect": true, "rationale": "Correto. √â o ve√≠culo recreativo (RV)." }, 
        { "text": "Ferry", "isCorrect": false, "rationale": "Incorreto. Ferry √© a balsa." }, 
        { "text": "On horseback", "isCorrect": false, "rationale": "Incorreto. √â a cavalo." } 
      ] 
    },
    { 
      type: 'mcq', 
      question: '2. Qual das celebra√ß√µes abaixo n√£o ocorre em Outubro?', 
      topic: "Holidays", 
      hint: "DICA 1: Ocorre em Novembro.", 
      hint_2: "DICA 2: √â o Dia de A√ß√£o de Gra√ßas.", 
      options: [ 
        { "text": "Columbus Day", "isCorrect": false, "rationale": "Incorreto. Ocorre na 2¬™ segunda-feira de Outubro." }, 
        { "text": "Halloween", "isCorrect": false, "rationale": "Incorreto. Ocorre em 31 de Outubro." }, 
        { "text": "Thanksgiving Day", "isCorrect": true, "rationale": "Correto. Ocorre na 4¬™ quinta-feira de Novembro nos EUA." }, 
        { "text": "Trick or Treat", "isCorrect": false, "rationale": "Incorreto. √â uma atividade do Halloween." } 
      ] 
    },
    { 
      type: 'mcq', 
      question: '3. Qual a tradu√ß√£o de "Eggplant"?', 
      topic: "Food", 
      hint: "DICA 1: √â uma verdura roxa.", 
      hint_2: "DICA 2: B_____a.", 
      options: [ 
        { "text": "Couve-flor", "isCorrect": false, "rationale": "Incorreto. Couve-flor √© Cauliflower." }, 
        { "text": "Pepino", "isCorrect": false, "rationale": "Incorreto. Pepino √© Cucumber." }, 
        { "text": "Berinjela", "isCorrect": true, "rationale": "Correto." }, 
        { "text": "Batata", "isCorrect": false, "rationale": "Incorreto. Batata √© Potato." } 
      ] 
    },
    { 
      type: 'mcq', 
      question: '4. Qual o profissional que pilota um submarino?', 
      topic: "Professions", 
      hint: "DICA 1: Profiss√£o naval.", 
      hint_2: "DICA 2: Come√ßa com S.", 
      options: [ 
        { "text": "Pilot", "isCorrect": false, "rationale": "Incorreto. Pilotos operam avi√µes ou helic√≥pteros." }, 
        { "text": "Astronaut", "isCorrect": false, "rationale": "Incorreto. Astronautas operam foguetes (rockets)." }, 
        { "text": "Sailor", "isCorrect": true, "rationale": "Correto. Sailor (marinheiro) opera embarca√ß√µes, incluindo submarinos." }, 
        { "text": "Driver", "isCorrect": false, "rationale": "Incorreto. Drivers operam caminh√µes (trucks)." } 
      ] 
    },
    { 
      type: 'mcq', 
      question: '5. O que os australianos tradicionalmente fazem no Natal, que √© quente?', 
      topic: "Holidays", 
      hint: "DICA 1: √â uma atividade ao ar livre.", 
      hint_2: "DICA 2: Churrasco.", 
      options: [ 
        { "text": "Constroem bonecos de neve", "isCorrect": false, "rationale": "Incorreto. O Natal na Austr√°lia √© no ver√£o." }, 
        { "text": "Fazem churrascos na praia", "isCorrect": true, "rationale": "Correto. Barbecues e beach time s√£o comuns." }, 
        { "text": "Ficam perto da lareira", "isCorrect": false, "rationale": "Incorreto. Lareira √© mais comum em pa√≠ses de inverno." }, 
        { "text": "Fazem 'Trick or Treat'", "isCorrect": false, "rationale": "Incorreto. Isso √© do Halloween." } 
      ] 
    },
    { 
      type: 'mcq', 
      question: '6. A frase "They are going to school by boat" descreve a realidade de alunos em:', 
      topic: "Transport", 
      hint: "DICA 1: O PDF menciona este transporte em uma ilha.", 
      hint_2: "DICA 2: Fica na Indon√©sia.", 
      options: [ 
        { "text": "Canad√°", "isCorrect": false, "rationale": "Incorreto." }, 
        { "text": "Indon√©sia", "isCorrect": true, "rationale": "Correto. O PDF mostra alunos na Indon√©sia indo de barco." }, 
        { "text": "Estados Unidos", "isCorrect": false, "rationale": "Incorreto." }, 
        { "text": "Uganda", "isCorrect": false, "rationale": "Incorreto. Uganda √© de caminh√£o (truck)." } 
      ] 
    },
    { 
      type: 'mcq', 
      question: '7. Qual dos itens abaixo √© um "vegetable" do grupo Vermelho/Red?', 
      topic: "Food", 
      hint: "DICA 1: Tamb√©m √© um fruto, mas usado como vegetal.", 
      hint_2: "DICA 2: Usado em saladas e molhos. (T).", 
      options: [ 
        { "text": "Onion", "isCorrect": false, "rationale": "Incorreto. Onion (cebola) √© do grupo Branco/White." }, 
        { "text": "Tomato", "isCorrect": true, "rationale": "Correto. Tomato (tomate) √© listado no grupo vermelho." }, 
        { "text": "Apricot", "isCorrect": false, "rationale": "Incorreto. Apricot (damasco) √© do grupo Amarelo/Yellow ou Laranja/Orange." }, 
        { "text": "Broccoli", "isCorrect": false, "rationale": "Incorreto. Broccoli (br√≥colis) √© do grupo Verde/Green." } 
      ] 
    },
    { 
      type: 'mcq', 
      question: '8. O que significa a palavra "knock" na descri√ß√£o do Halloween?', 
      topic: "Holidays", 
      hint: "DICA 1: √â o que as crian√ßas fazem na porta.", 
      hint_2: "DICA 2: B_____m.", 
      options: [ 
        { "text": "Penduram", "isCorrect": false, "rationale": "Incorreto. Pendurar √© 'hang'." }, 
        { "text": "Batem", "isCorrect": true, "rationale": "Correto. 'Knock' significa bater (na porta)." }, 
        { "text": "Trocam", "isCorrect": false, "rationale": "Incorreto. Trocar √© 'exchange'." }, 
        { "text": "Vestem", "isCorrect": false, "rationale": "Incorreto. Vestir fantasias √© 'dress up'." } 
      ] 
    },
    { 
      type: 'mcq', 
      question: '9. Qual meio de transporte √© uma "mobile library" no Qu√™nia?', 
      topic: "Transport", 
      hint: "DICA 1: Animal do deserto.", 
      hint_2: "DICA 2: Usado para transporte em regi√µes √°ridas.", 
      options: [ 
        { "text": "Book boat (Norway)", "isCorrect": false, "rationale": "Incorreto. √â um barco na Noruega." }, 
        { "text": "Truck (Angola)", "isCorrect": false, "rationale": "Incorreto. √â um caminh√£o em Angola." }, 
        { "text": "Bicycle (Seattle)", "isCorrect": false, "rationale": "Incorreto. √â uma bicicleta nos EUA." }, 
        { "text": "Camel (Kenya)", "isCorrect": true, "rationale": "Correto. O PDF menciona a biblioteca m√≥vel de camelo no Qu√™nia." } 
      ] 
    },
    { 
      type: 'mcq', 
      question: '10. Qual a tradu√ß√£o de "A box of chocolates"?', 
      topic: "Containers", 
      hint: "DICA 1: 'Box' √© o recipiente. 'Chocolates' √© o conte√∫do.", 
      hint_2: "DICA 2: Uma c____ de c______s.", 
      options: [ 
        { "text": "Uma barra de chocolate", "isCorrect": false, "rationale": "Incorreto. 'Bar' significa barra." }, 
        { "text": "Uma caixa de chocolates", "isCorrect": true, "rationale": "Correto." }, 
        { "text": "Um pacote de batatas fritas", "isCorrect": false, "rationale": "Incorreto. Batata frita √© 'crisps'." }, 
        { "text": "Uma lata de atum", "isCorrect": false, "rationale": "Incorreto. 'Tin' significa lata." } 
      ] 
    },
    
    // --- 5 Quest√µes de Preenchimento de Lacunas (Fill-in) - Comida e Profiss√µes ---
    { 
      type: 'fill-in', 
      question: '11. (Profiss√£o) O profissional que trabalha em uma padaria √© um ______.', 
      topic: "Professions", 
      hint: "DICA 1: O padeiro.", 
      hint_2: "DICA 2: Come√ßa com B.", 
      answer: ["BAKER"], 
      rationale: "Correto. 'Baker' √© padeiro." 
    },
    { 
      type: 'fill-in', 
      question: '12. (Comida) O ingrediente principal do sushi mencionado no texto √© ______.', 
      topic: "Food", 
      hint: "DICA 1: √â um tipo de cereal.", 
      hint_2: "DICA 2: A base de muitos pratos.", 
      answer: ["RICE"], 
      rationale: "Correto. O PDF lista o arroz ('rice') como ingrediente de um dos pratos." 
    },
    { 
      type: 'fill-in', 
      question: '13. (Profiss√£o) O profissional que trabalha em um banco √© um ______ clerk.', 
      topic: "Professions", 
      hint: "DICA 1: O funcion√°rio do banco.", 
      hint_2: "DICA 2: 'Clerk' significa funcion√°rio.", 
      answer: ["BANK"], 
      rationale: "Correto. Bank clerk √© o funcion√°rio de banco." 
    },
    { 
      type: 'fill-in', 
      question: '14. (Vegetal) ______ √© o nome em ingl√™s para Couve-flor.', 
      topic: "Food", 
      hint: "DICA 1: Come√ßa com C.", 
      hint_2: "DICA 2: Tem 'flower' no nome.", 
      answer: ["CAULIFLOWER"], 
      rationale: "Correto." 
    },
    { 
      type: 'fill-in', 
      question: '15. (Transporte) Um ve√≠culo de tr√™s rodas, como o da Tail√¢ndia, √© um ______.', 
      topic: "Transport", 
      hint: "DICA 1: Nome t√≠pico asi√°tico.", 
      hint_2: "DICA 2: T_k T_k.", 
      answer: ["TUK TUK"], 
      rationale: "Correto." 
    },

    // --- 5 Quest√µes de √Åudio (Audio_MCQ) - Usando as Frases do Bloco 2 ---
    { 
      type: 'audio_mcq', 
      audioSrc: 'https://files.catbox.moe/gfn9k4.mp3', 
      question: '16. Ou√ßa a frase. O que a palavra sublinhada significa? (Frase: The ferry transports cars and people.)',
      hint: "DICA 1: √â um tipo de barco para travessias curtas.",
      hint_2: "DICA 2: Come√ßa com B.",
      topic: "Transport", 
      options: [ 
        { "text": "Trem", "isCorrect": false, "rationale": "Incorreto. Trem √© Train." }, 
        { "text": "Balsa", "isCorrect": true, "rationale": "Correto. Ferry significa balsa." }, 
        { "text": "Avi√£o", "isCorrect": false, "rationale": "Incorreto. Avi√£o √© Airplane." }, 
        { "text": "Metr√¥", "isCorrect": false, "rationale": "Incorreto. Metr√¥ √© Subway." } 
      ] 
    },
    { 
      type: 'audio_mcq', 
      audioSrc: 'https://files.catbox.moe/4lsami.mp3', 
      question: '17. Ou√ßa a frase. Qual vegetal √© mencionado que se assemelha a uma √°rvore pequena? (Frase: I love to eat fresh broccoli and cucumber.)',
      hint: "DICA 1: Come√ßa com B.",
      hint_2: "DICA 2: √â verde.",
      topic: "Food", 
      options: [ 
        { "text": "Pepino", "isCorrect": false, "rationale": "Incorreto. Pepino √© Cucumber." }, 
        { "text": "Br√≥colis", "isCorrect": true, "rationale": "Correto." }, 
        { "text": "Couve-flor", "isCorrect": false, "rationale": "Incorreto. Couve-flor √© Cauliflower." }, 
        { "text": "Berinjela", "isCorrect": false, "rationale": "Incorreto. Berinjela √© Eggplant." } 
      ] 
    },
    { 
      type: 'audio_mcq', 
      audioSrc: 'https://files.catbox.moe/lbvwxq.mp3', 
      question: '18. Ou√ßa a frase. Qual m√™s √© citado para a celebra√ß√£o? (Frase: Columbus Day is celebrated in October.)',
      hint: "DICA 1: O m√™s do Halloween.",
      hint_2: "DICA 2: Come√ßa com O.",
      topic: "Holidays", 
      options: [ 
        { "text": "Novembro", "isCorrect": false, "rationale": "Incorreto. Novembro √© November (Thanksgiving)." }, 
        { "text": "Dezembro", "isCorrect": false, "rationale": "Incorreto. Dezembro √© December (Christmas)." }, 
        { "text": "Outubro", "isCorrect": true, "rationale": "Correto." }, 
        { "text": "Setembro", "isCorrect": false, "rationale": "Incorreto. Setembro √© September." } 
      ] 
    },
    { 
      type: 'audio_mcq', 
      audioSrc: 'https://files.catbox.moe/vba1k0.mp3', 
      question: '19. Ou√ßa a frase. Qual profissional √© mencionado? (Frase: The sailor works on a submarine.)',
      hint: "DICA 1: Marinheiro.",
      hint_2: "DICA 2: Come√ßa com S.",
      topic: "Professions", 
      options: [ 
        { "text": "Astronauta", "isCorrect": false, "rationale": "Incorreto. Astronauta √© Astronaut." }, 
        { "text": "Motorista", "isCorrect": false, "rationale": "Incorreto. Motorista √© Driver." }, 
        { "text": "Marinheiro", "isCorrect": true, "rationale": "Correto." }, 
        { "text": "Banc√°rio", "isCorrect": false, "rationale": "Incorreto. Banc√°rio √© Bank Clerk." } 
      ] 
    },
    { 
      type: 'audio_mcq', 
      audioSrc: 'https://files.catbox.moe/8aaxq5.mp3', 
      question: '20. Ou√ßa a frase. Qual recipiente √© mencionado? (Frase: A can of coke is a junk food option.)',
      hint: "DICA 1: Recipiente de metal para bebidas.",
      hint_2: "DICA 2: Come√ßa com L.",
      topic: "Containers", 
      options: [ 
        { "text": "Fatia (Slice)", "isCorrect": false, "rationale": "Incorreto. Slice √© fatia." }, 
        { "text": "Barra (Bar)", "isCorrect": false, "rationale": "Incorreto. Bar √© barra." }, 
        { "text": "Copo (Glass)", "isCorrect": false, "rationale": "Incorreto. Glass √© copo." }, 
        { "text": "Lata (Can)", "isCorrect": true, "rationale": "Correto." } 
      ] 
    }
];

const vocabSummaries = {
    "Food": "Vocabul√°rio de Alimentos: Broccoli, Cucumber, Eggplant, Cauliflower, Onion, Tomato. Lembre-se do 'Rainbow Plate' para uma dieta saud√°vel.",
    "Containers": "Termos de embalagens: A can of coke (Lata), A box of chocolates (Caixa), A tin of tuna (Lata de atum), A bar of chocolate (Barra).",
    "Transport": "Meios de transporte: Ferry (Balsa), Motorhome (RV), Subway (Metr√¥), Rocket (Foguete), Camel (Camelo) e Tuk Tuk.",
    "Holidays": "Festividades: Columbus Day (Outubro), Halloween ('Trick or Treat'), Thanksgiving (Novembro), Christmas (Dezembro - com costumes diferentes no hemisf√©rio sul)." ,
    "Professions": "Profiss√µes e locais de trabalho: Sailor (Marinheiro - Submarino), Pilot (Piloto - Avi√£o), Astronaut (Astronauta - Foguete), Baker (Padeiro - Padaria)."
};

        function startVocabQuiz(element) {
            if (!quizApp.validatedStudentCode) {
                alert('Por favor, fa√ßa o login na aba "In√≠cio" primeiro!');
                showCard('intro-card', document.querySelector('.tab-inicio'));
                return;
            }
            
            // Passa a informa√ß√£o do aluno para o quiz de vocabul√°rio
            vocabQuizApp.validatedStudentName = quizApp.validatedStudentName;
            vocabQuizApp.validatedStudentCode = quizApp.validatedStudentCode;
            
            // Mostra o card e inicia o quiz de vocabul√°rio
            showCard('vocab-quiz-card', element);
            vocabQuizApp.startQuiz(false); // 'false' para sempre reiniciar
        }

        // --- L√ìGICA PRINCIPAL DO QUIZ DE GRAM√ÅTICA ---
        const quizApp = {
            APP_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwtDAlCCBcc3cN3pHX5YTkCZBsYTH--UJbeaczv64av_vIkybVIaEs-nTLKM2ssHND2/exec',
            currentQuestionIndex: 0,
            score: 0,
            userAnswers: {},
            validatedStudentName: '',
            validatedStudentCode: '',
            totalAttempts: "Ilimitadas",
            skippedQuestions: [],
            currentSkippedIndex: 0,
            shuffledQuestions: [],
            hintLevel: 0, 
            
            elements: {
                studentCodeInput: document.getElementById('student-code'),
                introCard: document.getElementById('intro-card'),
                quizCard: document.getElementById('question-card'),
                resultsCard: document.getElementById('results-card'),
                questionText: document.getElementById('question-text'),
                optionsList: document.getElementById('options-list'),
                justificationContainer: document.getElementById('justification-container'),
                nextButton: document.getElementById('next-button'),
                skipButton: document.getElementById('skip-button'),
                hintButton: document.getElementById('hint-button'),
                hintText: document.getElementById('hint-text'),
                attemptsLeftSpan: document.getElementById('attempts-left'),
                currentQuestionNumSpan: document.getElementById('current-question-num'),
                scoreDisplay: document.getElementById('score-display'),
                percentageDisplay: document.getElementById('percentage-display'),
                classificationDisplay: document.getElementById('classification-display'),
                reportStudentName: document.getElementById('report-student-name'),
                reportStudentCode: document.getElementById('report-student-code'),
                sendReportLink: document.getElementById('send-report-link'),
                introAttemptsLeftSpan: document.getElementById('intro-attempts-left'),
                fullReportContainer: document.getElementById('full-report-container'),
                shareWhatsappLink: document.getElementById('share-whatsapp'),
                personalizedWelcome: document.getElementById('personalized-welcome'),
                startActionsDiv: document.getElementById('start-actions'),
                quizDescription: document.getElementById('quiz-description'),
                summaryButton: document.getElementById('summary-button'),
                summaryText: document.getElementById('summary-text'),
                performanceButton: document.getElementById('performance-btn'),
                performanceDisplay: document.getElementById('performance-display'),
                progressBar: document.getElementById('progress-bar'),
                translateButton: document.getElementById('translate-button'),
                translationDisplay: document.getElementById('translation-display'),
                personalReportContainer: document.getElementById('personal-report-container'),
                audioContainer: document.getElementById('audio-container'),
                audioPlayContainer: document.getElementById('audio-play-container') 
            },

            studentData: {
"124AS": "ANA JULIA BERTO SOARES",
"258CA": "CAROLINA BEZERRA AGUIAR",
"391DS": "DAVI GON√áALVES CAVALCANTE DOS SANTOS",
"462DR": "DAVI RIBEIRO RODRIGUES",
"515DM": "DAVI SAMUEL DE LIMA MARCIANO",
"633FF": "FELIPE OLIVEIRA FREITAS",
"749HD": "HENRIQUE PEREIRA DURAES",
"851LC": "LUIS FELIPE GOMES DA COSTA",
"927MS": "MARCOS DA SILVA GOMES SANTOS",
"184MS": "MARIANNA MARTINS DA SILVA",
"276MC": "MELISSA ALVES GUEDES CORREIA",
"305VM": "VIT√ìRIA DA SILVA MARTINHO",
"419WA": "WANIELY KETILLY DE LIMA SILVA ALMEIDA", 
"JR123": "J√öNIOR"
            },
            
            summaries: { 
                "Quantifiers": "Usamos 'Some' em frases afirmativas (cont√°veis plurais e incont√°veis) e em ofertas/pedidos. Usamos 'Any' em frases negativas e na maioria das interrogativas. 'A lot of' √© usado para grande quantidade de ambos os tipos de substantivos.",
                "Countable/Uncountable": "Substantivos Cont√°veis (bottles, eggs, apples) podem ser contados e t√™m plural. Substantivos Incont√°veis (milk, sugar, water) n√£o podem ser contados individualmente e usam 'is' no singular.",
                "There is/are": "Usamos 'There is' para singular/incont√°vel e 'There are' para plural. 'Is there...?' e 'Are there...?' s√£o as formas interrogativas. 'There isn't...' e 'There aren't...' s√£o as negativas.",
                "How Much/Many": "'How much' √© usado para perguntar a quantidade de substantivos Incont√°veis (ex: How much flour?). 'How many' √© para substantivos Cont√°veis no plural (ex: How many eggs?).",
                "Directions": "Dire√ß√µes Cardeais (N, E, W, S) e Intercardinais (NE, SE, SW, NW). O Sol nasce em East (Leste) e se p√µe em West (Oeste). Fusos hor√°rios: 'ahead' (√† frente) e 'behind' (atr√°s)." ,
                "Containers": "Palavras usadas para contar incont√°veis: A loaf of bread (p√£o), A bar of chocolate (barra), A tin of tuna (lata), A packet of crisps (pacote), A lump of sugar (torr√£o)."
            },

            questions: [
                // --- 10 Quest√µes de M√∫ltipla Escolha (MCQ) - Quantifiers (Some/Any) ---
                { 
                  type: 'mcq', 
                  question: '1. Marque a frase que usa "some" corretamente:', 
                  topic: "Quantifiers", 
                  hint: "DICA 1: 'Some' √© usado em frases afirmativas, com substantivos cont√°veis no plural ou incont√°veis.", 
                  hint_2: "DICA 2: Evite usar 'some' em perguntas, exceto para ofertas ou pedidos.", 
                  options: [ 
                    { "text": "Do you have some sugar?", "isCorrect": false, "rationale": "Incorreto. Em perguntas (n√£o-ofertas), o correto √© 'any'." }, 
                    { "text": "I need some butter.", "isCorrect": true, "rationale": "Correto. 'Some' √© usado em senten√ßas afirmativas com substantivos incont√°veis (butter)." }, 
                    { "text": "There isn't some milk in the carton.", "isCorrect": false, "rationale": "Incorreto. Em senten√ßas negativas, o correto √© 'any'." }, 
                    { "text": "She bought some apple.", "isCorrect": false, "rationale": "Incorreto. 'Apple' √© cont√°vel singular; o correto seria 'an apple'." } 
                  ] 
                },
                { 
                  type: 'mcq', 
                  question: '2. Qual quantificador completa a frase: "I don\'t have ______ tomatoes."', 
                  topic: "Quantifiers", 
                  hint: "DICA 1: A frase √© negativa.", 
                  hint_2: "DICA 2: O quantificador para negativas e interrogativas (em geral).", 
                  options: [ 
                    { "text": "some", "isCorrect": false, "rationale": "Incorreto. 'Some' n√£o √© usado em frases negativas." }, 
                    { "text": "much", "isCorrect": false, "rationale": "Incorreto. 'Much' geralmente √© usado para incont√°veis, n√£o para negar cont√°veis." }, 
                    { "text": "any", "isCorrect": true, "rationale": "Correto. 'Any' √© usado em senten√ßas negativas, com substantivos cont√°veis no plural." }, 
                    { "text": "a lot", "isCorrect": false, "rationale": "Incorreto. 'A lot' n√£o √© usado ap√≥s 'don\'t have' dessa forma." } 
                  ] 
                },
                { 
                  type: 'mcq', 
                  question: '3. Qual frase utiliza "any" corretamente?', 
                  topic: "Quantifiers", 
                  hint: "DICA 1: Pense nas regras de frases interrogativas e negativas.", 
                  hint_2: "DICA 2: O quantificador deve vir antes de um substantivo.", 
                  options: [ 
                    { "text": "She wants any coffee.", "isCorrect": false, "rationale": "Incorreto. A frase √© afirmativa; o correto seria 'some'." }, 
                    { "text": "Are there any bananas?", "isCorrect": true, "rationale": "Correto. 'Any' √© usado em perguntas (interrogativas)." }, 
                    { "text": "I didn't drink any.", "isCorrect": false, "rationale": "Incorreto. 'Any' deve ser seguido de um substantivo no plural ou incont√°vel." }, 
                    { "text": "We bought any rice.", "isCorrect": false, "rationale": "Incorreto. A frase √© afirmativa; o correto seria 'some'." } 
                  ] 
                },
                { 
                  type: 'mcq', 
                  question: '4. Qual substantivo incont√°vel (Uncountable) deve ser usado com "some"?', 
                  topic: "Countable/Uncountable", 
                  hint: "DICA 1: Procure o item que n√£o pode ser contado individualmente.", 
                  hint_2: "DICA 2: S√£o l√≠quidos ou alimentos em massa.", 
                  options: [ 
                    { "text": "Onions", "isCorrect": false, "rationale": "Incorreto. Onions (cebolas) s√£o cont√°veis." }, 
                    { "text": "Water", "isCorrect": true, "rationale": "Correto. Water (√°gua) √© incont√°vel." }, 
                    { "text": "Sandwiches", "isCorrect": false, "rationale": "Incorreto. Sandwiches (sandu√≠ches) s√£o cont√°veis." }, 
                    { "text": "Pears", "isCorrect": false, "rationale": "Incorreto. Pears (peras) s√£o cont√°veis." } 
                  ] 
                },
                { 
                  type: 'mcq', 
                  question: '5. A palavra "sugar" √© incont√°vel. Como voc√™ se referiria a uma quantidade n√£o espec√≠fica em uma pergunta?', 
                  topic: "Quantifiers", 
                  hint: "DICA 1: Regra geral para perguntas (interrogativas).", 
                  hint_2: "DICA 2: Come√ßa com A.", 
                  options: [ 
                    { "text": "many sugar", "isCorrect": false, "rationale": "Incorreto. 'Many' √© para cont√°veis." }, 
                    { "text": "some sugar", "isCorrect": false, "rationale": "Incorreto. 'Some' n√£o √© usado em perguntas (exceto ofertas)." }, 
                    { "text": "any sugar", "isCorrect": true, "rationale": "Correto. 'Any' √© usado em perguntas com substantivos incont√°veis." }, 
                    { "text": "a sugar", "isCorrect": false, "rationale": "Incorreto. 'A/An' n√£o √© usado com substantivos incont√°veis." } 
                  ] 
                },
                { 
                  type: 'mcq', 
                  question: '6. Se voc√™ estiver oferecendo caf√©, qual √© o uso mais comum de "some" em uma pergunta?', 
                  topic: "Quantifiers", 
                  hint: "DICA 1: Exce√ß√£o da regra de 'some' em perguntas.", 
                  hint_2: "DICA 2: 'Would you like...'", 
                  options: [ 
                    { "text": "Do you want some coffee?", "isCorrect": true, "rationale": "Correto. 'Some' √© permitido em perguntas quando se faz uma oferta." }, 
                    { "text": "Do you want any coffee?", "isCorrect": false, "rationale": "Incorreto. Embora correto gramaticalmente, 'some' √© preferido em ofertas." }, 
                    { "text": "How many coffee do you want?", "isCorrect": false, "rationale": "Incorreto. 'Coffee' √© incont√°vel, usa-se 'How much'." }, 
                    { "text": "I want some coffee?", "isCorrect": false, "rationale": "Incorreto. Esta n√£o √© uma pergunta de oferta t√≠pica." } 
                  ] 
                },
                { 
                  type: 'mcq', 
                  question: '7. Qual a forma correta de perguntar sobre a exist√™ncia de batatas no plural?', 
                  topic: "There is/are", 
                  hint: "DICA 1: Batatas s√£o cont√°veis no plural. O verbo deve concordar.", 
                  hint_2: "DICA 2: Use 'any' em perguntas.", 
                  options: [ 
                    { "text": "Is there any potatoes?", "isCorrect": false, "rationale": "Incorreto. O verbo deve ser 'are' para o plural 'potatoes'." }, 
                    { "text": "Are there some potato?", "isCorrect": false, "rationale": "Incorreto. 'Potato' est√° no singular e 'some' n√£o √© usualmente usado em perguntas." }, 
                    { "text": "Are there any potatoes?", "isCorrect": true, "rationale": "Correto. 'Are there' e 'any' s√£o usados para perguntar sobre a exist√™ncia de cont√°veis no plural." }, 
                    { "text": "There are some potatoes?", "isCorrect": false, "rationale": "Incorreto. Est√° incorreta a estrutura de pergunta." } 
                  ] 
                },
                { 
                  type: 'mcq', 
                  question: '8. O "East direction" (Leste) est√° relacionado a qual evento do dia?', 
                  topic: "Directions", 
                  hint: "DICA 1: Posi√ß√£o do sol.", 
                  hint_2: "DICA 2: O sol n_____.", 
                  options: [ 
                    { "text": "Sunset (P√¥r do Sol)", "isCorrect": false, "rationale": "Incorreto. Sunset √© na dire√ß√£o Oeste (West)." }, 
                    { "text": "Moonrise (Nascer da Lua)", "isCorrect": false, "rationale": "Incorreto. Moonrise n√£o √© a resposta esperada." }, 
                    { "text": "Noon (Meio-dia)", "isCorrect": false, "rationale": "Incorreto. Noon √© o ponto mais alto do dia." }, 
                    { "text": "Sunrise (Nascer do Sol)", "isCorrect": true, "rationale": "Correto. Sunrise √© na dire√ß√£o East." } 
                  ] 
                },
                { 
                  type: 'mcq', 
                  question: '9. Se √© "midday" em Londres (0), que diferen√ßa de fuso hor√°rio existe em Seoul (+9)?', 
                  topic: "Time Zones", 
                  hint: "DICA 1: Seoul est√° √† frente (ahead).", 
                  hint_2: "DICA 2: √â s√≥ somar o n√∫mero de fusos.", 
                  options: [ 
                    { "text": "Seoul est√° 9 horas 'behind' (atr√°s) de Londres.", "isCorrect": false, "rationale": "Incorreto. Seoul est√° √† frente, n√£o atr√°s." }, 
                    { "text": "Seoul est√° 9 horas 'ahead' (√† frente) de Londres.", "isCorrect": true, "rationale": "Correto. O fuso +9 indica 9 horas √† frente." }, 
                    { "text": "Seoul est√° 8 horas 'ahead' (√† frente) de Londres.", "isCorrect": false, "rationale": "Incorreto. A diferen√ßa √© de 9 fusos." }, 
                    { "text": "Seoul est√° 12 horas 'behind' (atr√°s) de Londres.", "isCorrect": false, "rationale": "Incorreto. 12 horas atr√°s √© Honolulu (-11) ou perto do fuso -12." } 
                  ] 
                },
                { 
                  type: 'mcq', 
                  question: '10. Qual quantificador deve ser usado com \'milk\' (substantivo incont√°vel)?', 
                  topic: "Quantifiers", 
                  hint: "DICA 1: Se √© incont√°vel, n√£o pode ser 'many'.", 
                  hint_2: "DICA 2: Come√ßa com M.", 
                  options: [ 
                    { "text": "How many", "isCorrect": false, "rationale": "Incorreto. 'How many' √© para substantivos cont√°veis." }, 
                    { "text": "A milk", "isCorrect": false, "rationale": "Incorreto. 'A/An' n√£o √© usado para incont√°veis (apenas se usar um container, como 'a cup of milk')." }, 
                    { "text": "How much", "isCorrect": true, "rationale": "Correto. 'How much' √© usado para perguntar sobre a quantidade de substantivos incont√°veis." }, 
                    { "text": "Two milks", "isCorrect": false, "rationale": "Incorreto. A menos que se refira a tipos de leite, 'milk' √© incont√°vel." } 
                  ] 
                },
                
                // --- 5 Quest√µes de √Åudio (Audio_MCQ) - Usando as Frases do Bloco 1 ---
                { 
                  type: 'audio_mcq', 
                  audioSrc: 'https://files.catbox.moe/0yopsf.mp3', 
                  question: '11. Ou√ßa a pergunta e escolha a melhor resposta: (Frase: Is there any butter left in the fridge?)',
                  hint: "DICA 1: 'Butter' √© incont√°vel. Use 'Yes, there is...' ou 'No, there isn\'t...'.",
                  hint_2: "DICA 2: O quantificador para respostas afirmativas (curtas) √© 'some'.",
                  topic: "Quantifiers", 
                  options: [ 
                    { "text": "Yes, there are some butter.", "isCorrect": false, "rationale": "Incorreto. O verbo 'are' n√£o concorda com o incont√°vel 'butter'." }, 
                    { "text": "No, there isn't any butter.", "isCorrect": true, "rationale": "Correto. Usa 'isn\'t' (singular) e 'any' (negativa) para o incont√°vel 'butter'." }, 
                    { "text": "Yes, there is many butter.", "isCorrect": false, "rationale": "Incorreto. 'Many' √© para cont√°veis." }, 
                    { "text": "No, there aren't some butter.", "isCorrect": false, "rationale": "Incorreto. 'Aren\'t' e 'some' est√£o incorretos para esta situa√ß√£o." } 
                  ] 
                },
                { 
                  type: 'audio_mcq', 
                  audioSrc: 'https://files.catbox.moe/w3bktj.mp3', 
                  question: '12. Ou√ßa a pergunta e escolha a resposta que usa o quantificador correto: (Frase: How many eggs are there in the cake?)',
                  hint: "DICA 1: 'Eggs' s√£o cont√°veis. O quantificador deve ser 'many'.",
                  hint_2: "DICA 2: Use o plural 'are' na resposta.",
                  topic: "How Much/Many", 
                  options: [ 
                    { "text": "There is much egg.", "isCorrect": false, "rationale": "Incorreto. 'Much' e 'egg' (singular) est√£o incorretos para a pergunta." }, 
                    { "text": "There are some eggs.", "isCorrect": true, "rationale": "Correto. Usa 'are' (plural) e 'some' (afirmativa) para o cont√°vel 'eggs'." }, 
                    { "text": "There are any eggs.", "isCorrect": false, "rationale": "Incorreto. 'Any' n√£o √© usado em frases afirmativas (exceto com o sentido de 'qualquer')." }, 
                    { "text": "We have much eggs.", "isCorrect": false, "rationale": "Incorreto. 'Much' √© para incont√°veis." } 
                  ] 
                },
                { 
                  type: 'audio_mcq', 
                  audioSrc: 'https://files.catbox.moe/u0z5se.mp3', 
                  question: '13. Ou√ßa a frase. A palavra "milk" √© um substantivo: (Frase: We need some milk for the recipe.)',
                  hint: "DICA 1: Voc√™ conta 'copos de leite', n√£o 'leites'.",
                  hint_2: "DICA 2: √â um l√≠quido.",
                  topic: "Countable/Uncountable", 
                  options: [ 
                    { "text": "Cont√°vel (Countable)", "isCorrect": false, "rationale": "Incorreto. 'Milk' √© um l√≠quido, e l√≠quidos s√£o incont√°veis." }, 
                    { "text": "Incont√°vel (Uncountable)", "isCorrect": true, "rationale": "Correto. 'Milk' √© um substantivo incont√°vel, a menos que se refira a tipos ou embalagens." }, 
                    { "text": "Coletivo (Collective Noun)", "isCorrect": false, "rationale": "Incorreto. 'Milk' n√£o √© um coletivo." }, 
                    { "text": "Pr√≥prio (Proper Noun)", "isCorrect": false, "rationale": "Incorreto. N√£o √© um nome pr√≥prio." } 
                  ] 
                },
                { 
                  type: 'audio_mcq', 
                  audioSrc: 'https://files.catbox.moe/t7xzs5.mp3', 
                  question: '14. Ou√ßa a frase. O que a palavra "lot" indica? (Frase: There are a lot of plates on the table.)',
                  hint: "DICA 1: A frase significa que h√° uma grande quantidade.",
                  hint_2: "DICA 2: √â um quantificador de grande quantidade.",
                  topic: "Quantifiers", 
                  options: [ 
                    { "text": "Uma pequena quantidade de incont√°veis.", "isCorrect": false, "rationale": "Incorreto. 'A lot of' indica grande quantidade e pode ser usado para cont√°veis e incont√°veis." }, 
                    { "text": "Uma grande quantidade de cont√°veis ou incont√°veis.", "isCorrect": true, "rationale": "Correto. 'A lot of' √© usado para grande quantidade de ambos os tipos de substantivos." }, 
                    { "text": "Uma quantidade indefinida em perguntas.", "isCorrect": false, "rationale": "Incorreto. √â usado em afirmativas." }, 
                    { "text": "Uma quantidade zero em negativas.", "isCorrect": false, "rationale": "Incorreto. √â um quantificador de grande volume." } 
                  ] 
                },
                { 
                  type: 'audio_mcq', 
                  audioSrc: 'https://files.catbox.moe/xy2wf4.mp3', 
                  question: '15. Ou√ßa a pergunta e escolha o tipo de substantivo do termo \'flour\': (Frase: How much flour do we have?)',
                  hint: "DICA 1: Voc√™ conta 'sacos de farinha', n√£o 'farinhas'.",
                  hint_2: "DICA 2: √â um p√≥, e p√≥s s√£o incont√°veis.",
                  topic: "Countable/Uncountable", 
                  options: [ 
                    { "text": "Cont√°vel (Countable)", "isCorrect": false, "rationale": "Incorreto. 'Flour' (farinha) √© um ingrediente em p√≥, sendo incont√°vel." }, 
                    { "text": "Incont√°vel (Uncountable)", "isCorrect": true, "rationale": "Correto. Farinha √© um substantivo incont√°vel (Uncountable Noun)." }, 
                    { "text": "Irregular", "isCorrect": false, "rationale": "Incorreto. N√£o √© irregular, √© uma quest√£o de contagem." }, 
                    { "text": "Cont√°vel Plural", "isCorrect": false, "rationale": "Incorreto. √â incont√°vel." } 
                  ] 
                },
                
                // --- 10 Quest√µes de Preenchimento de Lacunas (Fill-in) - How Much/Many e There is/are ---
                { 
                  type: 'fill-in', 
                  question: '16. (Quantificador) ______ money do you have in your wallet? (Dinheiro √© incont√°vel)', 
                  topic: "How Much/Many", 
                  hint: "DICA 1: 'Money' √© incont√°vel.", 
                  hint_2: "DICA 2: Pergunta sobre quantidade de incont√°vel.", 
                  answer: ["HOW MUCH"], 
                  rationale: "Correto. 'How much' √© usado para substantivos incont√°veis como 'money'." 
                },
                { 
                  type: 'fill-in', 
                  question: '17. (Exist√™ncia) ______ a jug in the fridge.', 
                  topic: "There is/are", 
                  hint: "DICA 1: 'A jug' √© singular. Use 'There is...'.", 
                  hint_2: "DICA 2: A forma afirmativa para o singular √© essa.", 
                  answer: ["THERE IS"], 
                  rationale: "Correto. 'There is' √© a forma singular afirmativa." 
                },
                { 
                  type: 'fill-in', 
                  question: '18. (Quantificador) ______ eggs are there in the basket?', 
                  topic: "How Much/Many", 
                  hint: "DICA 1: 'Eggs' s√£o cont√°veis no plural.", 
                  hint_2: "DICA 2: Pergunta sobre quantidade de cont√°vel no plural.", 
                  answer: ["HOW MANY"], 
                  rationale: "Correto. 'How many' √© usado para substantivos cont√°veis no plural." 
                },
                { 
                  type: 'fill-in', 
                  question: '19. (Exist√™ncia Negativa) There ______ ten bottles in the fridge. There are twelve.', 
                  topic: "There is/are", 
                  hint: "DICA 1: 'Ten bottles' √© plural. A frase √© negativa.", 
                  hint_2: "DICA 2: A forma negativa para o plural √© 'There aren't...'.", 
                  answer: ["AREN'T"], 
                  rationale: "Correto. A forma contra√≠da e plural de 'There are not'." 
                },
                { 
                  type: 'fill-in', 
                  question: '20. (Quantificador) ______ rice is left in the bowl? (Arroz √© incont√°vel)', 
                  topic: "How Much/Many", 
                  hint: "DICA 1: 'Rice' √© incont√°vel.", 
                  hint_2: "DICA 2: Pergunta sobre quantidade de incont√°vel.", 
                  answer: ["HOW MUCH"], 
                  rationale: "Correto. 'How much' √© usado para incont√°veis." 
                },
                { 
                  type: 'fill-in', 
                  question: '21. (Exist√™ncia) ______ some sugar on the table.', 
                  topic: "There is/are", 
                  hint: "DICA 1: 'Sugar' √© incont√°vel, portanto, singular.", 
                  hint_2: "DICA 2: A forma afirmativa para o singular √© essa.", 
                  answer: ["THERE IS"], 
                  rationale: "Correto. 'There is' √© usado com substantivos incont√°veis ('sugar')." 
                },
                { 
                  type: 'fill-in', 
                  question: '22. (Quantificador) ______ time is it in London? (Tempo √© incont√°vel)', 
                  topic: "How Much/Many", 
                  hint: "DICA 1: 'Time' (tempo, hora) √© incont√°vel neste contexto.", 
                  hint_2: "DICA 2: Pergunta sobre quantidade de incont√°vel.", 
                  answer: ["HOW MUCH"], 
                  rationale: "Correto. 'How much' √© usado para incont√°veis." 
                },
                { 
                  type: 'fill-in', 
                  question: '23. (Exist√™ncia Pergunta) Is ______ any yogurt in the fridge?', 
                  topic: "There is/are", 
                  hint: "DICA 1: Pergunta no singular. O sujeito vem depois do verbo.", 
                  hint_2: "DICA 2: A invers√£o do afirmativo singular.", 
                  answer: ["THERE"], 
                  rationale: "Correto. A estrutura √© 'Is there any...' para perguntas no singular." 
                },
                { 
                  type: 'fill-in', 
                  question: '24. (Quantificador) ______ cups of coffee do you drink every day?', 
                  topic: "How Much/Many", 
                  hint: "DICA 1: 'Cups' s√£o cont√°veis no plural.", 
                  hint_2: "DICA 2: Pergunta sobre quantidade de cont√°vel no plural.", 
                  answer: ["HOW MANY"], 
                  rationale: "Correto. 'How many' √© usado para cont√°veis no plural." 
                },
                { 
                  type: 'fill-in', 
                  question: '25. (Exist√™ncia Negativa) There isn\'t ______ peach jam in the jar.', 
                  topic: "Quantifiers", 
                  hint: "DICA 1: A frase √© negativa. Use o quantificador para negativas.", 
                  hint_2: "DICA 2: Come√ßa com A.", 
                  answer: ["ANY"], 
                  rationale: "Correto. 'Any' √© o quantificador usado em frases negativas." 
                },
                
                // --- 5 Quest√µes de Verdadeiro/Falso (T/F) - Countable/Uncountable/Directions ---
                { 
                  type: 'tf', 
                  question: '26. A abreviatura NE significa "Northeast".', 
                  topic: "Directions", 
                  hint: "DICA 1: √â uma dire√ß√£o intercardinal.", 
                  options: [ 
                    { "text": "Verdadeiro", "isCorrect": true, "rationale": "Correto. NE √© a abreviatura para Nordeste (Northeast)." }, 
                    { "text": "Falso", "isCorrect": false, "rationale": "Incorreto." } 
                  ],
                  answer: true 
                },
                { 
                  type: 'tf', 
                  question: '27. O plural de "apple" √© "some apples".', 
                  topic: "Countable/Uncountable", 
                  hint: "DICA 1: Pense se 'apple' √© cont√°vel ou incont√°vel.", 
                  options: [ 
                    { "text": "Verdadeiro", "isCorrect": true, "rationale": "Correto. Embora 'apples' seja o plural, 'some apples' √© a forma correta de se referir a uma quantidade n√£o espec√≠fica de cont√°veis no plural." }, 
                    { "text": "Falso", "isCorrect": false, "rationale": "Incorreto." } 
                  ],
                  answer: true 
                },
                { 
                  type: 'tf', 
                  question: '28. A palavra "bread" (p√£o) √© sempre considerada cont√°vel em Ingl√™s.', 
                  topic: "Countable/Uncountable", 
                  hint: "DICA 1: Geralmente, √© necess√°rio usar 'a loaf of bread' ou 'a slice of bread'.", 
                  options: [ 
                    { "text": "Verdadeiro", "isCorrect": false, "rationale": "Falso. 'Bread' √© geralmente incont√°vel (uncountable) em ingl√™s; o correto seria 'a slice of bread'." }, 
                    { "text": "Falso", "isCorrect": true, "rationale": "Correto." } 
                  ],
                  answer: false 
                },
                { 
                  type: 'tf', 
                  question: '29. "North", "East", "West" e "South" s√£o dire√ß√µes intercardinais.', 
                  topic: "Directions", 
                  hint: "DICA 1: S√£o as dire√ß√µes principais (cardinais).", 
                  options: [ 
                    { "text": "Verdadeiro", "isCorrect": false, "rationale": "Falso. S√£o as dire√ß√µes Cardinais; as Intercardinais s√£o NE, SE, SW, NW." }, 
                    { "text": "Falso", "isCorrect": true, "rationale": "Correto." } 
                  ],
                  answer: false 
                },
                { 
                  type: 'tf', 
                  question: '30. A frase "I have got a lot of water" indica que a pessoa tem pouca √°gua.', 
                  topic: "Quantifiers", 
                  hint: "DICA 1: 'A lot of' significa o oposto de 'pouco'.", 
                  options: [ 
                    { "text": "Verdadeiro", "isCorrect": false, "rationale": "Falso. 'A lot of' significa 'muita' ou 'grande quantidade'." }, 
                    { "text": "Falso", "isCorrect": true, "rationale": "Correto." } 
                  ],
                  answer: false 
                },
                
                // --- 10 Quest√µes de Arrastar e Soltar (Drag-drop) - Containers/Quantities/Directions ---
                { 
                  type: 'drag-drop', 
                  question: '31. (Recipiente) Uma ______ de p√£o. (LOAF/SLICE/BAR)', 
                  topic: "Containers", 
                  hint: "DICA 1: O p√£o inteiro, n√£o uma fatia.", 
                  options: ["LOAF", "SLICE", "BAR"], 
                  answer: "LOAF", 
                  rationale: "Correto. 'A loaf of bread' significa um p√£o inteiro ou um 'cacetinho'." 
                },
                { 
                  type: 'drag-drop', 
                  question: '32. (Medida) Um ______ de a√ß√∫car. (TIN/LUMP/BOWL)', 
                  topic: "Containers", 
                  hint: "DICA 1: Refere-se a um torr√£o ou peda√ßo.", 
                  options: ["LUMP", "TIN", "BOWL"], 
                  answer: "LUMP", 
                  rationale: "Correto. 'Lump of sugar' significa torr√£o de a√ß√∫car." 
                },
                { 
                  type: 'drag-drop', 
                  question: '33. (Recipiente) Um ______ de atum. (PACKET/CAN/BOTTLE)', 
                  topic: "Containers", 
                  hint: "DICA 1: Atum √© vendido em lata.", 
                  options: ["TIN", "PACKET", "BOTTLE"], 
                  answer: "TIN", 
                  rationale: "Correto. 'A tin of tuna' significa uma lata de atum (tamb√©m pode ser 'can')." 
                },
                { 
                  type: 'drag-drop', 
                  question: '34. (Dire√ß√£o) O oposto de NORTH √© ______.', 
                  topic: "Directions", 
                  hint: "DICA 1: Ponto cardeal oposto.", 
                  options: ["SOUTH", "EAST", "WEST"], 
                  answer: "SOUTH", 
                  rationale: "Correto. North (Norte) √© oposto a South (Sul)." 
                },
                { 
                  type: 'drag-drop', 
                  question: '35. (Recipiente) Um ______ de batatas fritas (crisps). (BAR/PACKET/BUNCH)', 
                  topic: "Containers", 
                  hint: "DICA 1: Geralmente √© um pacote pequeno.", 
                  options: ["PACKET", "BAR", "BUNCH"], 
                  answer: "PACKET", 
                  rationale: "Correto. 'A packet of crisps' significa um pacote de batatas fritas." 
                },
                { 
                  type: 'drag-drop', 
                  question: '36. (Recipiente) Um ______ de uvas. (BAR/LOAF/BUNCH)', 
                  topic: "Containers", 
                  hint: "DICA 1: Coletivo para frutas agrupadas.", 
                  options: ["BUNCH", "LOAF", "BAR"], 
                  answer: "BUNCH", 
                  rationale: "Correto. 'A bunch of grapes' significa um cacho de uvas." 
                },
                { 
                  type: 'drag-drop', 
                  question: '37. (Dire√ß√£o) A abreviatura para "Southeast" √© ______.', 
                  topic: "Directions", 
                  hint: "DICA 1: S de South e E de East.", 
                  options: ["SW", "NW", "SE"], 
                  answer: "SE", 
                  rationale: "Correto. SE √© a abreviatura para Sudeste (Southeast)." 
                },
                { 
                  type: 'drag-drop', 
                  question: '38. (Recipiente) Um ______ de chocolate. (PACKET/CUP/BAR)', 
                  topic: "Containers", 
                  hint: "DICA 1: Geralmente √© uma 'barra'.", 
                  options: ["BAR", "CUP", "PACKET"], 
                  answer: "BAR", 
                  rationale: "Correto. 'A bar of chocolate' significa uma barra de chocolate." 
                },
                { 
                  type: 'drag-drop', 
                  question: '39. (Medida) Um ______ de pizza. (BOWL/SLICE/JUG)', 
                  topic: "Containers", 
                  hint: "DICA 1: √â uma por√ß√£o cortada.", 
                  options: ["SLICE", "BOWL", "JUG"], 
                  answer: "SLICE", 
                  rationale: "Correto. 'A slice of pizza' significa uma fatia de pizza." 
                },
                { 
                  type: 'drag-drop', 
                  question: '40. (Dire√ß√£o) A dire√ß√£o onde o sol se p√µe √© ______.', 
                  topic: "Directions", 
                  hint: "DICA 1: P√¥r do Sol (Sunset).", 
                  options: ["EAST", "WEST", "NORTH"], 
                  answer: "WEST", 
                  rationale: "Correto. O sol se p√µe na dire√ß√£o West (Oeste)." 
                }
            ],


            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            balanceCorrectAnswers() {
                const mcqQuestions = this.questions.filter(q => q.type === 'mcq' && q.options && q.options.length === 4);
                if (mcqQuestions.length === 0) return;
                
                const numPositions = 4;
                let desiredPositions = [];
                for (let i = 0; i < mcqQuestions.length; i++) {
                    desiredPositions.push(i % numPositions);
                }
                this.shuffleArray(desiredPositions);
                
                let mcqCounter = 0;
                this.questions.forEach((q) => {
                    if (q.type === 'mcq' && q.options && q.options.length === 4) {
                        this.shuffleArray(q.options);
                        const correctOption = q.options.find(opt => opt.isCorrect);
                        if (!correctOption) return;
                        const targetIndex = desiredPositions[mcqCounter];
                        if (q.options.indexOf(correctOption) !== targetIndex) {
                            const currentIndex = q.options.indexOf(correctOption);
                            [q.options[currentIndex], q.options[targetIndex]] = [q.options[targetIndex], q.options[currentIndex]];
                        }
                        mcqCounter++;
                    }
                });
            },
            
            updateProgressBar() {
                const totalQuestions = this.questions.length;
                const answeredCount = (this.currentQuestionIndex - this.skippedQuestions.length) + this.currentSkippedIndex;
                const percentage = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;
                this.elements.progressBar.style.width = percentage + '%';
                this.elements.progressBar.textContent = percentage + '%';
            },

            startQuiz(continueFromSavedState) {
                const studentCode = this.elements.studentCodeInput.value.trim().toUpperCase();
                const correctName = this.studentData[studentCode];
                if (!correctName) {
                    alert("C√≥digo de acesso inv√°lido.");
                    return;
                }
                this.validatedStudentCode = studentCode;
                this.validatedStudentName = correctName;
                
                if (this.validatedStudentCode === 'JR123') {
                    setupAdminViewRoteiro(true);
                    setupAdminViewApostila(true);
                } else {
                    setupAdminViewRoteiro(false);
                    setupAdminViewApostila(false);
                }
                
                if (continueFromSavedState) { 
                    this.loadQuizState(this.validatedStudentCode); 
                } 
                else {
                    this.currentQuestionIndex = 0;
                    this.score = 0;
                    this.userAnswers = {};
                    this.skippedQuestions = [];
                    this.currentSkippedIndex = 0;
		            this.balanceCorrectAnswers();
                    localStorage.removeItem(`quizState_${this.validatedStudentCode}`); 
                    this.shuffledQuestions = this.shuffleArray([...this.questions]);
                }
                
                showCard('question-card', document.querySelector("button[onclick*='question-card']"));
                this.displayQuestion();
            },

            displayQuestion() {
                this.updateProgressBar();
                this.elements.performanceDisplay.style.display = 'none';
                this.elements.justificationContainer.innerHTML = '';
                this.elements.hintText.style.display = 'none';
                this.elements.summaryText.style.display = 'none';
                this.elements.summaryButton.style.display = 'none';
                this.elements.nextButton.style.display = 'none';

                this.elements.translationDisplay.style.display = 'none'; 
                this.elements.translateButton.style.display = 'inline-block'; 
                this.elements.translateButton.disabled = false;
                this.elements.translateButton.textContent = 'üåê'; 
                
                this.elements.audioContainer.innerHTML = ''; 
                this.elements.audioPlayContainer.innerHTML = ''; 
                this.elements.questionText.style.display = 'flex'; 

                this.hintLevel = 0; 
                this.elements.hintButton.textContent = 'Dica'; 
                this.elements.hintButton.style.background = ''; // Reseta o bot√£o para roxo
                this.elements.hintButton.disabled = false; 
                this.elements.hintButton.onclick = () => this.showHint(); 
                
                let questionToDisplay;
                let currentQuestionNumber;
                let totalAnswered = (this.currentQuestionIndex - this.skippedQuestions.length) + this.currentSkippedIndex;

                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0 && this.currentSkippedIndex < this.skippedQuestions.length) {
                    const skippedIndex = this.skippedQuestions[this.currentSkippedIndex];
                    questionToDisplay = this.questions[skippedIndex]; 
                    currentQuestionNumber = `(Pulada ${this.currentSkippedIndex + 1}/${this.skippedQuestions.length})`
                    this.elements.skipButton.style.display = 'none';
                } else if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    questionToDisplay = this.shuffledQuestions[this.currentQuestionIndex];
                    currentQuestionNumber = totalAnswered + 1;
                    this.elements.skipButton.style.display = 'inline-block';
                } else {
                    this.showResults();
                    return;
                }
                
                this.elements.currentQuestionNumSpan.textContent = currentQuestionNumber;
                
                this.elements.optionsList.innerHTML = '';

                switch (questionToDisplay.type) {
                    case 'fill-in': this.renderFillIn(questionToDisplay); break;
                    case 'drag-drop': this.renderDragDrop(questionToDisplay); break;
                    case 'tf': this.renderMCQ(questionToDisplay); break;
                    case 'audio_mcq': this.renderAudioMCQ(questionToDisplay); break; 
                    case 'mcq': default: this.renderMCQ(questionToDisplay); break;
                }
            },

            renderAudioMCQ(question) {
                this.elements.audioContainer.innerHTML = ''; 
                const audioEl = document.createElement('audio');
                audioEl.src = question.audioSrc;
                audioEl.preload = 'auto'; 
                this.elements.audioContainer.appendChild(audioEl);

                this.elements.audioPlayContainer.innerHTML = ''; 
                const playBtn = document.createElement('button');
                playBtn.className = 'btn audio-play-btn';
                playBtn.textContent = 'Ouvir Quest√£o üéß';
                playBtn.onclick = () => audioEl.play();
                this.elements.audioPlayContainer.appendChild(playBtn);
                
                this.elements.translateButton.style.display = 'none';

                this.renderMCQ(question);
            },

            renderMCQ(question) {
                this.elements.questionText.innerHTML = ''; 
                this.elements.questionText.textContent = question.question;
                
                // Se a quest√£o n√£o for de √°udio, mostre o bot√£o de traduzir
                if (question.type !== 'audio_mcq') {
                    this.elements.translateButton.style.display = 'inline-block';
                } else {
                    this.elements.translateButton.style.display = 'none';
                }

                question.options.forEach(option => {
                    const li = document.createElement('li');
                    li.className = 'option-item';
                    li.textContent = option.text;
                    li.onclick = () => this.selectOption(li, option);
                    this.elements.optionsList.appendChild(li);
                });
            },

            renderFillIn(question) {
                this.elements.questionText.innerHTML = ''; 
                this.elements.questionText.textContent = question.question;
                this.elements.translateButton.style.display = 'inline-block'; // Mostrar tradutor
                
                const input = document.createElement('input');
                input.id = 'fill-in-input';
                input.placeholder = 'Digite sua resposta...';
                const checkButton = document.createElement('button');
                checkButton.textContent = 'Verificar';
                checkButton.className = 'btn check-btn';
                checkButton.onclick = () => {
                    const userAnswer = input.value.trim().toLowerCase();
                    const isCorrect = question.answer.map(ans => ans.toLowerCase()).includes(userAnswer);
                    this.handleAnswer(isCorrect, question.rationale, input.value.trim(), question.answer[0]);
                    input.disabled = true;
                    checkButton.style.display = 'none';
                    input.classList.add(isCorrect ? 'correct' : 'incorrect');
                };
                this.elements.optionsList.appendChild(input);
                this.elements.optionsList.appendChild(checkButton);
            },

            renderDragDrop(question) {
                const dropZone = document.createElement('span');
                dropZone.id = 'drop-zone';
                dropZone.textContent = 'Arraste aqui';
                const questionTextHTML = question.question.replace('______', dropZone.outerHTML);
                this.elements.questionText.innerHTML = questionTextHTML; 
                this.elements.translateButton.style.display = 'inline-block'; // Mostrar tradutor
                
                const actualDropZone = this.elements.questionText.querySelector('#drop-zone');
                const dragOptionsWrapper = document.createElement('div');
                dragOptionsWrapper.className = 'drag-options-wrapper';
                this.shuffleArray(question.options).forEach(opt => {
                    const optionEl = document.createElement('span');
                    optionEl.textContent = opt;
                    optionEl.className = 'drag-option';
                    optionEl.draggable = true;
                    optionEl.dataset.value = opt;
                    optionEl.ondragstart = (e) => { e.dataTransfer.setData('text/plain', e.target.dataset.value); e.target.classList.add('dragging'); };
                    optionEl.ondragend = (e) => e.target.classList.remove('dragging');
                    dragOptionsWrapper.appendChild(optionEl);
                });
                this.elements.optionsList.appendChild(dragOptionsWrapper);
                actualDropZone.ondragover = (e) => { e.preventDefault(); actualDropZone.classList.add('over'); };
                actualDropZone.ondragleave = () => actualDropZone.classList.remove('over');
                actualDropZone.ondrop = (e) => {
                    e.preventDefault();
                    actualDropZone.classList.remove('over');
                    const droppedValue = e.dataTransfer.getData('text/plain');
                    const isCorrect = (droppedValue.toLowerCase() === question.answer.toLowerCase());
                    this.handleAnswer(isCorrect, question.rationale, droppedValue, question.answer);
                    actualDropZone.textContent = droppedValue;
                    actualDropZone.classList.add(isCorrect ? 'correct' : 'incorrect');
                    this.elements.optionsList.querySelectorAll('.drag-option').forEach(el => { el.draggable = false; el.style.cursor = 'not-allowed'; el.style.opacity = '0.6'; });
                };
            },

            selectOption(selectedElement, selectedOption) {
                this.elements.optionsList.querySelectorAll('.option-item').forEach(option => option.style.pointerEvents = 'none');
                const isCorrect = selectedOption.isCorrect;
                
                let currentQuestion;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }
                
                selectedElement.classList.add(isCorrect ? 'correct' : 'incorrect');
                this.handleAnswer(isCorrect, selectedOption.rationale, selectedOption.text, currentQuestion.options.find(o => o.isCorrect).text);

                if (!isCorrect) {
                    const correctText = currentQuestion.options.find(opt => opt.isCorrect).text;
                    const correctElement = Array.from(this.elements.optionsList.querySelectorAll('.option-item')).find(el => el.textContent === correctText);
                    if (correctElement) correctElement.classList.add('correct');
                }
            },

            handleAnswer(isCorrect, rationale, userAnswer, correctAnswer) {
                if (isCorrect) {
                    this.score++;
                    this.elements.summaryButton.style.display = 'none';
                } else {
                    this.elements.summaryButton.style.display = 'inline-block';
                }
                const justificationElement = document.createElement('div');
                justificationElement.className = 'justification';
                justificationElement.innerHTML = rationale; 
                justificationElement.style.borderLeftColor = isCorrect ? '#28a745' : '#dc3545';
                this.elements.justificationContainer.appendChild(justificationElement);
                
                let originalQuestionIndex;
                let currentQuestion;
                 if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
                    originalQuestionIndex = this.skippedQuestions[this.currentSkippedIndex];
                    currentQuestion = this.questions[originalQuestionIndex];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                    originalQuestionIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
                }
                
                this.userAnswers[originalQuestionIndex] = {
                    question: currentQuestion.question, 
                    userAnswer: userAnswer,
                    isCorrect: isCorrect,
                    correctAnswer: correctAnswer,
                    rationale: rationale,
                    type: currentQuestion.type || 'mcq',
                    topic: currentQuestion.topic || 'Geral' 
                };
                
                this.elements.nextButton.style.display = 'block';
                this.elements.skipButton.style.display = 'none';
                this.saveQuizState();
            },

            showPerformance() {
                const display = this.elements.performanceDisplay;
                if (display.style.display === 'block') {
                    display.style.display = 'none';
                } else {
                    const answeredCount = Object.keys(this.userAnswers).length;
                    const incorrectCount = answeredCount - this.score;
                    display.innerHTML = `<strong style="color: #333;">At√© agora:</strong> <span style="color: #28a745;">${this.score} acertos</span> <strong style="color: #333;">e</strong> <span style="color: #dc3545;">${incorrectCount} erros</span><strong style="color: #333;">!</strong>`;
                    display.style.display = 'block';
                    this.elements.hintText.style.display = 'none';
                    this.elements.summaryText.style.display = 'none';
                }
            },
            
            showHint() {
                const display = this.elements.hintText;
                const button = this.elements.hintButton; 
                let currentQuestion;
                
                // Pega a quest√£o atual (considerando puladas)
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }

                this.elements.performanceDisplay.style.display = 'none';
                this.elements.summaryText.style.display = 'none';

                let hint1 = currentQuestion.hint || "Sem dica dispon√≠vel.";
                let hint2 = currentQuestion.hint_2 || ""; 

                // L√≥gica Corrigida: Verifica se existe Hint 2
                if (hint2) {
                    // MODO COM DUAS DICAS
                    if (this.hintLevel === 0) { 
                        // MOSTRAR DICA 1
                        display.innerHTML = hint1; 
                        display.style.display = 'block';
                        button.textContent = 'DICA 2'; 
                        this.hintLevel = 1; 
                    } else if (this.hintLevel === 1) { 
                        // MOSTRAR DICA 2 (Junto com a 1)
                        display.innerHTML = hint1 + '<br><br>' + hint2;
                        display.style.display = 'block';
                        button.textContent = 'Ocultar Dicas'; 
                        button.style.background = 'linear-gradient(45deg, #28a745, #218838)';
                        this.hintLevel = 2; 
                    } else { 
                        // OCULTAR TUDO
                        display.style.display = 'none';
                        button.textContent = 'Dica';
                        button.style.background = ''; 
                        this.hintLevel = 0; 
                    }
                } else { 
                    // MODO SIMPLES (S√ì UMA DICA)
                    if (display.style.display === 'block') {
                        display.style.display = 'none';
                    } else {
                        if (currentQuestion && currentQuestion.hint) {
                            display.innerHTML = currentQuestion.hint;
                            display.style.display = 'block';
                        }
                    }
                }
            },

            showSummary() {
                const display = this.elements.summaryText;
                if (display.style.display === 'block') {
                    display.style.display = 'none';
                } else {
                    let currentQuestion;
                    if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
                        currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                    } else {
                        currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                    }
                    const questionTopic = currentQuestion.topic;
                    if (questionTopic && this.summaries[questionTopic]) {
                        display.textContent = this.summaries[questionTopic];
                        display.style.display = 'block';
                        this.elements.performanceDisplay.style.display = 'none';
                        this.elements.hintText.style.display = 'none';
                    }
                }
            },

            translateQuestion() {
                const button = this.elements.translateButton;
                const display = this.elements.translationDisplay;
                
                let currentQuestion;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }

                if (display.style.display === 'block') {
                    display.style.display = 'none';
                    button.textContent = 'üåê';
                    return;
                }
                
                let textToTranslate;
                if (currentQuestion.type === 'drag-drop') {
                    textToTranslate = currentQuestion.question; 
                } else {
                    textToTranslate = this.elements.questionText.textContent;
                }

                display.textContent = 'Traduzindo...';
                display.style.display = 'block';
                button.disabled = true;

                const langPair = 'en|pt'; 
                const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=${langPair}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.responseData && data.responseData.translatedText) {
                            display.textContent = data.responseData.translatedText;
                        } else {
                            display.textContent = 'Erro ao traduzir. Tente novamente.';
                        }
                        button.disabled = false;
                        button.textContent = 'üôà'; 
                    })
                    .catch(error => {
                        console.error('Translation error:', error);
                        display.textContent = 'N√£o foi poss√≠vel conectar ao servi√ßo de tradu√ß√£o.';
                        button.disabled = false;
                        button.textContent = 'üåê';
                    });
            },

            nextQuestion() {
                if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    this.currentQuestionIndex++;
                } else {
                    this.currentSkippedIndex++;
                }
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.currentSkippedIndex >= this.skippedQuestions.length) {
                    this.showResults();
                } else {
                    this.displayQuestion();
                }
            },

            skipQuestion() {
                if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    let currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                    const originalIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
                    if (!this.skippedQuestions.includes(originalIndex)) {
                        this.skippedQuestions.push(originalIndex);
                    }
                }
                this.currentQuestionIndex++;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length === 0) {
                    this.showResults();
                } else {
                    this.displayQuestion();
                }
            },

            getClassification(percentage) {
                if (percentage >= 86) return "Excelente!!!"; if (percentage >= 71) return "Muito Bom!!"; if (percentage >= 51) return "Bom!"; if (percentage >= 0) return "Insatisfat√≥rio!"; return "";
            },
            launchConfetti() { confetti({ particleCount: 600, spread: 70, origin: { y: 0.6 } }); },

            showResults() {
                const percentage = Math.round((this.score / this.questions.length) * 100);
                const classificationText = this.getClassification(percentage);

                const reportData = {
                    isCompleted: true, 
                    studentName: this.validatedStudentName,
                    studentCode: this.validatedStudentCode,
                    score: this.score,
                    totalQuestions: this.questions.length,
                    percentage: percentage,
                    classification: classificationText,
                    userAnswers: this.userAnswers,
                    originalQuestions: this.questions 
                };

                this.saveCompletedReport(reportData); 
                this.saveFinalReport(reportData);     

                this.displayReport(reportData);

                const dataForGoogle = { 
                    nome: this.validatedStudentName, 
                    codigo: this.validatedStudentCode, 
                    pontuacao: `(GRAMMAR) ${this.score} de ${this.questions.length}`, // Adicionado (GRAMMAR)
                    percentual: `${percentage}%`, 
                    classificacao: classificationText 
                };
                
                fetch(this.APP_SCRIPT_URL, { method: 'POST', body: JSON.stringify(dataForGoogle), headers: { 'Content-Type': 'application/json' }, mode: 'no-cors' })
                    .then(() => { 
                        this.elements.sendReportLink.textContent = 'Relat√≥rio Enviado!'; 
                        this.elements.sendReportLink.style.background = '#ccc'; 
                        this.elements.sendReportLink.onclick = (e) => e.preventDefault(); 
                    })
                    .catch(error => console.error('Erro:', error));
            },

            saveCompletedReport(reportData) {
                if (!reportData.studentCode) return;
                try {
                    localStorage.setItem(`quizState_${reportData.studentCode}`, JSON.stringify(reportData));
                } catch (e) {
                    console.error("N√£o foi poss√≠vel salvar o estado do quiz:", e);
                }
            },

            saveFinalReport(reportData) {
                if (!reportData.studentCode) return;
                try {
                    localStorage.setItem(`quizReport_${reportData.studentCode}`, JSON.stringify(reportData));
                } catch (e) {
                    console.error("N√£o foi poss√≠vel salvar o relat√≥rio final permanente:", e);
                }
            },

            displayReport(data) {
                // (PASSO 4) - CORRIGIDO PARA USAR O ID
                showCard('results-card', document.getElementById('results-tab-btn'));

                this.validatedStudentName = data.studentName;
                this.validatedStudentCode = data.studentCode;
                this.score = data.score;
                this.userAnswers = data.userAnswers;
                this.questions = data.originalQuestions; 

                this.elements.reportStudentName.textContent = data.studentName;
                this.elements.reportStudentCode.textContent = data.studentCode;
                this.elements.scoreDisplay.textContent = `${data.score} de ${data.totalQuestions}`;
                this.elements.percentageDisplay.textContent = `${data.percentage}%`;
                this.elements.classificationDisplay.textContent = data.classification;
                
                if (data.classification === "Excelente!!!") this.launchConfetti();
                
                this.elements.fullReportContainer.innerHTML = this.generateFullReportHtml();
                this.elements.personalReportContainer.innerHTML = this.generatePersonalReportHtml();
                
                const shareMessage = this.generateShareMessage(data.percentage, data.classification);
                this.elements.shareWhatsappLink.href = `https://wa.me/?text=${encodeURIComponent(shareMessage)}`;
                
                // Configura o bot√£o de relat√≥rio para o quiz de gram√°tica
                this.elements.sendReportLink.textContent = 'Enviar Relat√≥rio (Grammar)'; 
                this.elements.sendReportLink.style.background = '';
            },

            retrieveReport(code) {
                const finalReportJSON = localStorage.getItem(`quizReport_${code}`);
                if (!finalReportJSON) {
                    alert('Erro: Relat√≥rio n√£o encontrado.');
                    return;
                }
                
                try {
                    const state = JSON.parse(finalReportJSON);
                    if (state.isCompleted) {
                        this.displayReport(state); 
                        
                        this.elements.sendReportLink.textContent = 'Relat√≥rio J√° Enviado';
                        this.elements.sendReportLink.style.background = '#ccc';
                        this.elements.sendReportLink.onclick = (e) => e.preventDefault();
                    } else {
                        alert('O relat√≥rio salvo √© inv√°lido.');
                    }
                } catch (e) {
                    alert('Erro ao carregar relat√≥rio.');
                    localStorage.removeItem(`quizReport_${code}`); 
                }
            },

            getCorrectAnswerForQuestion(question) {
                if (question.type === 'fill-in') {
                    return question.answer[0];
                }
                if (question.type === 'drag-drop') {
                    return question.answer;
                }
                if (question.type === 'mcq' || question.type === 'tf' || question.type === 'audio_mcq') { 
                    const correctOption = question.options.find(o => o.isCorrect);
                    return correctOption ? correctOption.text : 'N/A';
                }
                return 'N/A';
            },

            generateFullReportHtml() {
                let reportHtml = '<h3>Relat√≥rio Detalhado</h3>';
                this.questions.forEach((question, index) => {
                    const answerData = this.userAnswers[index];
                    let questionText = question.question; 
                    questionText = questionText.replace(/______/g, '...'); 
                    
                    if (question.type === 'audio_mcq') {
                        // Usa a DICA 1 como texto da frase, se dispon√≠vel
                        const hintText = question.hint ? question.hint.replace("<strong>DICA 1:</strong> A frase √©: ", "").replace("<strong>DICA 1:</strong>", "").trim() : 'N/A';
                        questionText = `${questionText} (Frase de √Åudio: '${hintText}')`;
                    }

                    if (answerData) {
                        const itemClass = answerData.isCorrect ? 'correct' : 'incorrect';
                        reportHtml += `
                            <div class="report-question-item">
                                <p><strong>Quest√£o ${index + 1}:</strong> ${questionText}</p>
                                <p><strong>Sua Resposta:</strong> <span class="option-item-report ${itemClass}">${answerData.userAnswer}</span></p>
                                ${!answerData.isCorrect ? `<p><strong>Resposta Correta:</strong> <span class="option-item-report correct">${answerData.correctAnswer}</span></p>` : ''}
                                <p><em>Justificativa: ${answerData.rationale}</em></p>
                            </div>
                        `;
                    } else {
                        const correctAnswer = this.getCorrectAnswerForQuestion(question);
                        const rationale = question.rationale || (question.options ? (question.options.find(o => o.isCorrect) || {}).rationale : '');
                        reportHtml += `
                            <div class="report-question-item">
                                <p><strong>Quest√£o ${index + 1}:</strong> ${questionText}</p>
                                <p><strong>Sua Resposta:</strong> <span class="option-item-report incorrect">N√£o respondida</span></p>
                                <p><strong>Resposta Correta:</strong> <span class="option-item-report correct">${correctAnswer}</span></p>
                                <p><em>Justificativa: ${rationale}</em></p>
                            </div>
                        `;
                    }
                });
                return reportHtml;
            },
            
            analyzePerformanceByTopic() {
                const topicErrors = {};
                const topicTotals = {};

                this.questions.forEach((question, index) => {
                    const topic = question.topic;
                    if (!topic) return; 
                    if (!topicTotals[topic]) topicTotals[topic] = 0;
                    topicTotals[topic]++;

                    const answerData = this.userAnswers[index];
                    if (!answerData || !answerData.isCorrect) {
                        if (!topicErrors[topic]) topicErrors[topic] = 0;
                        topicErrors[topic]++;
                    }
                });
                
                return { topicErrors, topicTotals };
            },
            
            generatePersonalReportHtml() {
                const analysis = this.analyzePerformanceByTopic();
                let html = '<h3>Relat√≥rio Pessoal de Estudos</h3>';
                
                const topicsToReview = [];
                for (const topic in analysis.topicErrors) {
                    const errors = analysis.topicErrors[topic];
                    if (errors > 0) {
                        const total = analysis.topicTotals[topic];
                        const errorRate = (errors / total) * 100;
                        topicsToReview.push({ topic: topic, errors: errors, total: total, rate: errorRate });
                    }
                }

                topicsToReview.sort((a, b) => b.errors - a.errors);

                if (topicsToReview.length === 0) {
                    html += '<p style="font-weight: bold; color: #28a745;">Parab√©ns! Voc√™ n√£o errou nenhuma quest√£o. N√£o h√° nada para revisar.</p>';
                } else {
                     html += `<p>Aqui est√° seu guia de estudos focado nos t√≥picos que voc√™ precisa revisar, come√ßando pelos mais dif√≠ceis:</p><br>`;
                    topicsToReview.forEach(item => {
                        const summaryText = this.summaries[item.topic] || "N√£o h√° resumo dispon√≠vel para este t√≥pico.";
                        html += `
                            <div class="personal-summary-item">
                                <h4>T√≥pico: ${item.topic}</h4>
                                <p><strong>Seu desempenho:</strong> <span style="color: #dc3545;">${item.errors} de ${item.total} erradas</span> (${item.rate.toFixed(0)}% de erro)</p>
                                <p><strong>Resumo para Revis√£o:</strong><br>${summaryText}</p>
                            </div>
                        `;
                    });
                }

                return html;
            },
            
            printPersonalReport() {
                this.elements.fullReportContainer.style.display = 'none';
                this.elements.personalReportContainer.style.display = 'block';
                window.print();
            },
            
            printReport() { 
                this.elements.personalReportContainer.style.display = 'none';
                this.elements.fullReportContainer.style.display = 'block';
                window.print();
            },
            
            generateShareMessage(percentage, classificationText) {
                return `Acabei de fazer o quiz "ADVERBIAL CLAUSES"! Meu resultado: ${percentage}% (${classificationText}).`;
            },
            
            saveQuizState() {
                if (!this.validatedStudentCode) return;
                const state = {
                    isCompleted: false, 
                    currentQuestionIndex: this.currentQuestionIndex,
                    score: this.score,
                    userAnswers: this.userAnswers,
                    skippedQuestions: this.skippedQuestions,
                    currentSkippedIndex: this.currentSkippedIndex,
                    shuffledQuestions: this.shuffledQuestions
                };
                try {
                    localStorage.setItem(`quizState_${this.validatedStudentCode}`, JSON.stringify(state));
                } catch (e) {
                    console.error("N√£o foi poss√≠vel salvar o estado do quiz:", e);
                }
            },

            loadQuizState(studentCode) {
                try {
                    const savedState = localStorage.getItem(`quizState_${studentCode}`);
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        if (!state.isCompleted) {
                            this.currentQuestionIndex = state.currentQuestionIndex;
                            this.score = state.score;
                            this.userAnswers = state.userAnswers;
                            this.skippedQuestions = state.skippedQuestions;
                            this.currentSkippedIndex = state.currentSkippedIndex;
                            this.shuffledQuestions = state.shuffledQuestions; 
                            return true;
                        }
                    }
                } catch (e) {
                    console.error("N√£o foi poss√≠vel carregar o estado do quiz:", e);
                    localStorage.removeItem(`quizState_${studentCode}`); 
                }
                return false; 
            },

            updateAttemptsDisplay(code) {
                const savedStateJSON = localStorage.getItem(`quizState_${code}`); 
                const finalReportJSON = localStorage.getItem(`quizReport_${code}`); 
                const correctName = this.studentData[code];
                
                if (correctName) {
                    this.elements.personalizedWelcome.textContent = `Seja bem-vindo(a), ${correctName}! Boa sorte!`;
                    this.elements.personalizedWelcome.style.display = 'block';
                }

                let state = null;
                let finalReport = null;
                try { if (savedStateJSON) state = JSON.parse(savedStateJSON); } catch (e) { localStorage.removeItem(`quizState_${code}`); }
                try { if (finalReportJSON) finalReport = JSON.parse(finalReportJSON); } catch (e) { localStorage.removeItem(`quizReport_${code}`); }

                let buttonsHtml = '';

                if (state && !state.isCompleted) {
                    buttonsHtml = `
                        <p style="font-weight: bold; color: #007bff;">Encontramos um progresso salvo para voc√™.</p>
                        <button class="btn continue-btn" onclick="quizApp.startQuiz(true)">Continuar Quiz</button>
                        <button class="btn restart-btn" style="margin-left: 10px;" onclick="quizApp.startQuiz(false)">Reiniciar (Perder Progresso)</button>
                    `;
                } else if (state && state.isCompleted) {
                    buttonsHtml = `
                        <p style="font-weight: bold; color: #007bff;">Voc√™ j√° completou este quiz.</p>
                        <button class="btn restart-btn" onclick="quizApp.startQuiz(false)">Reiniciar Quiz</button>
                    `;
                } else {
                    buttonsHtml = `
                        <button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>
                    `;
                }

                if (finalReport) {
                    if (state && state.isCompleted) {
                        buttonsHtml = `
                            <p style="font-weight: bold; color: #007bff;">Voc√™ j√° completou este quiz.</p>
                            <button class="btn restart-btn" onclick="quizApp.startQuiz(false)">Reiniciar Quiz</button>
                            <button class="btn continue-btn" style="margin-left: 10px;" onclick="quizApp.retrieveReport('${code}')">Resgatar Relat√≥rio</button>
                        `;
                    } else {
                        buttonsHtml += `
                            <button class="btn continue-btn" style="margin-left: 10px;" onclick="quizApp.retrieveReport('${code}')">Resgatar √öltimo Relat√≥rio</button>
                        `;
                    }
                }
                
                this.elements.startActionsDiv.innerHTML = buttonsHtml;
            },
            
            restartQuiz() { 
                showCard('intro-card', document.querySelector("button[onclick*='intro-card']"));
                setupAdminViewRoteiro(false);
                setupAdminViewApostila(false);
            },
            
            saveReport() {
                const studentName = this.validatedStudentName;
                const studentCode = this.validatedStudentCode;
                const score = this.elements.scoreDisplay.textContent;
                const percentage = this.elements.percentageDisplay.textContent;
                const classification = this.elements.classificationDisplay.textContent;
                
                const detailedReportHtml = this.generateFullReportHtml();
                const personalReportHtml = this.generatePersonalReportHtml();


                const fullHtmlContent = `
                    <!DOCTYPE html>
                    <html lang="pt-BR">
                    <head>
                        <meta charset="UTF-BOM">
                        <title>Relat√≥rio - ${studentName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                            h1, h3 { color: #007bff; }
                            h4 { color: #856404; }
                            p { margin: 5px 0; }
                            .report-question-item { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; page-break-inside: avoid; }
                            .option-item-report.correct { background-color: #d4edda; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                            .option-item-report.incorrect { background-color: #f8d7da; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                            .personal-summary-item { background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; padding: 15px; margin-bottom: 15px; page-break-inside: avoid; }
                            #print-personal-btn { display: none; } 
                        </style>
                    </head>
                    <body>
                        <h1>Relat√≥rio Final - ADVERBIAL CLAUSES</h1>
                        <p><strong>Nome:</strong> ${studentName}</p>
                        <p><strong>C√≥digo de Acesso:</strong> ${studentCode}</p>
                        <p><strong>Pontua√ß√£o:</strong> ${score}</p>
                        <p><strong>Percentual de Acerto:</strong> ${percentage}</p>
                        <p><strong>Classifica√ß√£o:</strong> ${classification}</p>
                        <hr>
                        <div id="personal-report-container">
                            ${personalReportHtml}
                        </div>
                        <hr>
                        <div id="full-report-container">
                            ${detailedReportHtml}
                        </div>
                    </body>
                    </html>
                `;

                const blob = new Blob([fullHtmlContent], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Relatorio_${studentName.replace(' ', '_')}_${studentCode}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            },

            init() {
                setupAdminViewRoteiro(false);
                setupAdminViewApostila(false);
                
                this.elements.studentCodeInput.addEventListener('input', (e) => {
                    const code = e.target.value.trim().toUpperCase();
                    if (this.studentData[code]) { 
                        this.updateAttemptsDisplay(code); 
                    } 
                    else { 
                        this.elements.startActionsDiv.innerHTML = '<button class=\"start-btn\" onclick=\"quizApp.startQuiz(false)\">Start Quiz</button>'; 
                        this.elements.personalizedWelcome.style.display = 'none';
                    }
                });
                
                this.elements.translateButton.onclick = () => this.translateQuestion();
                this.elements.performanceButton.onclick = () => this.showPerformance();
                this.elements.hintButton.onclick = () => this.showHint();
                this.elements.summaryButton.onclick = () => this.showSummary();
                this.elements.nextButton.onclick = () => this.nextQuestion();
                this.elements.skipButton.onclick = () => this.skipQuestion();
            }
        };


        // --------------------------------------------------------------------
        // L√ìGICA DO QUIZ DE VOCABUL√ÅRIO (vocabQuizApp) - NOVO BLOCO
        // --------------------------------------------------------------------
        const vocabQuizApp = {
            APP_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwtDAlCCBcc3cN3pHX5YTkCZBsYTH--UJbeaczv64av_vIkybVIaEs-nTLKM2ssHND2/exec',
            currentQuestionIndex: 0,
            score: 0,
            userAnswers: {},
            validatedStudentName: '',
            validatedStudentCode: '',
            totalAttempts: "Ilimitadas",
            skippedQuestions: [],
            currentSkippedIndex: 0,
            shuffledQuestions: [],
            hintLevel: 0, 
            
            // Elementos com IDs 'vocab-'
            elements: {
                quizCard: document.getElementById('vocab-quiz-card'),
                questionText: document.getElementById('vocab-question-text'),
                optionsList: document.getElementById('vocab-options-list'),
                justificationContainer: document.getElementById('vocab-justification-container'),
                nextButton: document.getElementById('vocab-next-button'),
                skipButton: document.getElementById('vocab-skip-button'),
                hintButton: document.getElementById('vocab-hint-button'),
                hintText: document.getElementById('vocab-hint-text'),
                attemptsLeftSpan: document.getElementById('vocab-attempts-left'),
                currentQuestionNumSpan: document.getElementById('vocab-current-question-num'),
                summaryButton: document.getElementById('vocab-summary-button'),
                summaryText: document.getElementById('vocab-summary-text'),
                performanceButton: document.getElementById('vocab-performance-btn'),
                performanceDisplay: document.getElementById('vocab-performance-display'),
                progressBar: document.getElementById('vocab-progress-bar'),
                translateButton: document.getElementById('vocab-translate-button'),
                translationDisplay: document.getElementById('vocab-translation-display'),
                audioContainer: document.getElementById('vocab-audio-container'),
                audioPlayContainer: document.getElementById('vocab-audio-play-container'),
                
                // Elementos do resultado (s√£o compartilhados)
                resultsCard: document.getElementById('results-card'),
                scoreDisplay: document.getElementById('score-display'),
                percentageDisplay: document.getElementById('percentage-display'),
                classificationDisplay: document.getElementById('classification-display'),
                reportStudentName: document.getElementById('report-student-name'),
                reportStudentCode: document.getElementById('report-student-code'),
                sendReportLink: document.getElementById('send-report-link'),
                fullReportContainer: document.getElementById('full-report-container'),
                shareWhatsappLink: document.getElementById('share-whatsapp'),
                personalReportContainer: document.getElementById('personal-report-container')
            },

            studentData: quizApp.studentData, // Reutiliza os dados dos alunos
            
            summaries: vocabSummaries, // Usa os resumos de vocabul√°rio
            
            questions: vocabQuestions, // Usa as quest√µes de vocabul√°rio

            shuffleArray: quizApp.shuffleArray, // Reutiliza

            balanceCorrectAnswers() {
                const mcqQuestions = this.questions.filter(q => q.type === 'mcq' && q.options && q.options.length === 4);
                if (mcqQuestions.length === 0) return;
                
                const numPositions = 4;
                let desiredPositions = [];
                for (let i = 0; i < mcqQuestions.length; i++) {
                    desiredPositions.push(i % numPositions);
                }
                this.shuffleArray(desiredPositions);
                
                let mcqCounter = 0;
                this.questions.forEach((q) => {
                    if (q.type === 'mcq' && q.options && q.options.length === 4) {
                        this.shuffleArray(q.options);
                        const correctOption = q.options.find(opt => opt.isCorrect);
                        if (!correctOption) return;
                        const targetIndex = desiredPositions[mcqCounter];
                        if (q.options.indexOf(correctOption) !== targetIndex) {
                            const currentIndex = q.options.indexOf(correctOption);
                            [q.options[currentIndex], q.options[targetIndex]] = [q.options[targetIndex], q.options[currentIndex]];
                        }
                        mcqCounter++;
                    }
                });
            },
            
            updateProgressBar() {
                const totalQuestions = this.questions.length;
                const answeredCount = (this.currentQuestionIndex - this.skippedQuestions.length) + this.currentSkippedIndex;
                const percentage = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;
                this.elements.progressBar.style.width = percentage + '%';
                this.elements.progressBar.textContent = percentage + '%';
            },

            startQuiz(continueFromSavedState) {
                // N√£o valida o c√≥digo, apenas recebe
                if (!this.validatedStudentCode) {
                    alert("Erro! Tente fazer login novamente.");
                    showCard('intro-card', document.querySelector('.tab-inicio'));
                    return;
                }
                
                if (continueFromSavedState) { 
                    this.loadQuizState(this.validatedStudentCode); 
                } 
                else {
                    this.currentQuestionIndex = 0;
                    this.score = 0;
                    this.userAnswers = {};
                    this.skippedQuestions = [];
                    this.currentSkippedIndex = 0;
                    this.balanceCorrectAnswers();
                    localStorage.removeItem(`vocabQuizState_${this.validatedStudentCode}`); 
                    this.shuffledQuestions = this.shuffleArray([...this.questions]);
                }
                
                this.displayQuestion();
            },

            displayQuestion() {
                this.updateProgressBar();
                this.elements.performanceDisplay.style.display = 'none';
                this.elements.justificationContainer.innerHTML = '';
                this.elements.hintText.style.display = 'none';
                this.elements.summaryText.style.display = 'none';
                this.elements.summaryButton.style.display = 'none';
                this.elements.nextButton.style.display = 'none';

                this.elements.translationDisplay.style.display = 'none'; 
                this.elements.translateButton.style.display = 'inline-block'; 
                this.elements.translateButton.disabled = false;
                this.elements.translateButton.textContent = 'üåê'; 
                
                this.elements.audioContainer.innerHTML = ''; 
                this.elements.audioPlayContainer.innerHTML = ''; 
                this.elements.questionText.style.display = 'flex'; 

                this.hintLevel = 0; 
                this.elements.hintButton.textContent = 'Dica'; 
                this.elements.hintButton.style.background = ''; 
                this.elements.hintButton.disabled = false; 
                this.elements.hintButton.onclick = () => this.showHint(); 
                
                let questionToDisplay;
                let currentQuestionNumber;
                let totalAnswered = (this.currentQuestionIndex - this.skippedQuestions.length) + this.currentSkippedIndex;

                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0 && this.currentSkippedIndex < this.skippedQuestions.length) {
                    const skippedIndex = this.skippedQuestions[this.currentSkippedIndex];
                    questionToDisplay = this.questions[skippedIndex]; 
                    currentQuestionNumber = `(Pulada ${this.currentSkippedIndex + 1}/${this.skippedQuestions.length})`
                    this.elements.skipButton.style.display = 'none';
                } else if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    questionToDisplay = this.shuffledQuestions[this.currentQuestionIndex];
                    currentQuestionNumber = totalAnswered + 1;
                    this.elements.skipButton.style.display = 'inline-block';
                } else {
                    this.showResults();
                    return;
                }
                
                this.elements.currentQuestionNumSpan.textContent = currentQuestionNumber;
                
                this.elements.optionsList.innerHTML = '';

                switch (questionToDisplay.type) {
                    case 'fill-in': this.renderFillIn(questionToDisplay); break;
                    case 'drag-drop': this.renderDragDrop(questionToDisplay); break;
                    case 'tf': this.renderMCQ(questionToDisplay); break;
                    case 'audio_mcq': this.renderAudioMCQ(questionToDisplay); break; 
                    case 'mcq': default: this.renderMCQ(questionToDisplay); break;
                }
            },

            renderAudioMCQ(question) {
                this.elements.audioContainer.innerHTML = ''; 
                const audioEl = document.createElement('audio');
                audioEl.src = question.audioSrc;
                audioEl.preload = 'auto'; 
                this.elements.audioContainer.appendChild(audioEl);

                this.elements.audioPlayContainer.innerHTML = ''; 
                const playBtn = document.createElement('button');
                playBtn.className = 'btn audio-play-btn';
                playBtn.textContent = 'Ouvir Quest√£o üéß';
                playBtn.onclick = () => audioEl.play();
                this.elements.audioPlayContainer.appendChild(playBtn);
                
                this.elements.translateButton.style.display = 'none';

                this.renderMCQ(question);
            },

            renderMCQ(question) {
                this.elements.questionText.innerHTML = ''; 
                this.elements.questionText.textContent = question.question;
                
                if (question.type !== 'audio_mcq') {
                    this.elements.translateButton.style.display = 'inline-block';
                } else {
                    this.elements.translateButton.style.display = 'none';
                }

                question.options.forEach(option => {
                    const li = document.createElement('li');
                    li.className = 'option-item';
                    li.textContent = option.text;
                    li.onclick = () => this.selectOption(li, option);
                    this.elements.optionsList.appendChild(li);
                });
            },

            renderFillIn(question) {
                this.elements.questionText.innerHTML = ''; 
                this.elements.questionText.textContent = question.question;
                this.elements.translateButton.style.display = 'inline-block'; 
                
                const input = document.createElement('input');
                input.id = 'fill-in-input'; 
                input.placeholder = 'Digite sua resposta...';
                const checkButton = document.createElement('button');
                checkButton.textContent = 'Verificar';
                checkButton.className = 'btn check-btn';
                checkButton.onclick = () => {
                    const userAnswer = input.value.trim().toLowerCase();
                    const isCorrect = question.answer.map(ans => ans.toLowerCase()).includes(userAnswer);
                    this.handleAnswer(isCorrect, question.rationale, input.value.trim(), question.answer[0]);
                    input.disabled = true;
                    checkButton.style.display = 'none';
                    input.classList.add(isCorrect ? 'correct' : 'incorrect');
                };
                this.elements.optionsList.appendChild(input);
                this.elements.optionsList.appendChild(checkButton);
            },

            renderDragDrop(question) {
                const dropZone = document.createElement('span');
                dropZone.id = 'drop-zone';
                dropZone.textContent = 'Arraste aqui';
                const questionTextHTML = question.question.replace('______', dropZone.outerHTML);
                this.elements.questionText.innerHTML = questionTextHTML; 
                this.elements.translateButton.style.display = 'inline-block'; 
                
                const actualDropZone = this.elements.questionText.querySelector('#drop-zone');
                const dragOptionsWrapper = document.createElement('div');
                dragOptionsWrapper.className = 'drag-options-wrapper';
                this.shuffleArray(question.options).forEach(opt => {
                    const optionEl = document.createElement('span');
                    optionEl.textContent = opt;
                    optionEl.className = 'drag-option';
                    optionEl.draggable = true;
                    optionEl.dataset.value = opt;
                    optionEl.ondragstart = (e) => { e.dataTransfer.setData('text/plain', e.target.dataset.value); e.target.classList.add('dragging'); };
                    optionEl.ondragend = (e) => e.target.classList.remove('dragging');
                    dragOptionsWrapper.appendChild(optionEl);
                });
                this.elements.optionsList.appendChild(dragOptionsWrapper);
                actualDropZone.ondragover = (e) => { e.preventDefault(); actualDropZone.classList.add('over'); };
                actualDropZone.ondragleave = () => actualDropZone.classList.remove('over');
                actualDropZone.ondrop = (e) => {
                    e.preventDefault();
                    actualDropZone.classList.remove('over');
                    const droppedValue = e.dataTransfer.getData('text/plain');
                    const isCorrect = (droppedValue.toLowerCase() === question.answer.toLowerCase());
                    this.handleAnswer(isCorrect, question.rationale, droppedValue, question.answer);
                    actualDropZone.textContent = droppedValue;
                    actualDropZone.classList.add(isCorrect ? 'correct' : 'incorrect');
                    this.elements.optionsList.querySelectorAll('.drag-option').forEach(el => { el.draggable = false; el.style.cursor = 'not-allowed'; el.style.opacity = '0.6'; });
                };
            },

            selectOption(selectedElement, selectedOption) {
                this.elements.optionsList.querySelectorAll('.option-item').forEach(option => option.style.pointerEvents = 'none');
                const isCorrect = selectedOption.isCorrect;
                
                let currentQuestion;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }
                
                selectedElement.classList.add(isCorrect ? 'correct' : 'incorrect');
                this.handleAnswer(isCorrect, selectedOption.rationale, selectedOption.text, currentQuestion.options.find(o => o.isCorrect).text);

                if (!isCorrect) {
                    const correctText = currentQuestion.options.find(opt => opt.isCorrect).text;
                    const correctElement = Array.from(this.elements.optionsList.querySelectorAll('.option-item')).find(el => el.textContent === correctText);
                    if (correctElement) correctElement.classList.add('correct');
                }
            },

            handleAnswer(isCorrect, rationale, userAnswer, correctAnswer) {
                if (isCorrect) {
                    this.score++;
                    this.elements.summaryButton.style.display = 'none';
                } else {
                    this.elements.summaryButton.style.display = 'inline-block';
                }
                const justificationElement = document.createElement('div');
                justificationElement.className = 'justification';
                justificationElement.innerHTML = rationale; 
                justificationElement.style.borderLeftColor = isCorrect ? '#28a745' : '#dc3545';
                this.elements.justificationContainer.appendChild(justificationElement);
                
                let originalQuestionIndex;
                let currentQuestion;
                 if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
                    originalQuestionIndex = this.skippedQuestions[this.currentSkippedIndex];
                    currentQuestion = this.questions[originalQuestionIndex];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                    originalQuestionIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
                }
                
                this.userAnswers[originalQuestionIndex] = {
                    question: currentQuestion.question, 
                    userAnswer: userAnswer,
                    isCorrect: isCorrect,
                    correctAnswer: correctAnswer,
                    rationale: rationale,
                    type: currentQuestion.type || 'mcq',
                    topic: currentQuestion.topic || 'Geral' 
                };
                
                this.elements.nextButton.style.display = 'block';
                this.elements.skipButton.style.display = 'none';
                this.saveQuizState();
            },

            showPerformance() {
                const display = this.elements.performanceDisplay;
                if (display.style.display === 'block') {
                    display.style.display = 'none';
                } else {
                    const answeredCount = Object.keys(this.userAnswers).length;
                    const incorrectCount = answeredCount - this.score;
                    display.innerHTML = `<strong style="color: #333;">At√© agora:</strong> <span style="color: #28a745;">${this.score} acertos</span> <strong style="color: #333;">e</strong> <span style="color: #dc3545;">${incorrectCount} erros</span><strong style="color: #333;">!</strong>`;
                    display.style.display = 'block';
                    this.elements.hintText.style.display = 'none';
                    this.elements.summaryText.style.display = 'none';
                }
            },
            
            // --------------------------------------------------------------------
            // CORRE√á√ÉO: Fun√ß√£o de Dica dedicada ao Quiz de Vocabul√°rio
            // --------------------------------------------------------------------
// TROQUEI AQUI!!!
            showHint() {
                const display = this.elements.hintText;
                const button = this.elements.hintButton; 
                let currentQuestion;
                
                // Pega a quest√£o atual (considerando puladas)
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }

                this.elements.performanceDisplay.style.display = 'none';
                this.elements.summaryText.style.display = 'none';

                let hint1 = currentQuestion.hint || "Sem dica dispon√≠vel.";
                let hint2 = currentQuestion.hint_2 || ""; 

                // L√≥gica Corrigida: Verifica se existe Hint 2
                if (hint2) {
                    // MODO COM DUAS DICAS
                    if (this.hintLevel === 0) { 
                        // MOSTRAR DICA 1
                        display.innerHTML = hint1; 
                        display.style.display = 'block';
                        button.textContent = 'DICA 2'; 
                        this.hintLevel = 1; 
                    } else if (this.hintLevel === 1) { 
                        // MOSTRAR DICA 2 (Junto com a 1)
                        display.innerHTML = hint1 + '<br><br>' + hint2;
                        display.style.display = 'block';
                        button.textContent = 'Ocultar Dicas'; 
                        button.style.background = 'linear-gradient(45deg, #28a745, #218838)';
                        this.hintLevel = 2; 
                    } else { 
                        // OCULTAR TUDO
                        display.style.display = 'none';
                        button.textContent = 'Dica';
                        button.style.background = ''; 
                        this.hintLevel = 0; 
                    }
                } else { 
                    // MODO SIMPLES (S√ì UMA DICA)
                    if (display.style.display === 'block') {
                        display.style.display = 'none';
                    } else {
                        if (currentQuestion && currentQuestion.hint) {
                            display.innerHTML = currentQuestion.hint;
                            display.style.display = 'block';
                        }
                    }
                }
            },
            // (FIM DA CORRE√á√ÉO)

            showSummary() {
                const display = this.elements.summaryText;
                if (display.style.display === 'block') {
                    display.style.display = 'none';
                } else {
                    let currentQuestion;
                    if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
                        currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                    } else {
                        currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                    }
                    const questionTopic = currentQuestion.topic;
                    if (questionTopic && this.summaries[questionTopic]) {
                        display.textContent = this.summaries[questionTopic];
                        display.style.display = 'block';
                        this.elements.performanceDisplay.style.display = 'none';
                        this.elements.hintText.style.display = 'none';
                    }
                }
            },
            
            translateQuestion: quizApp.translateQuestion, // Reutiliza
            nextQuestion: quizApp.nextQuestion, // Reutiliza
            skipQuestion: quizApp.skipQuestion, // Reutiliza
            getClassification: quizApp.getClassification, // Reutiliza
            launchConfetti: quizApp.launchConfetti, // Reutiliza
            
            showResults() {
                const percentage = Math.round((this.score / this.questions.length) * 100);
                const classificationText = this.getClassification(percentage);

                const reportData = {
                    isCompleted: true, 
                    studentName: this.validatedStudentName,
                    studentCode: this.validatedStudentCode,
                    score: this.score,
                    totalQuestions: this.questions.length,
                    percentage: percentage,
                    classification: classificationText,
                    userAnswers: this.userAnswers,
                    originalQuestions: this.questions,
                    quizTitle: "VOCABULARY QUIZ" // <-- T√≠tulo novo
                };

                this.saveCompletedReport(reportData); 
                this.saveFinalReport(reportData);     
                this.displayReport(reportData);

                const dataForGoogle = { 
                    nome: this.validatedStudentName, 
                    codigo: this.validatedStudentCode, 
                    pontuacao: `(VOCAB) ${this.score} de ${this.questions.length}`, // Adicionado (VOCAB)
                    percentual: `${percentage}%`, 
                    classificacao: classificationText 
                };
                
                fetch(this.APP_SCRIPT_URL, { method: 'POST', body: JSON.stringify(dataForGoogle), headers: { 'Content-Type': 'application/json' }, mode: 'no-cors' })
                    .catch(error => console.error('Erro no Vocab Quiz:', error));
            },

            saveCompletedReport(reportData) {
                if (!reportData.studentCode) return;
                try {
                    localStorage.setItem(`vocabQuizState_${reportData.studentCode}`, JSON.stringify(reportData));
                } catch (e) {
                    console.error("N√£o foi poss√≠vel salvar o estado do quiz:", e);
                }
            },

            saveFinalReport(reportData) {
                if (!reportData.studentCode) return;
                try {
                    localStorage.setItem(`vocabQuizReport_${reportData.studentCode}`, JSON.stringify(reportData));
                } catch (e) {
                    console.error("N√£o foi poss√≠vel salvar o relat√≥rio final permanente:", e);
                }
            },

            displayReport(data) {
                // (PASSO 4) - CORRIGIDO PARA USAR O ID
                showCard('results-card', document.getElementById('results-tab-btn'));

                this.validatedStudentName = data.studentName;
                this.validatedStudentCode = data.studentCode;
                this.score = data.score;
                this.userAnswers = data.userAnswers;
                this.questions = data.originalQuestions; 

                this.elements.reportStudentName.textContent = data.studentName;
                this.elements.reportStudentCode.textContent = data.studentCode;
                this.elements.scoreDisplay.textContent = `${data.score} de ${data.totalQuestions}`;
                this.elements.percentageDisplay.textContent = `${data.percentage}%`;
                this.elements.classificationDisplay.textContent = data.classification;
                
                if (data.classification === "Excelente!!!") this.launchConfetti();
                
                this.elements.fullReportContainer.innerHTML = quizApp.generateFullReportHtml.call(this); // Usa a fun√ß√£o do quizApp, mas com os dados do vocabQuizApp
                this.elements.personalReportContainer.innerHTML = quizApp.generatePersonalReportHtml.call(this); // Usa a fun√ß√£o do quizApp, mas com os dados do vocabQuizApp
                
                const shareMessage = this.generateShareMessage(data.percentage, data.classification);
                this.elements.shareWhatsappLink.href = `https://wa.me/?text=${encodeURIComponent(shareMessage)}`;
                
                // Configura o bot√£o de relat√≥rio para o quiz de vocabul√°rio
                this.elements.sendReportLink.textContent = 'Relat√≥rio Enviado (Vocab)'; 
                this.elements.sendReportLink.style.background = 'linear-gradient(45deg, #155724, #28a745)';
                this.elements.sendReportLink.onclick = (e) => {
                     e.preventDefault();
                     alert('Envio autom√°tico j√° realizado. Clique em "Reiniciar Teste" para voltar.');
                };
            },

            retrieveReport(code) {
                const finalReportJSON = localStorage.getItem(`vocabQuizReport_${code}`);
                if (!finalReportJSON) {
                    alert('Erro: Relat√≥rio de vocabul√°rio n√£o encontrado.');
                    return;
                }
                
                try {
                    const state = JSON.parse(finalReportJSON);
                    if (state.isCompleted) {
                        this.displayReport(state); 
                        
                        this.elements.sendReportLink.textContent = 'Relat√≥rio J√° Enviado';
                        this.elements.sendReportLink.style.background = '#ccc';
                        this.elements.sendReportLink.onclick = (e) => e.preventDefault();
                    } else {
                        alert('O relat√≥rio salvo √© inv√°lido.');
                    }
                } catch (e) {
                    alert('Erro ao carregar relat√≥rio.');
                    localStorage.removeItem(`vocabQuizReport_${code}`); 
                }
            },

            getCorrectAnswerForQuestion: quizApp.getCorrectAnswerForQuestion, // Reutiliza
            generateFullReportHtml: quizApp.generateFullReportHtml, // Reutiliza
            analyzePerformanceByTopic: quizApp.analyzePerformanceByTopic, // Reutiliza
            generatePersonalReportHtml: quizApp.generatePersonalReportHtml, // Reutiliza
            printPersonalReport: quizApp.printPersonalReport, // Reutiliza
            printReport: quizApp.printReport, // Reutiliza
            
            generateShareMessage(percentage, classificationText) {
                return `Acabei de fazer o "QUIZ DE VOCABUL√ÅRIO"! Meu resultado: ${percentage}% (${classificationText}).`;
            },
            
            saveQuizState() {
                if (!this.validatedStudentCode) return;
                const state = {
                    isCompleted: false, 
                    currentQuestionIndex: this.currentQuestionIndex,
                    score: this.score,
                    userAnswers: this.userAnswers,
                    skippedQuestions: this.skippedQuestions,
                    currentSkippedIndex: this.currentSkippedIndex,
                    shuffledQuestions: this.shuffledQuestions
                };
                try {
                    localStorage.setItem(`vocabQuizState_${this.validatedStudentCode}`, JSON.stringify(state));
                } catch (e) {
                    console.error("N√£o foi poss√≠vel salvar o estado do quiz:", e);
                }
            },

            loadQuizState(studentCode) {
                try {
                    const savedState = localStorage.getItem(`vocabQuizState_${studentCode}`);
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        if (!state.isCompleted) {
                            this.currentQuestionIndex = state.currentQuestionIndex;
                            this.score = state.score;
                            this.userAnswers = state.userAnswers;
                            this.skippedQuestions = state.skippedQuestions;
                            this.currentSkippedIndex = state.currentSkippedIndex;
                            this.shuffledQuestions = state.shuffledQuestions; 
                            return true;
                        }
                    }
                } catch (e) {
                    console.error("N√£o foi poss√≠vel carregar o estado do quiz:", e);
                    localStorage.removeItem(`vocabQuizState_${studentCode}`); 
                }
                return false; 
            },
            
            restartQuiz: quizApp.restartQuiz, // Reutiliza (ambos voltam para o In√≠cio)
            
            saveReport: quizApp.saveReport, // Reutiliza
            
            init() {
                this.elements.translateButton.onclick = () => this.translateQuestion();
                this.elements.performanceButton.onclick = () => this.showPerformance();
                this.elements.hintButton.onclick = () => this.showHint();
                this.elements.summaryButton.onclick = () => this.showSummary();
                this.elements.nextButton.onclick = () => this.nextQuestion();
                this.elements.skipButton.onclick = () => this.skipQuestion();
            }
        };


        // --- FUN√á√ïES DO MODAL DE CONTE√öDO (PDF) ---
        
        function openReadModal(pdfLink, title) {
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');
            modalBody.innerHTML = ''; 
            modalTitle.textContent = title || 'Material de Estudo';
            
            if (pdfLink && pdfLink !== 'COLE_O_LINK_DA_APOSTILA_AQUI' && pdfLink !== 'COLE_O_LINK_DO_ROTEIRO_AQUI') {
                const iframe = document.createElement('iframe');
                iframe.src = pdfLink;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                modalBody.appendChild(iframe);
            } else {
                modalBody.innerHTML = '<p style="padding: 20px; text-align: center;">Erro: Link do PDF n√£o encontrado ou n√£o configurado.</p>';
            }
            
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeReadModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('modal-body').innerHTML = ''; // Limpa o iframe
            document.getElementById('modal-content').classList.remove('night-mode');
            document.getElementById('night-mode-toggle').textContent = 'Modo Noturno üåô';
        }

        function toggleNightMode() {
            const modalContent = document.getElementById('modal-content');
            modalContent.classList.toggle('night-mode');
            
            const btn = document.getElementById('night-mode-toggle');
            if (modalContent.classList.contains('night-mode')) {
                btn.textContent = 'Modo Claro ‚òÄÔ∏è';
            } else {
                btn.textContent = 'Modo Noturno üåô';
            }
        }
        
        function downloadContent(pdfLink) {
             if (pdfLink && pdfLink !== 'COLE_O_LINK_DA_APOSTILA_AQUI' && pdfLink !== 'COLE_O_LINK_DO_ROTEIRO_AQUI') {
                let downloadLink = pdfLink.replace("/preview", "/view"); 
                
                if (pdfLink.includes('archive.org')) {
                    downloadLink = pdfLink;
                } else if (pdfLink.includes('drive.google.com')) {
                     downloadLink = pdfLink.replace("/preview", "/view?usp=sharing"); 
                }
                
                const a = document.createElement('a');
                a.href = downloadLink; 
                a.target = '_blank'; 
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert('Nenhum material em PDF dispon√≠vel para download.');
            }
        }

        
        // --- INICIALIZA√á√ÉO ---
        
        document.addEventListener("DOMContentLoaded", () => {
            const intro = document.getElementById("intro-card");
            if (intro) {
                intro.style.display = "flex";
                intro.style.flexDirection = "column";
            }
        });

        window.onload = function() {
            quizApp.init(); 
            vocabQuizApp.init(); // ATIVANDO O NOVO QUIZ DE VOCABUL√ÅRIO
            
            document.getElementById('modal-close-btn').onclick = closeReadModal;
            document.getElementById('night-mode-toggle').onclick = toggleNightMode;
            
            const modalOverlay = document.getElementById('modal-overlay');
            modalOverlay.onclick = function(event) {
                if (event.target == modalOverlay) {
                    closeReadModal();
                }
            };

            const firstBtn = document.querySelector('.tablinks');
            if (firstBtn) {
                showCard('intro-card', firstBtn);
            } else {
                showCard('intro-card', null); 
            }
        };
    </script>
</body>
</html>