<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Estudos - 1¬∫ Ano M√©dio (Conte√∫do: 1¬∫ Ano M√©dio)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f1f8 100%);
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
            width: 90%;
            max-width: 700px;
            min-height: 400px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            background: linear-gradient(45deg, #dc3545, #d90429);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 20px;
        }
        h2 { text-align: center; color: #444; }

        /* --- Controle de Abas e Cards --- */
        .question-card, .results-card, .intro-card, #roteiro-content-tab, #apostila-content-tab, #vocab-quiz-card { 
            display: none; 
            flex-direction: column; 
        }
        
        .intro-card { 
            text-align: center; 
        }
        .intro-card input { padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; }
        
        #student-code {
            text-transform: uppercase;
        }

        /* --- (NOVO) Estilo de Abas de Navega√ß√£o (Colorido) --- */
        .tab-buttons {
            display: flex;
            flex-wrap: wrap; /* Permite quebra de linha */
            justify-content: space-around;
            margin-bottom: 25px;
            gap: 8px; /* Espa√ßamento entre os bot√µes */
        }
        .tab-buttons button {
            border: 1px solid transparent; /* Borda sutil */
            font-weight: 600;
            padding: 12px 10px; /* Mais preenchimento */
            border-radius: 8px;
            transition: all 0.3s ease;
            flex-grow: 1; /* Ocupa espa√ßo igual */
            flex-basis: 180px; /* Largura m√≠nima (cria 2 ou 3 colunas) */
            text-align: center;
            cursor: pointer;
            font-size: 0.95rem; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Cores Espec√≠ficas das Abas (Inativas) */
        .tab-buttons .tab-inicio { 
            background-color: #e9ecef; /* Cinza claro */
            color: #495057; /* Cinza escuro */
            border-color: #dee2e6;
        }
        .tab-buttons .tab-quiz-g { 
            background-color: #e6f2ff; /* Azul claro */
            color: #0056b3; /* Azul escuro */
            border-color: #b3d7ff;
        }
        .tab-buttons .tab-quiz-v { 
            background-color: #eafff0; /* Verde claro */
            color: #155724; /* Verde escuro */
            border-color: #b9f0c8;
        }
        .tab-buttons .tab-roteiro { 
            background-color: #fdf5e6; /* Creme */
            color: #c55a11; /* Laranja escuro */
            border-color: #fce3c0;
        }
        .tab-buttons .tab-apostila { 
            background-color: #f4efff; /* Lil√°s claro */
            color: #3b1c6b; /* Roxo escuro */
            border-color: #dcd0ff;
        }
        .tab-buttons .tab-resultados { 
            background-color: #ffeef0; /* Rosa claro */
            color: #721c24; /* Vermelho escuro */
            border-color: #ffd0d6;
        }
        
        .tab-buttons button:hover {
            opacity: 0.85; /* Leve transpar√™ncia */
            transform: translateY(-2px); /* Efeito de levantar */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* O bot√£o ATIVO fica branco e destacado */
        .tab-buttons button.active {
            background-color: #fff; /* Fundo branco */
            color: #007bff; /* Texto azul */
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.25); /* Sombra azul */
            transform: translateY(-3px);
            opacity: 1;
            border-color: #007bff; /* Borda azul */
        }

        /* --- Estilos do Quiz --- */
        .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 25px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { width: 0%; height: 20px; background: linear-gradient(90deg, #007bff, #0056b3); text-align: center; line-height: 20px; color: white; font-weight: bold; transition: width 0.4s ease-in-out; }

        .audio-container {
            width: 100%;
            margin-bottom: 15px;
        }
        .audio-container audio {
            display: none;
        }
        
        #audio-play-container, 
        #vocab-audio-play-container { /* ADICIONADO #vocab-audio-play-container AQUI */
            width: 100%;
            text-align: center; 
            margin-bottom: 15px;
        }
        .audio-play-btn {
            background: linear-gradient(45deg, #17a2b8, #117a8b);
            color: white;
            font-size: 1.1rem;
            width: 80%;
            max-width: 300px;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .audio-play-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }


        .question-text-wrapper {
            display: flex;
            align-items: center; 
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.2rem;
            flex-grow: 1; 
            min-height: 50px; 
            display: flex;
            justify-content: flex-start; 
            align-items: center;
            text-align: left; 
        }

        .translate-btn {
            background: transparent; 
            border: none;            
            color: #007bff;          
            font-size: 2.5rem;       
            cursor: pointer;
            flex-shrink: 0;
            padding: 0;
            margin: 0;
            line-height: 1;
            transition: transform 0.2s; 
        }
        .translate-btn:hover {
            transform: scale(1.15); 
        }
        .translate-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }


        .translation-text {
            margin-top: -15px; 
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 5px solid #ffc107; 
            border-radius: 5px;
            font-style: italic;
            display: none; 
        }


        .options-list { list-style: none; padding: 0; margin: 0; }

        .option-item { 
            background-color: #fff;
            border: 2px solid #ccc; /* <-- Borda padr√£o mais real√ßada (da corre√ß√£o anterior) */
            padding: 16px; 
            margin-bottom: 10px; 
            border-radius: 8px;
            cursor: pointer; 
            font-weight: 500;
            transition: all 0.2s ease; 
        }
        .option-item:hover { 
            background-color: #f8f9fa; 
            border-color: #007bff;
            color: #007bff;
            transform: scale(1.01);
        }
        .option-item.correct { 
            background-color: #d4edda; 
            border-color: #28a745; 
            color: #155724; 
            transform: scale(1.02); 
            font-weight: 700;
        }
        .option-item.incorrect { 
            background-color: #f8d7da; 
            border-color: #dc3545; 
            color: #721c24; 
            animation: shake 0.5s ease-in-out; 
            font-weight: 700;
        }

        .justification { margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-left: 5px solid #007bff; border-radius: 5px; display: block; }

        /* --- Estilo de Bot√£o Geral Aprimorado --- */
        .btn, .next-btn, .skip-btn, .hint-btn { 
            border: none; 
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer; 
            font-size: 1rem;
            font-weight: 600;
            margin-top: 20px; 
            text-decoration: none; 
            display: inline-block; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover, .next-btn:hover, .skip-btn:hover, .hint-btn:hover,
        .start-btn:hover, .restart-btn:hover, .send-report-btn:hover, 
        .print-btn:hover, .share-btn:hover, .save-report-btn:hover, 
        .continue-btn:hover, .check-btn:hover, .performance-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        
        .next-btn, .skip-btn { float: right; margin-left: 10px; }
        
        /* Gradientes nos Bot√µes */
        .next-btn { background: linear-gradient(45deg, #007bff, #0056b3); color: white; display: none; }
        .skip-btn { background: linear-gradient(45deg, #ffc107, #e0a800); color: #333; display: none; }
        .hint-btn { background: linear-gradient(45deg, #6a0dad, #510a83); color: white; float: none; }
        .hint-btn:disabled { background: #ccc; }

        .hint-text { margin-top: 15px; padding: 10px; background-color: #e9ecef; border-left: 5px solid #6c757d; border-radius: 5px; font-style: italic; display: none; white-space: pre-wrap; }

        .question-actions { display: flex; justify-content: flex-end; align-items: center; flex-wrap: wrap; margin-top: 15px; }
        
        .start-btn, .restart-btn, .send-report-btn, .print-btn, .share-btn, .save-report-btn, .continue-btn, .check-btn { 
            display: inline-block; 
            color: white; 
            border: none; 
            padding: 14px 28px; 
            border-radius: 8px;
            cursor: pointer; 
            font-size: 1rem;
            font-weight: 600;
            margin-top: 20px; 
            text-align: center; 
            text-decoration: none; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .start-btn, .continue-btn { 
            background: linear-gradient(45deg, #28a745, #218838); /* Gradiente Verde */
            animation: pulse 2s infinite; 
        }
        
        .restart-btn { 
            background: linear-gradient(45deg, #dc3545, #c82333); /* Gradiente Vermelho */
        }
        .send-report-btn { 
            background: linear-gradient(45deg, #6c757d, #5a6268); /* Gradiente Cinza */
        }
        .print-btn { 
            background: linear-gradient(45deg, #17a2b8, #117a8b); /* Gradiente Ciano */
        } 
        .share-btn { 
            background: linear-gradient(45deg, #25d366, #128C7E); /* Gradiente WhatsApp */
        }
        .share-btn img { width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; }
        .save-report-btn { 
            background: linear-gradient(45deg, #007bff, #0056b3); /* Gradiente Azul */
        }

        .results-actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        .results-card h2 { margin-bottom: 20px; }
        .results-card p { font-size: 1.1rem; line-height: 1.5; }
        .results-card .score-display { font-size: 2.2rem; font-weight: bold; color: #007bff; }

        .question-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; color: #555; }
        
        .full-report-list { margin-top: 30px; padding-top: 20px; border-top: 2px solid #ccc; }
        .full-report-list h3 { color: #007bff; }
        .report-question-item { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .report-question-item p { margin: 5px 0; }
        .report-question-item .option-item-report.correct { background-color: #d4edda; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
        .report-question-item .option-item-report.incorrect { background-color: #f8d7da; padding: 2px 5px; border-radius: 3px; font-weight: bold; }

        .classification-red { color: red; }
        .classification-blue { color: #007bff; }
        .classification-orange { color: #FFA500; font-weight: bold; animation: blink-text 1s linear infinite; }

        .performance-btn { 
            background: linear-gradient(45deg, #FFA500, #e08e00);
            color: white; 
            margin-right: auto; 
        }
        .performance-display { width: 100%; margin-top: 10px; padding: 10px; background-color: #fff3cd; border-left: 5px solid #ffc107; border-radius: 5px; font-weight: bold; color: #856404; text-align: left; }

        #fill-in-input { padding: 12px; width: 100%; border-radius: 8px; border: 2px solid #ccc; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; transition: border-color 0.2s; }
        #fill-in-input:focus { border-color: #007bff; outline: none; }
        #fill-in-input.correct { border: 2px solid #28a745; background-color: #f0fffb; }
        #fill-in-input.incorrect { border: 2px solid #dc3545; background-color: #fff5f5; }
        .check-btn { 
            background: linear-gradient(45deg, #fca311, #e69100);
            color: #14213d; 
            float: left; 
        }
        
        #drop-zone { padding: 15px 25px; border: 2px dashed #007bff; border-radius: 8px; background-color: #f8f9fa; display: inline-block; margin: 0 5px; transition: background-color 0.3s; min-width: 150px; text-align: center; font-style: italic; color: #6c757d; vertical-align: middle; }
        #drop-zone.over { background-color: #e0e9ed; }
        #drop-zone.correct { border-style: solid; border-color: #28a745; background-color: #d4edda; font-style: normal; color: #155724; }
        #drop-zone.incorrect { border-style: solid; border-color: #dc3545; background-color: #f8d7da; font-style: normal; color: #721c24; }
        
        .drag-options-wrapper { margin-top: 20px; text-align: center; }
        .drag-option { padding: 10px 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #e9ecef; cursor: move; margin: 5px; display: inline-block; user-select: none; transition: background-color 0.2s; }
        .drag-option:hover { background-color: #d1e0e6; }
        .drag-option.dragging { opacity: 0.5; }
        
        .personal-summary-item {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .personal-summary-item h4 {
            margin-top: 0;
            color: #856404;
        }
        .personal-summary-item p {
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        /* --- ESTILOS DA ABA DE CONTE√öDO (PDF) --- */
        #roteiro-content-tab, #apostila-content-tab {
            text-align: left; /* Alinhamento padr√£o */
            padding: 10px;
            line-height: 1.6;
        }
        /* Painel de Admin */
        .admin-panel {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .admin-panel h2 {
            margin-top: 0;
            color: #856404;
        }
        .admin-panel code {
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 4px;
            color: #c82333;
            font-family: monospace;
        }
        /* Vis√£o do Aluno */
        .student-content-view {
            text-align: center; /* Centraliza os bot√µes */
        }
        .student-content-view .btn {
            width: 80%; /* Bot√µes maiores */
            margin: 10px auto;
            display: block;
        }
        

        /* --- ESTILOS DO MODAL DE LEITURA --- */
        .modal-overlay {
            display: none; /* Escondido por padr√£o */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
.modal-header h2 {
            margin: 0;
            color: #007bff;
        }
        .modal-close-btn {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #333;
        }
        .btn-night-mode {
            background: #495047;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-night-mode:hover {
            background: #343a40;
        }
        .modal-body {
            /* (Alterado) Otimizado para <iframe> */
            padding: 0;
            height: 70vh; /* Altura fixa para o PDF */
            overflow: hidden; /* Iframe vai cuidar do scroll */
            line-height: 1.6;
            text-align: left;
        }
        
        /* ESTILOS DO MODO NOTURNO */
        .modal-content.night-mode {
            background-color: #2c2c2c; /* Fundo escuro */
            color: #f1f1f1; /* Texto claro */
            border-color: #555;
        }
        .modal-content.night-mode .modal-header { border-bottom-color: #555; }
        .modal-content.night-mode .modal-header h2 { color: #58a6ff; } /* Azul claro */
        .modal-content.night-mode .modal-close-btn { color: #999; }
        .modal-content.night-mode .modal-close-btn:hover { color: #f1f1f1; }
        

        /* --- Anima√ß√µes --- */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); } 50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5); } 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); } }
        @keyframes blink-text { 50% { opacity: 0; } }

        
        /* --- Estilos de Impress√£o --- */
        @media print { 
            body { background-color: #fff; padding-top: 0; display: block; }
            .container { box-shadow: none; border: none; width: 100%; max-width: none; }
            
            .tab-buttons, #intro-card, #question-card, #vocab-quiz-card, #roteiro-content-tab, #apostila-content-tab, .results-actions, .progress-bar-container, .question-header { 
                display: none !important; 
            }
            #results-card { display: block !important; }
            .modal-overlay { display: none !important; } /* Esconde modal na impress√£o */
            
            .full-report-list { 
                border-top: 1px solid #ccc; 
                padding-top: 10px; 
            }
            .report-question-item { page-break-inside: avoid; border: 1px solid #ddd; }
            
            #print-personal-btn {
                display: none !important;
            }
        }
        
        /* --- Ajustes para Celular --- */
        @media (max-width: 600px) {
            body {
                padding-top: 15px; 
            }

            .container {
                width: 95%; 
                padding: 15px; 
                min-height: 0; 
            }

            h1 { font-size: 2.2rem; }
            h2 { font-size: 1.3rem; }
            
            .tab-buttons {
                padding: 3px;
                gap: 5px; /* Espa√ßamento menor no celular */
            }
            .tab-buttons button {
                padding: 10px 5px;
                font-size: 0.8rem;
                flex-basis: 100px; /* Permite 3 bot√µes por linha */
            }

            .question-text { font-size: 1.1rem; }
            .translate-btn { font-size: 2.0rem; padding-left: 10px; }
            .option-item { padding: 12px; }
            .btn, .next-btn, .skip-btn, .hint-btn, .check-btn { padding: 14px 20px; font-size: 1rem; }
            
            .question-actions { flex-direction: column; align-items: stretch; }

            .next-btn, .skip-btn { float: none; width: 100%; margin-left: 0; margin-top: 10px; box-sizing: border-box; }
            .check-btn { float: none; width: 100%; margin-top: 10px; box-sizing: border-box; }

            #performance-btn, #summary-button, #hint-button { width: 100%; margin-top: 10px; box-sizing: border-box; }
            #performance-btn { margin-right: 0; order: 3; }
            #summary-button { order: 2; }
            #hint-button { order: 1; }
            
            .results-actions { flex-direction: column; gap: 10px; }
            .results-actions .btn, .results-actions .send-report-btn, .results-actions .restart-btn, .results-actions .share-btn { width: 100%; margin: 5px 0; box-sizing: border-box; }

            .audio-play-btn { width: 100%; }
            #fill-in-input { width: 100%; margin-bottom: 10px; }
            
            #drop-zone { display: block; margin: 10px 0; min-width: 0; }
            .drag-options-wrapper { margin-top: 15px; }
            .drag-option { display: block; margin: 8px 0; }
            
            /* Ajustes do Modal para Celular */
            .modal-content { width: 95%; max-height: 90vh; padding: 20px 15px; }
            .modal-header { flex-direction: column; gap: 10px; }
            .modal-header h2 { font-size: 1.4rem; }
            .modal-close-btn { position: absolute; top: 10px; right: 15px; }
            
            /* Ajuste Painel Admin */
            .admin-panel { padding: 10px; }
            .admin-panel ol { padding-left: 20px; }
        }
        
    </style>
</head>
<body>

    <div class="container">
        
        <h1>AVALIA√á√ÉO DO 4¬∫ BIMESTRE!!!</h1>

        <div class="tab-buttons">
            <button class="tablinks tab-inicio" onclick="showCard('intro-card', this)">In√≠cio</button>
            <button class="tablinks tab-quiz-g" onclick="checkLoginAndShow('question-card', this)">Quiz - Grammar</button> <button class="tablinks tab-quiz-v" onclick="startVocabQuiz(this)">Quiz - Vocabulary</button> <button class="tablinks tab-roteiro" onclick="checkLoginAndShow('roteiro-content-tab', this)">Roteiro de Estudos</button> <button class="tablinks tab-apostila" onclick="checkLoginAndShow('apostila-content-tab', this)">Apostila Conclu√≠da</button> <button id="results-tab-btn" class="tablinks tab-resultados" onclick="checkLoginAndShowResults('results-card', this)">Resultados</button> </div>


        <div id="intro-card" class="intro-card">
            <h2>English Grammar and Vocabulary Quiz</h2> 
            <p id="personalized-welcome" style="font-size: 1.2rem; font-weight: bold; margin-top: 10px; display: none; color: #dc3545;">Seja bem-vindo(a) e boa sorte!</p>
            <p id="quiz-description">Por favor, insira seu c√≥digo de acesso para iniciar o teste. Ele tem 40 quest√µes. Voc√™ tem tentativas <span id="intro-attempts-left">ilimitadas</span> para fazer este teste.</p>
            <input type="text" id="student-code" placeholder="Your Access Code!">
            <div id="start-actions">
                <button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>
            </div>
        </div>

        <div id="question-card" class="question-card">
<h2 style="text-align:center; color:#0056b3; margin-bottom:20px;">Quiz - Grammar</h2>
            <div id="progress-bar-container" class="progress-bar-container">
                <div id="progress-bar" class="progress-bar">0%</div>
            </div>
            <div class="question-header">
                <span class="question-counter"><span id="current-question-num">1</span> de 40</span>
                <span class="attempts-counter" style="display: none;">Tentativas restantes: <span id="attempts-left">Ilimitadas</span></span>
            </div>
            
            <div id="audio-container" class="audio-container"></div>
            
            <div class="question-text-wrapper">
                <div id="question-text" class="question-text"></div>
                <button id="translate-button" class="translate-btn" title="Traduzir Quest√£o">üåê</button>
            </div>
            <div id="translation-display" class="translation-text"></div>
            
            <div id="audio-play-container"></div> 
            
            <div id="options-list" class="options-list"></div>
            <div id="justification-container"></div>
            <div id="hint-container" style="margin-top: 15px;">
                <button id="hint-button" class="btn hint-btn">Dica</button>
                <div id="hint-text" class="hint-text"></div>
                <div id="summary-text" class="hint-text" style="border-left-color: #28a745;"></div>
            </div>
            <div class="question-actions">
                 <button id="performance-btn" class="btn performance-btn">DESEMPENHO</button>
                <button id="summary-button" class="start-btn" style="background-color: #28a745; display: none;">Resumo</button>
                <button id="skip-button" class="btn skip-btn">Pular Quest√£o</button>
                <button id="next-button" class="btn next-btn">Pr√≥xima Quest√£o</button>
                <div id="performance-display" class="performance-display" style="display: none; width: 100%; flex-basis: 100%; margin-top: 10px;"></div>
            </div>
        </div>
        
        <div id="vocab-quiz-card" class="question-card">
            <h2 style="color: #155724; text-align: center;">Quiz - Vocabulary</h2>
            
            <div id="vocab-progress-bar-container" class="progress-bar-container">
                <div id="vocab-progress-bar" class="progress-bar" style="width: 0%; background: linear-gradient(90deg, #155724, #28a745);">0%</div>
            </div>
            <div class="question-header">
                <span class="question-counter"><span id="vocab-current-question-num">1</span> de 20</span>
                <span class="attempts-counter" style="display: none;">Tentativas: <span id="vocab-attempts-left">Ilimitadas</span></span>
            </div>
            <div id="vocab-audio-play-container"></div>
            <div id="vocab-audio-container" class="audio-container"></div>
            <div class="question-text-wrapper">
                <div id="vocab-question-text" class="question-text">
                    As perguntas do quiz de vocabul√°rio aparecer√£o aqui.
                </div>
                <button id="vocab-translate-button" class="translate-btn" title="Traduzir Quest√£o">üåê</button>
            </div>
            <div id="vocab-translation-display" class="translation-text"></div>
            <div id="vocab-options-list" class="options-list">
                </div>
            <div id="vocab-justification-container"></div>
            <div id="vocab-hint-container" style="margin-top: 15px;">
                <button id="vocab-hint-button" class="btn hint-btn">Dica</button>
                <div id="vocab-hint-text" class="hint-text"></div>
                <div id="vocab-summary-text" class="hint-text" style="border-left-color: #28a745;"></div>
            </div>
            <div class="question-actions">
                 <button id="vocab-performance-btn" class="btn performance-btn">DESEMPENHO</button>
                <button id="vocab-summary-button" class="start-btn" style="background-color: #28a745; display: none;">Resumo</button>
                <button id="vocab-skip-button" class="btn skip-btn">Pular Quest√£o</button>
                <button id="vocab-next-button" class="btn next-btn">Pr√≥xima Quest√£o</button>
                <div id="vocab-performance-display" class="performance-display" style="display: none; width: 100%; flex-basis: 100%; margin-top: 10px;"></div>
            </div>
        </div>
        <div id="results-card" class="results-card">
            <h1>Relat√≥rio Final</h1>
            <p><strong>Nome:</strong> <span id="report-student-name"></span></p>
            <p><strong>C√≥digo de Acesso:</strong> <span id="report-student-code"></span></p>
            <p><strong>Pontua√ß√£o:</strong> <span id="score-display" class="score-display"></span></p>
            <p><strong>Percentual de Acerto:</strong> <span id="percentage-display"></span></p>
            <p><strong>Classifica√ß√£o:</strong> <span id="classification-display"></span></p>
            <div class="results-actions">
                <a id="send-report-link" class="send-report-btn" href="#" target="_blank">Enviar Relat√≥rio ao Professor</a>
                <button class="restart-btn" onclick="quizApp.restartQuiz()">Reiniciar Teste</button>
                <a id="share-whatsapp" class="share-btn" href="#" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"> Compartilhar
                </a>
                <button class="btn save-report-btn" onclick="quizApp.saveReport()">Salvar Relat√≥rio</button>
                <button class="btn print-btn" onclick="quizApp.printReport()">Imprimir Relat√≥rio Detalhado</button>
                <button class="btn skip-btn" style="float: none; display: inline-block;" onclick="quizApp.printPersonalReport()">Imprimir Resumo Pessoal</button>
            </div>
            <div id="full-report-container" class="full-report-list" style="display: none;"></div>
            <div id="personal-report-container" class="full-report-list" style="display: none; border-top: 2px solid #ffc107; margin-top: 20px;"></div>
        </div>

        <div id="roteiro-content-tab" class="tabcontent" style="text-align: left; display: none;">
            
            <div id="admin-panel-roteiro" class="admin-panel" style="display: none;">
                <h2>Painel do Professor (Roteiro)</h2>
                <p>Ol√°, Professor! Como voc√™ est√° logado, esta √© sua √°rea de administra√ß√£o.</p>
                <p><strong>Link do PDF (Roteiro de Estudos):</strong></p>
                <ol style="line-height: 1.6; padding-left: 30px;">
                    <li>Procure a linha de c√≥digo (perto da tag <code>&lt;script&gt;</code>) que diz: <code>const PDF_LINK_ROTEIRO = '...';</code></li>
                    <li>Cole o link do seu PDF (hospedado no Google Drive, etc.) dentro das aspas.</li>
                </ol>
                <p>O link atual √©: <code id="current-pdf-link-roteiro" style="font-weight: bold; color: #dc3545;"></code></p>
                <hr style="margin: 20px 0;">
            </div>
            
            <div id="student-content-view-roteiro" class="student-content-view">
                <h2 style="text-align: center;">Roteiro de Estudos</h2>
                <p style="text-align: center;">Acesse o material de revis√£o em PDF usando os bot√µes abaixo.</p>
                <div id="content-buttons-roteiro">
                    </div>
            </div>
        </div>
        
        <div id="apostila-content-tab" class="tabcontent" style="text-align: left; display: none;">
            
            <div id="admin-panel-apostila" class="admin-panel" style="display: none;">
                <h2>Painel do Professor (Apostila)</h2>
                <p><strong>Link do PDF (Apostila Conclu√≠da):</strong></p>
                <ol style="line-height: 1.6; padding-left: 30px;">
                    <li>Procure a linha de c√≥digo (perto da tag <code>&lt;script&gt;</code>) que diz: <code>const PDF_LINK_APOSTILA = '...';</code></li>
                    <li>Cole o link do seu PDF (hospedado no Google Drive, etc.) dentro das aspas.</li>
                </ol>
                <p>O link atual √©: <code id="current-pdf-link-apostila" style="font-weight: bold; color: #dc3545;"></code></p>
                <hr style="margin: 20px 0;">
            </div>
            
            <div id="student-content-view-apostila" class="student-content-view">
                <h2 style="text-align: center;">Apostila Conclu√≠da</h2>
                <p style="text-align: center;">Acesse a apostila completa em PDF usando os bot√µes abaixo.</p>
                <div id="content-buttons-apostila">
                    </div>
            </div>
        </div>

    </div>
    
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Material de Estudo</h2>
                <button id="night-mode-toggle" class="btn-night-mode">Modo Noturno üåô</button>
                <span id="modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div id="modal-body" class="modal-body">
                </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>

    <script>
        // --------------------------------------------------------------------
// (CSS INJETADO PARA ESTILOS DE ARRASTAR E SOLTAR RESPONSIVOS)
// --------------------------------------------------------------------
const style = document.createElement('style');
style.textContent = `
    /* Estilos para Drag-and-Drop (Arrastar e Soltar) */
    .drag-options-wrapper {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 20px;
        gap: 10px;
    }
    .drag-option {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px 15px;
        cursor: grab;
        font-weight: bold;
        transition: transform 0.1s, box-shadow 0.1s;
        touch-action: none; /* Essencial para celular */
    }
    .drag-option:active {
        cursor: grabbing;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    #drop-zone {
        background-color: #e9ecef;
        border: 2px dashed #007bff;
        padding: 5px 15px;
        min-width: 150px;
        display: inline-block;
        text-align: center;
        color: #6c757d;
        border-radius: 5px;
    }
    #drop-zone.over {
        background-color: #cfe2ff;
        border-color: #0056b3;
    }
    #drop-zone.correct {
        background-color: #d4edda;
        border-color: #28a745;
        color: #155724;
    }
    #drop-zone.incorrect {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
    }

    /* Otimiza√ß√£o para Mobile (Tela pequena) */
    @media (max-width: 600px) {
        .drag-options-wrapper {
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .drag-option {
            width: 80%; /* Ocupa mais espa√ßo para facilitar o toque */
            text-align: center;
        }
        .question-content {
             /* Permite que o texto se quebre adequadamente em telas pequenas */
            display: block !important; 
            text-align: left;
        }
    }
`;
document.head.appendChild(style);

// --------------------------------------------------------------------
// LINKS DOS PDFs - O PROFESSOR (JR123) DEVE COLAR OS LINKS AQUI
// (Links do 1¬∫ Ano M√©dio)
// --------------------------------------------------------------------
const PDF_LINK_ROTEIRO = 'https://drive.google.com/file/d/1fnCzAMruc4CqFpr8fc-eAw8YDXDb0MFY/preview';  
const PDF_LINK_APOSTILA = 'https://drive.google.com/file/d/1fnCzAMruc4CqFpr8fc-eAw8YDXDb0MFY/preview';   
// --------------------------------------------------------------------


// --- FUN√á√ÉO DE NAVEGA√á√ÉO POR ABAS ---
function showCard(cardId, element) {
    const validIds = ['intro-card', 'question-card', 'vocab-quiz-card', 'results-card', 'roteiro-content-tab', 'apostila-content-tab'];
    
    validIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
    const buttons = document.querySelectorAll('.tablinks');
    buttons.forEach(btn => btn.classList.remove('active'));

    const card = document.getElementById(cardId);
    if (card) {
        if (['intro-card', 'question-card', 'vocab-quiz-card', 'results-card'].includes(cardId)) {
            card.style.display = 'flex';
            card.style.flexDirection = 'column';
        } else {
            card.style.display = 'block';
        }
    }
    if (element) {
        element.classList.add('active');
    } else {
        const firstBtn = document.querySelector('.tablinks');
        if (firstBtn) firstBtn.classList.add('active');
    }
}

// --- L√ìGICA DO PDF DO ROTEIRO DE ESTUDOS ---
function setupAdminViewRoteiro(isAdmin) {
    const adminPanel = document.getElementById('admin-panel-roteiro');
    const studentView = document.getElementById('student-content-view-roteiro');
    const contentButtons = document.getElementById('content-buttons-roteiro');
    const currentPdfLinkEl = document.getElementById('current-pdf-link-roteiro');

    if (adminPanel) adminPanel.style.display = isAdmin ? 'block' : 'none';
    if (currentPdfLinkEl) currentPdfLinkEl.textContent = PDF_LINK_ROTEIRO || "(Nenhum link definido)";

    if (studentView) studentView.style.display = 'block';
    if (contentButtons) contentButtons.innerHTML = ''; 
    
    if (contentButtons) {
        if (PDF_LINK_ROTEIRO && PDF_LINK_ROTEIRO !== 'COLE_O_LINK_DO_ROTEIRO_AQUI') {
            const readBtn = document.createElement('button');
            readBtn.className = 'btn save-report-btn'; 
            readBtn.innerHTML = 'Ler Roteiro Online üìñ';
            readBtn.onclick = () => openReadModal(PDF_LINK_ROTEIRO, 'Roteiro de Estudos'); 
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn start-btn'; 
            downloadBtn.innerHTML = 'Baixar Roteiro üíæ';
            downloadBtn.onclick = () => downloadContent(PDF_LINK_ROTEIRO); 
            
            contentButtons.appendChild(readBtn);
            contentButtons.appendChild(downloadBtn);
        } else {
            contentButtons.innerHTML = '<p style="text-align: center; font-weight: bold; color: #dc3545;">Nenhum roteiro em PDF foi carregado pelo professor ainda.</p>';
        }
    }
}

// --- L√ìGICA DO PDF DA APOSTILA CONCLU√çDA ---
function setupAdminViewApostila(isAdmin) {
    const adminPanel = document.getElementById('admin-panel-apostila');
    const studentView = document.getElementById('student-content-view-apostila');
    const contentButtons = document.getElementById('content-buttons-apostila');
    const currentPdfLinkEl = document.getElementById('current-pdf-link-apostila');

    if (adminPanel) adminPanel.style.display = isAdmin ? 'block' : 'none';
    if (currentPdfLinkEl) currentPdfLinkEl.textContent = PDF_LINK_APOSTILA || "(Nenhum link definido)";

    if (studentView) studentView.style.display = 'block';
    if (contentButtons) contentButtons.innerHTML = ''; 
    
    if (contentButtons) {
        if (PDF_LINK_APOSTILA && PDF_LINK_APOSTILA !== 'COLE_O_LINK_DA_APOSTILA_AQUI') {
            const readBtn = document.createElement('button');
            readBtn.className = 'btn save-report-btn'; 
            readBtn.innerHTML = 'Ler Apostila Online üìñ'; 
            readBtn.onclick = () => openReadModal(PDF_LINK_APOSTILA, 'Apostila Conclu√≠da'); 
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn start-btn'; 
            downloadBtn.innerHTML = 'Baixar Apostila üíæ'; 
            downloadBtn.onclick = () => downloadContent(PDF_LINK_APOSTILA); 
            
            contentButtons.appendChild(readBtn);
            contentButtons.appendChild(downloadBtn);
        } else {
            contentButtons.innerHTML = '<p style="text-align: center; font-weight: bold; color: #dc3545;">Nenhuma apostila em PDF foi carregada pelo professor ainda.</p>';
        }
    }
}

// --------------------------------------------------------------------
// FUN√á√ïES DE VERIFICA√á√ÉO DE LOGIN DAS ABAS (MANTIDAS)
// --------------------------------------------------------------------

function checkLoginAndShow(cardId, element) {
    if (!quizApp.validatedStudentCode) {
        alert('Por favor, fa√ßa o login na aba "In√≠cio" primeiro!');
        showCard('intro-card', document.querySelector('.tab-inicio'));
        return;
    }
    showCard(cardId, element);
}

function checkLoginAndShowResults(cardId, element) {
    if (!quizApp.validatedStudentCode) {
        alert('Por favor, fa√ßa o login na aba "In√≠cio" primeiro!');
        showCard('intro-card', document.querySelector('.tab-inicio'));
        return;
    }

    const code = quizApp.validatedStudentCode;
    const grammarReportJSON = localStorage.getItem(`quizReport_${code}`);
    const vocabReportJSON = localStorage.getItem(`vocabQuizReport_${code}`);

    if (grammarReportJSON) {
        quizApp.retrieveReport(code);
    } else if (vocabReportJSON) {
        vocabQuizApp.retrieveReport(code);
    } else {
        alert("Voc√™ ainda n√£o completou nenhum quiz para ver os resultados. Termine um quiz primeiro!");
        showCard('intro-card', document.querySelector('.tab-inicio'));
    }
}

// --------------------------------------------------------------------
// NOVO BLOCO DE QUEST√ïES E L√ìGICA DO QUIZ DE VOCABUL√ÅRIO (1¬∫ M√©dio)
// --------------------------------------------------------------------

const vocabQuestions = [
    // --- 4 Quest√µes de M√∫ltipla Escolha (MCQ) - Vocabul√°rio ---
    {
      type: 'mcq',
      question: '1. Qual termo √© frequentemente usado para indicar uma a√ß√£o do presente cont√≠nuo?',
      topic: "Time Expressions",
      hint: "DICA 1: A tradu√ß√£o √© 'agora'.",
      hint_2: "DICA 2: N__.",
      options: [
        { "text": "Yesterday", "isCorrect": false, "rationale": "Incorreto. Usado no passado." },
        { "text": "Now", "isCorrect": true, "rationale": "Correto. Now (agora) indica uma a√ß√£o em progresso no presente." },
        { "text": "Tomorrow", "isCorrect": false, "rationale": "Incorreto. Usado no futuro." },
        { "text": "If", "isCorrect": false, "rationale": "Incorreto. √â uma conjun√ß√£o condicional." }
      ]
    },
    {
      type: 'mcq',
      question: '2. Qual auxiliar √© usado com \'were\' para formar o passado cont√≠nuo?',
      topic: "Auxiliary Verbs",
      hint: "DICA 1: O verbo principal sempre tem termina√ß√£o I__.",
      hint_2: "DICA 2: -ING.",
      options: [
        { "text": "to", "isCorrect": false, "rationale": "Incorreto. N√£o √© usado no cont√≠nuo." },
        { "text": "verb base form", "isCorrect": false, "rationale": "Incorreto. O verbo deve estar no ger√∫ndio." },
        { "text": "verb with -ing", "isCorrect": true, "rationale": "Correto. Todos os tempos cont√≠nuos usam o ger√∫ndio (-ing)." },
        { "text": "has", "isCorrect": false, "rationale": "Incorreto. Usado no present perfect." }
      ]
    },
    {
      type: 'mcq',
      question: '3. A palavra "if" (se) √© frequentemente usada em qual tempo cont√≠nuo para expressar condi√ß√£o?',
      topic: "Connectors",
      hint: "DICA 1: Pense em a√ß√µes hipot√©ticas.",
      hint_2: "DICA 2: C____________.",
      options: [
        { "text": "Present continuous", "isCorrect": false, "rationale": "Incorreto. O presente cont√≠nuo n√£o √© usado para condi√ß√µes." },
        { "text": "Past continuous", "isCorrect": false, "rationale": "Incorreto. O passado cont√≠nuo descreve a√ß√µes passadas em andamento." },
        { "text": "Future continuous", "isCorrect": false, "rationale": "Incorreto. O futuro cont√≠nuo descreve a√ß√µes futuras em andamento." },
        { "text": "Conditional continuous", "isCorrect": true, "rationale": "Correto. O conditional continuous (would be + -ing) √© frequentemente ligado a uma ora√ß√£o com IF." }
      ]
    },
    {
      type: 'mcq',
      question: '4. Qual das op√ß√µes √© um adjetivo de tempo (auxiliar) do futuro cont√≠nuo?',
      topic: "Auxiliary Verbs",
      hint: "DICA 1: Futuro + Cont√≠nuo.",
      hint_2: "DICA 2: W___ B__.",
      options: [
        { "text": "was", "isCorrect": false, "rationale": "Incorreto. √â auxiliar do passado cont√≠nuo." },
        { "text": "would", "isCorrect": false, "rationale": "Incorreto. √â auxiliar do condicional (would be)." },
        { "text": "will be", "isCorrect": true, "rationale": "Correto. Will be √© usado para formar o future continuous." },
        { "text": "am", "isCorrect": false, "rationale": "Incorreto. √â auxiliar do presente cont√≠nuo." }
      ]
    },

    // --- 4 Quest√µes de Preenchimento de Lacunas (Fill-in) - Vocabul√°rio ---
    {
      type: 'fill-in',
      question: '5. O adv√©rbio que significa \'enquanto\' e √© frequentemente usado para ligar duas a√ß√µes simult√¢neas no passado cont√≠nuo √© ______.',
      topic: "Connectors",
      hint: "DICA 1: W____.",
      hint_2: "DICA 2: Ocorre ao mesmo tempo.",
      answer: ["WHILE"],
      rationale: "Correto. While (enquanto) liga duas a√ß√µes simult√¢neas, frequentemente no passado cont√≠nuo."
    },
    {
      type: 'fill-in',
      question: '6. Qual auxiliar do \'to be\' √© usado para o presente cont√≠nuo com o pronome \'She\'? (Use apenas o auxiliar)',
      topic: "Auxiliary Verbs",
      hint: "DICA 1: S__ I__.",
      hint_2: "DICA 2: 2 letras.",
      answer: ["IS"],
      rationale: "Correto. She is, He is, It is no presente cont√≠nuo."
    },
    {
      type: 'fill-in',
      question: '7. Para descrever uma a√ß√£o que estava em andamento no passado cont√≠nuo, a estrutura frequentemente inclui uma hora espec√≠fica no passado, como "yesterday at ______".',
      topic: "Time Expressions",
      hint: "DICA 1: Espec√≠fica a hora.",
      hint_2: "DICA 2: 8 P__.",
      answer: ["8PM", "8 PM", "EIGHT PM"],
      rationale: "Correto. Uma hora espec√≠fica como 8 PM indica o foco do past continuous."
    },
    {
      type: 'fill-in',
      question: '8. Qual auxiliar do \'to be\' √© usado para o past continuous com o pronome \'You\'? (Use apenas o auxiliar)',
      topic: "Auxiliary Verbs",
      hint: "DICA 1: Y__ W____.",
      hint_2: "DICA 2: Come√ßa com W.",
      answer: ["WERE"],
      rationale: "Correto. You were, We were, They were no past continuous."
    },

    // --- 4 Quest√µes de √Åudio (Audio_MCQ) - Vocabul√°rio (Foco em Tense Markers) ---
    {
      type: 'audio_mcq',
      audioSrc: 'https://files.catbox.moe/glyov3.mp3', // Placeholder audio link ok
      question: '9. Ou√ßa a frase: "We are watching TV **now**". Qual adv√©rbio indica que a a√ß√£o est√° ocorrendo no momento da fala?',
      topic: "Time Expressions",
      hint: "DICA 1: Indica o presente cont√≠nuo.",
      hint_2: "DICA 2: N__.",
      options: [
        { "text": "watching", "isCorrect": false, "rationale": "Incorreto. √â o verbo, n√£o o marcador de tempo." },
        { "text": "are", "isCorrect": false, "rationale": "Incorreto. √â o auxiliar." },
        { "text": "now", "isCorrect": true, "rationale": "Correto. Now (agora) √© o principal marcador de tempo do present continuous." },
        { "text": "TV", "isCorrect": false, "rationale": "Incorreto. √â o complemento." }
      ]
    },
    {
      type: 'audio_mcq',
      audioSrc: 'https://files.catbox.moe/hrbz2i.mp3', // Placeholder audio link ok
      question: '10. Ou√ßa a frase: "I **will be** traveling tomorrow." Qual a express√£o de futuro que forma o auxiliar?',
      topic: "Auxiliary Verbs",
      hint: "DICA 1: Verbo modal + To Be.",
      hint_2: "DICA 2: W___ B__.",
      options: [
        { "text": "traveling", "isCorrect": false, "rationale": "Incorreto. √â o verbo principal." },
        { "text": "will be", "isCorrect": true, "rationale": "Correto. Will be √© o auxiliar do future continuous." },
        { "text": "tomorrow", "isCorrect": false, "rationale": "Incorreto. √â o marcador de tempo." },
        { "text": "I", "isCorrect": false, "rationale": "Incorreto. √â o sujeito." }
      ]
    },
    {
      type: 'audio_mcq',
      audioSrc: 'https://files.catbox.moe/ix3rz5.mp3', // Placeholder audio link ok
      question: '11. Ou√ßa a frase: "She **would be** studying if the library were open." Qual palavra torna o verbo \'to be\' condicional?',
      topic: "Auxiliary Verbs",
      hint: "DICA 1: A forma abreviada √© 'd be.",
      hint_2: "DICA 2: W____.",
      options: [
        { "text": "be", "isCorrect": false, "rationale": "Incorreto. Be √© o infinitivo do verbo To Be." },
        { "text": "studying", "isCorrect": false, "rationale": "Incorreto. √â o ger√∫ndio." },
        { "text": "would", "isCorrect": true, "rationale": "Correto. Would √© o modal que transforma o verbo na forma condicional." },
        { "text": "if", "isCorrect": false, "rationale": "Incorreto. If √© a conjun√ß√£o condicional." }
      ]
    },
    {
      type: 'audio_mcq',
      audioSrc: 'https://files.catbox.moe/z9iz5z.mp3', // Placeholder audio link ok
      question: '12. Ou√ßa a frase: "I **was** eating dinner." Qual auxiliar indica que a a√ß√£o estava ocorrendo no passado cont√≠nuo?',
      topic: "Auxiliary Verbs",
      hint: "DICA 1: Verbo To Be no passado para a primeira pessoa.",
      hint_2: "DICA 2: W__.",
      options: [
        { "text": "eating", "isCorrect": false, "rationale": "Incorreto. √â o verbo principal." },
        { "text": "dinner", "isCorrect": false, "rationale": "Incorreto. √â o complemento." },
        { "text": "was", "isCorrect": true, "rationale": "Correto. Was √© o auxiliar do past continuous para I/He/She/It." },
        { "text": "were", "isCorrect": false, "rationale": "Incorreto. Were √© para You/We/They." }
      ]
    },

    // --- 4 Quest√µes de Verdadeiro/Falso (T/F) - Vocabul√°rio ---
    {
      type: 'tf',
      question: '13. A express√£o "last night" √© o principal marcador de tempo para o presente cont√≠nuo.',
      topic: "Time Expressions",
      hint: "DICA 1: A tradu√ß√£o √© 'ontem √† noite'.",
      options: [
        { "text": "Verdadeiro", "isCorrect": false, "rationale": "Falso. Last night √© usado para o simple past ou past continuous, n√£o para o present continuous." },
        { "text": "Falso", "isCorrect": true, "rationale": "Correto." }
      ],
      answer: false
    },
    {
      type: 'tf',
      question: '14. Na forma negativa, o "not" √© colocado entre o auxiliar e o verbo principal (ex: will not be studying).',
      topic: "Auxiliary Verbs",
      hint: "DICA 1: Verifique a regra de nega√ß√£o para o futuro cont√≠nuo.",
      options: [
        { "text": "Verdadeiro", "isCorrect": true, "rationale": "Correto. No futuro cont√≠nuo, 'not' vai entre 'will' e 'be'." },
        { "text": "Falso", "isCorrect": false, "rationale": "Incorreto." }
      ],
      answer: true
    },
    {
      type: 'tf',
      question: '15. O termo "if i had a job" √© uma condi√ß√£o t√≠pica usada com o conditional continuous.',
      topic: "Connectors",
      hint: "DICA 1: A frase se encaixa na estrutura de 'a√ß√µes hipot√©ticas'.",
      options: [
        { "text": "Verdadeiro", "isCorrect": true, "rationale": "Correto. √â o tipo de condi√ß√£o (second conditional) que liga √† a√ß√£o hipot√©tica do conditional continuous." },
        { "text": "Falso", "isCorrect": false, "rationale": "Incorreto." }
      ],
      answer: true
    },
    {
      type: 'tf',
      question: '16. O auxiliar "is" √© usado no past continuous.',
      topic: "Auxiliary Verbs",
      hint: "DICA 1: 'Is' √© uma forma do 'To be' no presente.",
      options: [
        { "text": "Verdadeiro", "isCorrect": false, "rationale": "Falso. O past continuous usa 'was' ou 'were'." },
        { "text": "Falso", "isCorrect": true, "rationale": "Correto." }
      ],
      answer: false
    },

    // --- 4 Quest√µes de Arrastar e Soltar (Drag-drop) - Vocabul√°rio ---
    {
      type: 'drag-drop',
      question: '17. A express√£o "yesterday at 8pm" √© um marcador de tempo para o tempo verbal: ______',
      topic: "Time Expressions",
      hint: "DICA 1: A√ß√£o em andamento no passado.",
      options: ["PRESENT CONTINUOUS", "PAST CONTINUOUS", "FUTURE CONTINUOUS"],
      answer: "PAST CONTINUOUS",
      rationale: "Correto. Past continuous descreve uma a√ß√£o que estava acontecendo em um momento espec√≠fico do passado."
    },
    {
      type: 'drag-drop',
      question: '18. O auxiliar "would be" √© usado para o tempo verbal: ______',
      topic: "Auxiliary Verbs",
      hint: "DICA 1: Pense em \'se eu pudesse...\'.",
      options: ["PRESENT CONTINUOUS", "CONDITIONAL CONTINUOUS", "FUTURE CONTINUOUS"],
      answer: "CONDITIONAL CONTINUOUS",
      rationale: "Correto. Would be √© o auxiliar do conditional continuous (a√ß√µes hipot√©ticas)."
    },
    {
      type: 'drag-drop',
      question: '19. O marcador de tempo "tomorrow" √© um indicador para o tempo verbal: ______',
      topic: "Time Expressions",
      hint: "DICA 1: A√ß√£o em andamento no futuro.",
      options: ["PRESENT CONTINUOUS", "PAST CONTINUOUS", "FUTURE CONTINUOUS"],
      answer: "FUTURE CONTINUOUS",
      rationale: "Correto. Tomorrow (amanh√£) √© um marcador chave para o future continuous."
    },
    {
      type: 'drag-drop',
      question: '20. O auxiliar "am" √© usado com a forma em -ing para o tempo verbal: ______',
      topic: "Auxiliary Verbs",
      hint: "DICA 1: A√ß√£o em andamento agora.",
      options: ["PRESENT CONTINUOUS", "PAST CONTINUOUS", "CONDITIONAL CONTINUOUS"],
      answer: "PRESENT CONTINUOUS",
      rationale: "Correto. Am, is, are s√£o os auxiliares do present continuous."
    }
];

const vocabSummaries = {
    "Time Expressions": "Marcadores de tempo indicam o tempo verbal. NOW (agora) para o presente cont√≠nuo. Express√µes com horas espec√≠ficas no passado (e.g., YESTERDAY AT 8PM) para o passado cont√≠nuo. TOMORROW (amanh√£) para o futuro cont√≠nuo.",
    "Auxiliary Verbs": "A estrutura de todos os tempos cont√≠nuos √©: Auxiliar do To be + verbo com -ING. Presente: am/is/are. Passado: was/were. Futuro: will be. Condicional: would be.",
    "Connectors": "Conectores como IF (se) introduzem condi√ß√µes para o conditional continuous. WHILE (enquanto) √© usado para a√ß√µes simult√¢neas, frequentemente no past continuous."
};

function startVocabQuiz(element) {
    if (!quizApp.validatedStudentCode) {
        alert('Por favor, fa√ßa o login na aba "In√≠cio" primeiro!');
        showCard('intro-card', document.querySelector('.tab-inicio'));
        return;
    }
    
    // Passa a informa√ß√£o do aluno para o quiz de vocabul√°rio
    vocabQuizApp.validatedStudentName = quizApp.validatedStudentName;
    vocabQuizApp.validatedStudentCode = quizApp.validatedStudentCode;
    
    // Mostra o card e inicia o quiz de vocabul√°rio
    showCard('vocab-quiz-card', element);
    vocabQuizApp.startQuiz(false); // 'false' para sempre reiniciar
}

// --- L√ìGICA PRINCIPAL DO QUIZ DE GRAM√ÅTICA (1¬∫ M√©dio) ---
const quizApp = {
    APP_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwtDAlCCBcc3cN3pHX5YTkCZBsYTH--UJbeaczv64av_vIkybVIaEs-nTLKM2ssHND2/exec',
    currentQuestionIndex: 0,
    score: 0,
    userAnswers: {},
    validatedStudentName: '',
    validatedStudentCode: '',
    totalAttempts: "Ilimitadas",
    skippedQuestions: [],
    currentSkippedIndex: 0,
    shuffledQuestions: [],
    hintLevel: 0, 
    
    elements: {
        studentCodeInput: document.getElementById('student-code'),
        introCard: document.getElementById('intro-card'),
        quizCard: document.getElementById('question-card'),
        resultsCard: document.getElementById('results-card'),
        questionText: document.getElementById('question-text'),
        optionsList: document.getElementById('options-list'),
        justificationContainer: document.getElementById('justification-container'),
        nextButton: document.getElementById('next-button'),
        skipButton: document.getElementById('skip-button'),
        hintButton: document.getElementById('hint-button'),
        hintText: document.getElementById('hint-text'),
        attemptsLeftSpan: document.getElementById('attempts-left'),
        currentQuestionNumSpan: document.getElementById('current-question-num'),
        scoreDisplay: document.getElementById('score-display'),
        percentageDisplay: document.getElementById('percentage-display'),
        classificationDisplay: document.getElementById('classification-display'),
        reportStudentName: document.getElementById('report-student-name'),
        reportStudentCode: document.getElementById('report-student-code'),
        sendReportLink: document.getElementById('send-report-link'),
        introAttemptsLeftSpan: document.getElementById('intro-attempts-left'),
        fullReportContainer: document.getElementById('full-report-container'),
        shareWhatsappLink: document.getElementById('share-whatsapp'),
        personalizedWelcome: document.getElementById('personalized-welcome'),
        startActionsDiv: document.getElementById('start-actions'),
        quizDescription: document.getElementById('quiz-description'),
        summaryButton: document.getElementById('summary-button'),
        summaryText: document.getElementById('summary-text'),
        performanceButton: document.getElementById('performance-btn'),
        performanceDisplay: document.getElementById('performance-display'),
        progressBar: document.getElementById('progress-bar'),
        translateButton: document.getElementById('translate-button'),
        translationDisplay: document.getElementById('translation-display'),
        personalReportContainer: document.getElementById('personal-report-container'),
        audioContainer: document.getElementById('audio-container'),
        audioPlayContainer: document.getElementById('audio-play-container') 
    },

    studentData: {
"384DS": "DANIEL CARDOSO SAMPAIO",
"912DJ": "DAVI FRANKLIN CANDIDO BATISTA JOAQUIM",
"156DC": "DAVI XAVIER DE ALMEIDA CERQUEIRA",
"743GN": "GABRIEL MARZIONNA DO NASCIMENTO",
"298GC": "GABRIELA CAMILO CORREA",
"651HL": "HENRY LEAL LORENZO",
"427IO": "IGOR SANTESSO DE OLIVEIRA",
"839IN": "ISABEL DE CAMARGO NASCIMENTO",
"514IL": "ISABELLA ALVES LIMA",
"173KA": "KAU√É BERTONCINI ALBERTIN",
"925KO": "KAU√É CRUZ OLIVEIRA",
"368LF": "LAURA ALVES FREITAS",
"602LB": "LAURA MACEDO BUENO",
"284MB": "MANUELLA DE SOUSA BARBOSA",
"591MS": "MATHEUS PEREIRA DE SOUZA",
"847RM": "RYAN VICTOR DA SILVA MARQUES",
"136SO": "SOFIA ALVES DE OLIVEIRA", 
"JR123": "J√öNIOR"
    },
    
    summaries: { 
        "Present Continuous": "Uso: A√ß√µes que est√£o acontecendo agora. Estrutura: Sujeito + am/are/is + verbo com -ing. Nega√ß√£o: am/are/is + not + -ing. Interrogativa: Am/Are/Is + Sujeito + -ing?",
        "Past Continuous": "Uso: A√ß√µes que estavam acontecendo em determinado momento no passado. Estrutura: Sujeito + was/were + verbo com -ing. Was para I/He/She/It. Were para You/We/They.",
        "Future Continuous": "Uso: A√ß√µes que estar√£o acontecendo em um momento futuro espec√≠fico. Estrutura: Sujeito + will be + verbo com -ing. Nega√ß√£o: will not be + -ing.",
        "Conditional Continuous": "Uso: A√ß√µes que estariam acontecendo sob certas condi√ß√µes (hipot√©ticas). Estrutura: Sujeito + would be + verbo com -ing. Frequentemente ligada a uma ora√ß√£o com \'if\'."
    },

    questions: [
        // --- 5 Quest√µes de M√∫ltipla Escolha (MCQ) - Gram√°tica ---
        {
            type: 'mcq',
            question: '1. Marque a alternativa correta.',
            topic: "Present Continuous",
            hint: "DICA 1: O presente cont√≠nuo usa \'am/is/are\' + verbo com -ing.",
            hint_2: "DICA 2: I AM S______.",
            options: [
                { "text": "I am studying english now.", "isCorrect": true, "rationale": "Correto. Est√° na forma correta do present continuous: Sujeito + am + verbo com -ing + now." },
                { "text": "She was read a book last night.", "isCorrect": false, "rationale": "Incorreto. O past continuous exige o verbo principal com -ing (reading)." },
                { "text": "They will be playing soccer tomorrow.", "isCorrect": false, "rationale": "Incorreto. A√ß√µes no future continuous usam will be, mas a quest√£o original do PDF n√£o √© a correta. (A correta √© 'I am studying...')." },
                { "text": "You would be sleeping if you were tired.", "isCorrect": false, "rationale": "Incorreto. A quest√£o original do PDF n√£o est√° na forma correta. (A correta √© 'I am studying...')." }
            ]
        },
        {
            type: 'mcq',
            question: '2. Assinale a frase correta para o passado cont√≠nuo:',
            topic: "Past Continuous",
            hint: "DICA 1: O auxiliar deve ser \'was\' ou \'were\' + verbo com -ing.",
            hint_2: "DICA 2: S__ W__ S______.",
            options: [
                { "text": "They was studying math.", "isCorrect": false, "rationale": "Incorreto. \'They\' deve ser usado com \'were\', n√£o \'was\'." },
                { "text": "I were cooking dinner.", "isCorrect": false, "rationale": "Incorreto. \'I\' deve ser usado com \'was\', n√£o \'were\'." },
                { "text": "She was singing a song.", "isCorrect": true, "rationale": "Correto. \'She\' usa \'was\' + verbo com -ing." },
                { "text": "We am playing chess.", "isCorrect": false, "rationale": "Incorreto. \'We\' deve ser usado com \'are\' (presente) ou \'were\' (passado)." }
            ]
        },
        {
            type: 'mcq',
            question: '3. Marque a frase que est√° escrita de forma correta, usando o conditional continuous:',
            topic: "Conditional Continuous",
            hint: "DICA 1: Procure por \'would be\' + verbo com -ing + \'if\'.",
            hint_2: "DICA 2: I W____ B__ S______.",
            options: [
                { "text": "I would be studying if i had time.", "isCorrect": true, "rationale": "Correto. Estrutura do conditional continuous: Sujeito + would be + -ing + condi√ß√£o com simple past (had)." },
                { "text": "I will be studying if i had time.", "isCorrect": false, "rationale": "Incorreto. \'Will be\' √© para o futuro, e a condi√ß√£o \'if i had time\' exige \'would be\' na ora√ß√£o principal." },
                { "text": "I am studying if i had time.", "isCorrect": false, "rationale": "Incorreto. Mistura present continuous com condi√ß√£o no passado." },
                { "text": "I was studying if i had time.", "isCorrect": false, "rationale": "Incorreto. Mistura past continuous com condi√ß√£o." }
            ]
        },
        {
            type: 'mcq',
            question: '4. Marque o termo que est√° escrito de forma correta.',
            topic: "Tense Structure",
            hint: "DICA 1: O verbo principal sempre tem -ing em um tempo cont√≠nuo.",
            hint_2: "DICA 2: I A__ N__ L_________ T__ M______.",
            options: [
                { "text": "He will be works at the office.", "isCorrect": false, "rationale": "Incorreto. O verbo principal deve ter -ing (working)." },
                { "text": "I am not listening to music.", "isCorrect": true, "rationale": "Correto. Estrutura do present continuous negativo: am not + verbo com -ing." },
                { "text": "They was reading a book.", "isCorrect": false, "rationale": "Incorreto. \'They\' exige \'were\', n√£o \'was\'." },
                { "text": "She would be eats lunch.", "isCorrect": false, "rationale": "Incorreto. O verbo principal deve ter -ing (eating)." }
            ]
        },
        {
            type: 'mcq',
            question: '5. Marque a frase que est√° escrita de forma "errada".',
            topic: "Tense Structure",
            hint: "DICA 1: Procure a frase que n√£o segue a regra Sujeito + Auxiliar + -ING.",
            hint_2: "DICA 2: T____ W____ B__ H____.",
            options: [
                { "text": "Are you studying now?", "isCorrect": false, "rationale": "Correto. Present continuous interrogativo." },
                { "text": "Was she playing soccer yesterday?", "isCorrect": false, "rationale": "Correto. Past continuous interrogativo." },
                { "text": "I am working at the supermarket.", "isCorrect": false, "rationale": "Correto. Present continuous afirmativo." },
                { "text": "They would be help if you asked.", "isCorrect": true, "rationale": "Correto. A frase est√° errada. O verbo principal ap√≥s 'would be' deve ter -ing (helping), n√£o a forma base (help)." }
            ]
        },

        // --- 5 Quest√µes de √Åudio (Audio_MCQ) - Gram√°tica (Baseadas nos exemplos do PDF) ---
        {
            type: 'audio_mcq',
            audioSrc: 'https://files.catbox.moe/was_eating.mp3', // Placeholder audio link
            question: '6. Ou√ßa a frase: "I was eating dinner." Qual tempo cont√≠nuo est√° sendo usado?',
            topic: "Past Continuous",
            hint: "DICA 1: O auxiliar \'was\' indica o passado.",
            hint_2: "DICA 2: P____ C__________.",
            options: [
                { "text": "Present continuous", "isCorrect": false, "rationale": "Incorreto. Usaria \'am eating\'." },
                { "text": "Past continuous", "isCorrect": true, "rationale": "Correto. Estrutura: I + was + -ing." },
                { "text": "Future continuous", "isCorrect": false, "rationale": "Incorreto. Usaria \'will be eating\'." },
                { "text": "Conditional continuous", "isCorrect": false, "rationale": "Incorreto. Usaria \'would be eating\'." }
            ]
        },
        {
            type: 'audio_mcq',
            audioSrc: 'https://files.catbox.moe/will_be_travelling.mp3', // Placeholder audio link
            question: '7. Ou√ßa a frase: "I will be traveling tomorrow." O uso desse tempo indica:',
            topic: "Future Continuous",
            hint: "DICA 1: A√ß√£o em andamento em um futuro espec√≠fico.",
            hint_2: "DICA 2: F______ C__________.",
            options: [
                { "text": "Uma a√ß√£o que est√° acontecendo agora.", "isCorrect": false, "rationale": "Incorreto. Isso √© o present continuous." },
                { "text": "Uma a√ß√£o que ocorreu regularmente no passado.", "isCorrect": false, "rationale": "Incorreto. Isso √© o simple past." },
                { "text": "Uma a√ß√£o que estar√° acontecendo em um momento futuro espec√≠fico.", "isCorrect": true, "rationale": "Correto. Uso do future continuous." },
                { "text": "Uma a√ß√£o hipot√©tica sob condi√ß√£o.", "isCorrect": false, "rationale": "Incorreto. Isso √© o conditional continuous." }
            ]
        },
        {
            type: 'audio_mcq',
            audioSrc: 'https://files.catbox.moe/0fng28.mp3', // Placeholder audio link ok
            question: '8. Ou√ßa a frase: "Are you studying English?" Esta √© a forma interrogativa de qual tempo?',
            topic: "Present Continuous",
            hint: "DICA 1: O auxiliar \'Are\' est√° no presente.",
            hint_2: "DICA 2: P_______ C_________.",
            options: [
                { "text": "Past continuous", "isCorrect": false, "rationale": "Incorreto. Seria \'Were you studying...?\'." },
                { "text": "Present continuous", "isCorrect": true, "rationale": "Correto. Estrutura: Am/Are/Is + Sujeito + -ing?" },
                { "text": "Simple present", "isCorrect": false, "rationale": "Incorreto. Seria \'Do you study...?\'." },
                { "text": "Conditional continuous", "isCorrect": false, "rationale": "Incorreto. Seria \'Would you be studying...?\'." }
            ]
        },
        {
            type: 'audio_mcq',
            audioSrc: 'https://files.catbox.moe/ix3rz5.mp3', // Placeholder audio link ok
            question: '9. Ou√ßa a frase: "She would be studying if the library were open." Qual o prop√≥sito desse tempo verbal?',
            topic: "Conditional Continuous",
            hint: "DICA 1: √â uma a√ß√£o ligada a uma condi√ß√£o \'if\'.",
            hint_2: "DICA 2: H___________.",
            options: [
                { "text": "A√ß√£o que est√° completa no passado.", "isCorrect": false, "rationale": "Incorreto. Isso √© past perfect." },
                { "text": "A√ß√£o habitual no presente.", "isCorrect": false, "rationale": "Incorreto. Isso √© simple present." },
                { "text": "Descrever a√ß√µes que estariam acontecendo sob certas condi√ß√µes.", "isCorrect": true, "rationale": "Correto. Uso do conditional continuous." },
                { "text": "A√ß√£o futura planejada.", "isCorrect": false, "rationale": "Incorreto. Isso pode ser present continuous ou future continuous." }
            ]
        },
        {
            type: 'audio_mcq',
            audioSrc: 'https://files.catbox.moe/9fwx96.mp3', // Placeholder audio link ok
            question: '10. Ou√ßa a frase: "We were watching TV." Qual a regra de uso do auxiliar "were" nessa frase?',
            topic: "Past Continuous",
            hint: "DICA 1: Pense nos pronomes que acompanham \'were\'.",
            hint_2: "DICA 2: U__ / W__ / T____.",
            options: [
                { "text": "Usado para a 3¬™ pessoa do singular (he, she, it).", "isCorrect": false, "rationale": "Incorreto. Was √© usado para he, she, it." },
                { "text": "Usado para I (eu).", "isCorrect": false, "rationale": "Incorreto. Was √© usado para I." },
                { "text": "Usado para a 2¬™ pessoa e 3¬™ pessoas do plural (you, we, they).", "isCorrect": true, "rationale": "Correto. Were √© usado para you, we, they no past continuous." },
                { "text": "Usado somente no present continuous.", "isCorrect": false, "rationale": "Incorreto. Were √© past." }
            ]
        },

        // --- 5 Quest√µes de Preenchimento de Lacunas (Fill-in) - Gram√°tica ---
        {
            type: 'fill-in',
            question: '11. Complete a frase: we ______ watching tv yesterday at 8pm. (use apenas o auxiliar)',
            topic: "Past Continuous",
            hint: "DICA 1: We + (was/were).",
            hint_2: "DICA 2: W____.",
            answer: ["WERE"],
            rationale: "Correto. \'We\' usa \'were\' no past continuous."
        },
        {
            type: 'fill-in',
            question: '12. Complete usando presente cont√≠nuo: i ______ running in the park. (use apenas o auxiliar)',
            topic: "Present Continuous",
            hint: "DICA 1: I + (am/is/are).",
            hint_2: "DICA 2: A__.",
            answer: ["AM"],
            rationale: "Correto. \'I\' usa \'am\' no present continuous."
        },
        {
            type: 'fill-in',
            question: '13. Complete com o tempo futuro cont√≠nuo: tomorrow at 10am, she ______ writing an email. (use apenas o auxiliar)',
            topic: "Future Continuous",
            hint: "DICA 1: Auxiliar para todos os sujeitos no futuro cont√≠nuo.",
            hint_2: "DICA 2: W___ B__.",
            answer: ["WILL BE"],
            rationale: "Correto. \'Will be\' √© o auxiliar do future continuous para todos os sujeitos."
        },
        {
            type: 'fill-in',
            question: '14. Na nega√ß√£o do passado cont√≠nuo, o not √© colocado ap√≥s o auxiliar: she ______ not sleeping. (use apenas o auxiliar)',
            topic: "Past Continuous",
            hint: "DICA 1: O auxiliar para \'She\' no passado.",
            hint_2: "DICA 2: W__.",
            answer: ["WAS"],
            rationale: "Correto. She was not sleeping."
        },
        {
            type: 'fill-in',
            question: '15. Na forma interrogativa do conditional continuous, a primeira palavra da frase √© ______ you be doing your homework...?',
            topic: "Conditional Continuous",
            hint: "DICA 1: O modal condicional.",
            hint_2: "DICA 2: W____.",
            answer: ["WOULD"],
            rationale: "Correto. Would vem antes do sujeito na interrogativa."
        },

        // --- 5 Quest√µes de Verdadeiro/Falso (T/F) - Gram√°tica ---
        {
            type: 'tf',
            question: '16. O passado cont√≠nuo usa was/were + verbo com -ing.',
            topic: "Past Continuous",
            hint: "DICA 1: Verifique a estrutura do passado cont√≠nuo no roteiro.",
            options: [
                { "text": "Verdadeiro", "isCorrect": true, "rationale": "Correto. Esta √© a estrutura correta: Sujeito + was/were + verbo com -ing." },
                { "text": "Falso", "isCorrect": false, "rationale": "Incorreto." }
            ],
            answer: true
        },
        {
            type: 'tf',
            question: '17. O presente cont√≠nuo √© usado para a√ß√µes que ocorrem regularmente.',
            topic: "Present Continuous",
            hint: "DICA 1: A√ß√µes regulares usam o simple present, n√£o o cont√≠nuo.",
            options: [
                { "text": "Verdadeiro", "isCorrect": false, "rationale": "Falso. O present continuous √© para a√ß√µes que est√£o acontecendo \'agora\', n√£o para a√ß√µes regulares (que usam o simple present)." },
                { "text": "Falso", "isCorrect": true, "rationale": "Correto." }
            ],
            answer: false
        },
        {
            type: 'tf',
            question: '18. O futuro cont√≠nuo √© formado por sujeito + will be + verbo com -ing.',
            topic: "Future Continuous",
            hint: "DICA 1: Verifique a estrutura do futuro cont√≠nuo no roteiro.",
            options: [
                { "text": "Verdadeiro", "isCorrect": true, "rationale": "Correto. Esta √© a estrutura correta do future continuous." },
                { "text": "Falso", "isCorrect": false, "rationale": "Incorreto." }
            ],
            answer: true
        },
        {
            type: 'tf',
            question: '19. "They were not helping" est√° no conditional continuous.',
            topic: "Conditional Continuous",
            hint: "DICA 1: \'Were\' √© passado, n√£o condicional.",
            options: [
                { "text": "Verdadeiro", "isCorrect": false, "rationale": "Falso. A frase est√° no past continuous negativo. O conditional continuous usaria \'would be\' ou \'would not be\'." },
                { "text": "Falso", "isCorrect": true, "rationale": "Correto." }
            ],
            answer: false
        },
        {
            type: 'tf',
            question: '20. "I am studying now" est√° no presente cont√≠nuo.',
            topic: "Present Continuous",
            hint: "DICA 1: Verifique o auxiliar e o verbo principal.",
            options: [
                { "text": "Verdadeiro", "isCorrect": true, "rationale": "Correto. I + am + studying √© a forma afirmativa do present continuous." },
                { "text": "Falso", "isCorrect": false, "rationale": "Incorreto." }
            ],
            answer: true
        },

        // --- 5 Quest√µes de Arrastar e Soltar (Drag-drop) - Gram√°tica ---
        {
            type: 'drag-drop',
            question: '21. Para a frase "She ______ be waiting tomorrow", o auxiliar correto do futuro cont√≠nuo √©: ______',
            topic: "Future Continuous",
            hint: "DICA 1: O modal para o futuro.",
            options: ["WILL", "WOULD", "WAS"],
            answer: "WILL",
            rationale: "Correto. O auxiliar completo √© \'will be\', mas a lacuna pede apenas a parte modal."
        },
        {
            type: 'drag-drop',
            question: '22. Para a frase "We ______ watching TV", o auxiliar correto do passado cont√≠nuo √©: ______',
            topic: "Past Continuous",
            hint: "DICA 1: O To be no passado para \'We\'.",
            options: ["WAS", "WERE", "ARE"],
            answer: "WERE",
            rationale: "Correto. \'We\' usa \'were\' no past continuous."
        },
        {
            type: 'drag-drop',
            question: '23. Para a frase "He ______ working now", o auxiliar correto do presente cont√≠nuo √©: ______',
            topic: "Present Continuous",
            hint: "DICA 1: O To be no presente para \'He\'.",
            options: ["AM", "IS", "ARE"],
            answer: "IS",
            rationale: "Correto. \'He\' usa \'is\' no present continuous."
        },
        {
            type: 'drag-drop',
            question: '24. Para a frase "I ______ be working if i had a job", o auxiliar correto do conditional continuous √©: ______',
            topic: "Conditional Continuous",
            hint: "DICA 1: O modal condicional.",
            options: ["WILL", "WOULD", "WAS"],
            answer: "WOULD",
            rationale: "Correto. O auxiliar completo √© \'would be\', mas a lacuna pede apenas a parte modal."
        },
        {
            type: 'drag-drop',
            question: '25. Na forma interrogativa do past continuous, para o sujeito "He", a primeira palavra √©: ______ he running?',
            topic: "Past Continuous",
            hint: "DICA 1: O To be no passado para \'He\'.",
            options: ["WERE", "WAS", "IS"],
            answer: "WAS",
            rationale: "Correto. \'Was\' √© usado na interrogativa para I/He/She/It."
        }
    ],


    shuffleArray: function(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    },

    balanceCorrectAnswers: function() {
        const mcqQuestions = this.questions.filter(q => q.type === 'mcq' && q.options && q.options.length === 4);
        if (mcqQuestions.length === 0) return;
        
        const numPositions = 4;
        let desiredPositions = [];
        for (let i = 0; i < mcqQuestions.length; i++) {
            desiredPositions.push(i % numPositions);
        }
        this.shuffleArray(desiredPositions);
        
        let mcqCounter = 0;
        this.questions.forEach((q) => {
            if (q.type === 'mcq' && q.options && q.options.length === 4) {
                this.shuffleArray(q.options);
                const correctOption = q.options.find(opt => opt.isCorrect);
                if (!correctOption) return;
                const targetIndex = desiredPositions[mcqCounter];
                if (q.options.indexOf(correctOption) !== targetIndex) {
                    const currentIndex = q.options.indexOf(correctOption);
                    [q.options[currentIndex], q.options[targetIndex]] = [q.options[targetIndex], q.options[currentIndex]];
                }
                mcqCounter++;
            }
        });
    },
    
    updateProgressBar: function() {
        const totalQuestions = this.questions.length;
        const answeredCount = (this.currentQuestionIndex - this.skippedQuestions.length) + this.currentSkippedIndex;
        const percentage = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;
        if (this.elements.progressBar) {
            this.elements.progressBar.style.width = percentage + '%';
            this.elements.progressBar.textContent = percentage + '%';
        }
    },

    startQuiz: function(continueFromSavedState) {
        const studentCode = this.elements.studentCodeInput.value.trim().toUpperCase();
        const correctName = this.studentData[studentCode];
        if (!correctName) {
            alert("C√≥digo de acesso inv√°lido.");
            return;
        }
        this.validatedStudentCode = studentCode;
        this.validatedStudentName = correctName;
        
        if (this.validatedStudentCode === 'JR123') {
            setupAdminViewRoteiro(true);
            setupAdminViewApostila(true);
        } else {
            setupAdminViewRoteiro(false);
            setupAdminViewApostila(false);
        }
        
        if (continueFromSavedState) { 
            this.loadQuizState(this.validatedStudentCode); 
        } 
        else {
            this.currentQuestionIndex = 0;
            this.score = 0;
            this.userAnswers = {};
            this.skippedQuestions = [];
            this.currentSkippedIndex = 0;
            this.balanceCorrectAnswers();
            localStorage.removeItem(`quizState_${this.validatedStudentCode}`); 
            this.shuffledQuestions = this.shuffleArray([...this.questions]);
        }
        
        showCard('question-card', document.querySelector("button[onclick*='question-card']"));
        this.displayQuestion();
    },

    displayQuestion: function() {
        this.updateProgressBar();
        if (this.elements.performanceDisplay) this.elements.performanceDisplay.style.display = 'none';
        if (this.elements.justificationContainer) this.elements.justificationContainer.innerHTML = '';
        if (this.elements.hintText) this.elements.hintText.style.display = 'none';
        if (this.elements.summaryText) this.elements.summaryText.style.display = 'none';
        if (this.elements.summaryButton) this.elements.summaryButton.style.display = 'none';
        if (this.elements.nextButton) this.elements.nextButton.style.display = 'none';

        if (this.elements.translationDisplay) this.elements.translationDisplay.style.display = 'none'; 
        if (this.elements.translateButton) {
            this.elements.translateButton.style.display = 'inline-block'; 
            this.elements.translateButton.disabled = false;
            this.elements.translateButton.textContent = 'üåê'; 
        }
        
        if (this.elements.audioContainer) this.elements.audioContainer.innerHTML = ''; 
        if (this.elements.audioPlayContainer) this.elements.audioPlayContainer.innerHTML = ''; 
        if (this.elements.questionText) this.elements.questionText.style.display = 'flex'; 
        if (this.elements.questionText) this.elements.questionText.classList.remove('question-content'); 

        this.hintLevel = 0; 
        if (this.elements.hintButton) {
            this.elements.hintButton.textContent = 'Dica'; 
            this.elements.hintButton.style.background = ''; // Reseta o bot√£o para roxo
            this.elements.hintButton.disabled = false; 
            this.elements.hintButton.onclick = () => this.showHint(); 
        }
        
        let questionToDisplay;
        let currentQuestionNumber;
        let totalAnswered = (this.currentQuestionIndex - this.skippedQuestions.length) + this.currentSkippedIndex;

        if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0 && this.currentSkippedIndex < this.skippedQuestions.length) {
            const skippedIndex = this.skippedQuestions[this.currentSkippedIndex];
            questionToDisplay = this.questions[skippedIndex]; 
            currentQuestionNumber = `(Pulada ${this.currentSkippedIndex + 1}/${this.skippedQuestions.length})`
            if (this.elements.skipButton) this.elements.skipButton.style.display = 'none';
        } else if (this.currentQuestionIndex < this.shuffledQuestions.length) {
            questionToDisplay = this.shuffledQuestions[this.currentQuestionIndex];
            currentQuestionNumber = totalAnswered + 1;
            if (this.elements.skipButton) this.elements.skipButton.style.display = 'inline-block';
        } else {
            this.showResults();
            return;
        }
        
        // CORRIGIDO: Adicionado o marcador (topic) da quest√£o
        if (this.elements.currentQuestionNumSpan) {
            const markerText = questionToDisplay.topic ? `<span style="font-weight: bold; color: #007bff; display: inline-block; margin-left: 10px;"> - ${questionToDisplay.topic}</span>` : '';
            this.elements.currentQuestionNumSpan.innerHTML = `${currentQuestionNumber} de ${this.questions.length} ${markerText}`; 
        }
        
        if (this.elements.optionsList) this.elements.optionsList.innerHTML = '';

        switch (questionToDisplay.type) {
            case 'fill-in': this.renderFillIn(questionToDisplay); break;
            case 'drag-drop': this.renderDragDrop(questionToDisplay); break;
            case 'tf': this.renderMCQ(questionToDisplay); break;
            case 'audio_mcq': this.renderAudioMCQ(questionToDisplay); break; 
            case 'mcq': default: this.renderMCQ(questionToDisplay); break;
        }
    },

    renderAudioMCQ: function(question) {
        if (this.elements.audioContainer) this.elements.audioContainer.innerHTML = ''; 
        
        const audioEl = document.createElement('audio');
        audioEl.src = question.audioSrc;
        audioEl.preload = 'auto'; 
        if (this.elements.audioContainer) this.elements.audioContainer.appendChild(audioEl);

        if (this.elements.audioPlayContainer) this.elements.audioPlayContainer.innerHTML = ''; 
        const playBtn = document.createElement('button');
        playBtn.className = 'btn audio-play-btn';
        playBtn.textContent = 'Ouvir Quest√£o üéß';
        playBtn.onclick = () => audioEl.play();
        if (this.elements.audioPlayContainer) this.elements.audioPlayContainer.appendChild(playBtn);
        
        if (this.elements.translateButton) this.elements.translateButton.style.display = 'none';

        this.renderMCQ(question);
    },

    renderMCQ: function(question) {
        if (this.elements.questionText) {
            this.elements.questionText.innerHTML = ''; 
            this.elements.questionText.classList.add('question-content'); 
            this.elements.questionText.textContent = question.question;
        }
        
        if (this.elements.translateButton) {
            if (question.type !== 'audio_mcq') {
                this.elements.translateButton.style.display = 'inline-block';
            } else {
                this.elements.translateButton.style.display = 'none';
            }
        }

        if (this.elements.optionsList) {
            question.options.forEach(option => {
                const li = document.createElement('li');
                li.className = 'option-item';
                li.textContent = option.text;
                li.onclick = () => this.selectOption(li, option);
                this.elements.optionsList.appendChild(li);
            });
        }
    },

    renderFillIn: function(question) {
        if (this.elements.questionText) {
            this.elements.questionText.innerHTML = ''; 
            this.elements.questionText.classList.add('question-content'); 
            this.elements.questionText.textContent = question.question;
        }
        if (this.elements.translateButton) this.elements.translateButton.style.display = 'inline-block'; 
        
        if (this.elements.optionsList) {
            const input = document.createElement('input');
            input.id = 'fill-in-input';
            input.placeholder = 'Digite sua resposta...';
            const checkButton = document.createElement('button');
            checkButton.textContent = 'Verificar';
            checkButton.className = 'btn check-btn';
            checkButton.onclick = () => {
                const userAnswer = input.value.trim().toLowerCase();
                const isCorrect = question.answer.map(ans => ans.toLowerCase()).includes(userAnswer);
                this.handleAnswer(isCorrect, question.rationale, input.value.trim(), question.answer[0]);
                input.disabled = true;
                checkButton.style.display = 'none';
                input.classList.add(isCorrect ? 'correct' : 'incorrect');
            };
            this.elements.optionsList.appendChild(input);
            this.elements.optionsList.appendChild(checkButton);
        }
    },

    renderDragDrop: function(question) {
        if (this.elements.questionText) this.elements.questionText.classList.add('question-content'); 

        const dropZone = document.createElement('span');
        dropZone.id = 'drop-zone';
        dropZone.textContent = 'Arraste aqui';
        // Envolve o texto da quest√£o em uma div para melhor controle de layout
        const questionTextHTML = `<div class="question-content-text">${question.question.replace('______', dropZone.outerHTML)}</div>`;
        if (this.elements.questionText) this.elements.questionText.innerHTML = questionTextHTML; 
        if (this.elements.translateButton) this.elements.translateButton.style.display = 'inline-block'; 
        
        const actualDropZone = this.elements.questionText ? this.elements.questionText.querySelector('#drop-zone') : null;
        
        if (this.elements.optionsList) {
            const dragOptionsWrapper = document.createElement('div');
            dragOptionsWrapper.className = 'drag-options-wrapper';
            this.shuffleArray(question.options).forEach(opt => {
                const optionEl = document.createElement('span');
                optionEl.textContent = opt;
                optionEl.className = 'drag-option';
                optionEl.draggable = true;
                optionEl.dataset.value = opt;
                
                // Adicionado suporte para arrastar e soltar (drag and drop)
                optionEl.ondragstart = (e) => { e.dataTransfer.setData('text/plain', e.target.dataset.value); e.target.classList.add('dragging'); };
                optionEl.ondragend = (e) => e.target.classList.remove('dragging');
                
                // Suporte b√°sico a touch (mobile)
                optionEl.ontouchstart = (e) => {
                    e.preventDefault(); // Evita scroll
                    e.target.classList.add('dragging');
                    this.dragTouchData = { value: e.target.dataset.value, element: e.target };
                };
                optionEl.ontouchmove = (e) => {
                    if (this.dragTouchData) {
                        const touch = e.touches[0];
                        this.dragTouchData.element.style.position = 'absolute';
                        this.dragTouchData.element.style.zIndex = 1000;
                        this.dragTouchData.element.style.left = `${touch.pageX - this.dragTouchData.element.offsetWidth / 2}px`;
                        this.dragTouchData.element.style.top = `${touch.pageY - this.dragTouchData.element.offsetHeight / 2}px`;
                    }
                };
                optionEl.ontouchend = (e) => {
                    if (this.dragTouchData) {
                        this.dragTouchData.element.classList.remove('dragging');
                        this.dragTouchData.element.style.position = '';
                        this.dragTouchData.element.style.zIndex = '';
                        this.dragTouchData.element.style.left = '';
                        this.dragTouchData.element.style.top = '';

                        const touch = e.changedTouches[0];
                        const target = document.elementFromPoint(touch.clientX, touch.clientY);

                        if (target && target.id === 'drop-zone') {
                            const isCorrect = (this.dragTouchData.value.toLowerCase() === question.answer.toLowerCase());
                            this.handleAnswer(isCorrect, question.rationale, this.dragTouchData.value, question.answer);
                            target.textContent = this.dragTouchData.value;
                            target.classList.add(isCorrect ? 'correct' : 'incorrect');
                            this.elements.optionsList.querySelectorAll('.drag-option').forEach(el => { el.draggable = false; el.style.cursor = 'not-allowed'; el.style.opacity = '0.6'; });
                        }
                        this.dragTouchData = null;
                    }
                };

                dragOptionsWrapper.appendChild(optionEl);
            });
            this.elements.optionsList.appendChild(dragOptionsWrapper);
        }
        
        // L√≥gica de Drop (Desktop)
        if (actualDropZone) {
            actualDropZone.ondragover = (e) => { e.preventDefault(); actualDropZone.classList.add('over'); };
            actualDropZone.ondragleave = () => actualDropZone.classList.remove('over');
            actualDropZone.ondrop = (e) => {
                e.preventDefault();
                actualDropZone.classList.remove('over');
                const droppedValue = e.dataTransfer.getData('text/plain');
                const isCorrect = (droppedValue.toLowerCase() === question.answer.toLowerCase());
                this.handleAnswer(isCorrect, question.rationale, droppedValue, question.answer);
                actualDropZone.textContent = droppedValue;
                actualDropZone.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (this.elements.optionsList) this.elements.optionsList.querySelectorAll('.drag-option').forEach(el => { el.draggable = false; el.style.cursor = 'not-allowed'; el.style.opacity = '0.6'; });
            };
        }
    },

    selectOption: function(selectedElement, selectedOption) {
        if (this.elements.optionsList) this.elements.optionsList.querySelectorAll('.option-item').forEach(option => option.style.pointerEvents = 'none');
        const isCorrect = selectedOption.isCorrect;
        
        let currentQuestion;
        if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
            currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
        } else {
            currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
        }
        
        selectedElement.classList.add(isCorrect ? 'correct' : 'incorrect');
        this.handleAnswer(isCorrect, selectedOption.rationale, selectedOption.text, currentQuestion.options.find(o => o.isCorrect).text);

        if (!isCorrect) {
            const correctText = currentQuestion.options.find(opt => opt.isCorrect).text;
            const correctElement = this.elements.optionsList ? Array.from(this.elements.optionsList.querySelectorAll('.option-item')).find(el => el.textContent === correctText) : null;
            if (correctElement) correctElement.classList.add('correct');
        }
    },

    handleAnswer: function(isCorrect, rationale, userAnswer, correctAnswer) {
        if (isCorrect) {
            this.score++;
            if (this.elements.summaryButton) this.elements.summaryButton.style.display = 'none';
        } else {
            if (this.elements.summaryButton) this.elements.summaryButton.style.display = 'inline-block';
        }
        const justificationElement = document.createElement('div');
        justificationElement.className = 'justification';
        justificationElement.innerHTML = rationale; 
        justificationElement.style.borderLeftColor = isCorrect ? '#28a745' : '#dc3545';
        if (this.elements.justificationContainer) this.elements.justificationContainer.appendChild(justificationElement);
        
        let originalQuestionIndex;
        let currentQuestion;
         if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
            originalQuestionIndex = this.skippedQuestions[this.currentSkippedIndex];
            currentQuestion = this.questions[originalQuestionIndex];
        } else {
            currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
            originalQuestionIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
        }
        
        this.userAnswers[originalQuestionIndex] = {
            question: currentQuestion.question, 
            userAnswer: userAnswer,
            isCorrect: isCorrect,
            correctAnswer: correctAnswer,
            rationale: rationale,
            type: currentQuestion.type || 'mcq',
            topic: currentQuestion.topic || 'Geral' 
        };
        
        if (this.elements.nextButton) this.elements.nextButton.style.display = 'block';
        if (this.elements.skipButton) this.elements.skipButton.style.display = 'none';
        this.saveQuizState();
    },

    showPerformance: function() {
        const display = this.elements.performanceDisplay;
        if (!display) return;
        
        if (display.style.display === 'block') {
            display.style.display = 'none';
        } else {
            const answeredCount = Object.keys(this.userAnswers).length;
            const incorrectCount = answeredCount - this.score;
            display.innerHTML = `<strong style="color: #333;">At√© agora:</strong> <span style="color: #28a745;">${this.score} acertos</span> <strong style="color: #333;">e</strong> <span style="color: #dc3545;">${incorrectCount} erros</span><strong style="color: #333;">!</strong>`;
            display.style.display = 'block';
            if (this.elements.hintText) this.elements.hintText.style.display = 'none';
            if (this.elements.summaryText) this.elements.summaryText.style.display = 'none';
        }
    },
    
    showHint: function() {
        const display = this.elements.hintText;
        const button = this.elements.hintButton; 
        if (!display || !button) return;

        let currentQuestion;
        
        // Pega a quest√£o atual (considerando puladas)
        if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
            currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
        } else {
            currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
        }

        if (this.elements.performanceDisplay) this.elements.performanceDisplay.style.display = 'none';
        if (this.elements.summaryText) this.elements.summaryText.style.display = 'none';

        let hint1 = currentQuestion.hint || "Sem dica dispon√≠vel.";
        let hint2 = currentQuestion.hint_2 || ""; 

        // L√≥gica Corrigida: Verifica se existe Hint 2
        if (hint2) {
            // MODO COM DUAS DICAS
            if (this.hintLevel === 0) { 
                // MOSTRAR DICA 1
                display.innerHTML = hint1; 
                display.style.display = 'block';
                button.textContent = 'DICA 2'; 
                this.hintLevel = 1; 
            } else if (this.hintLevel === 1) { 
                // MOSTRAR DICA 2 (Junto com a 1)
                display.innerHTML = hint1 + '<br><br>' + hint2;
                display.style.display = 'block';
                button.textContent = 'Ocultar Dicas'; 
                button.style.background = 'linear-gradient(45deg, #28a745, #218838)';
                this.hintLevel = 2; 
            } else { 
                // OCULTAR TUDO
                display.style.display = 'none';
                button.textContent = 'Dica';
                button.style.background = ''; 
                this.hintLevel = 0; 
            }
        } else { 
            // MODO SIMPLES (S√ì UMA DICA)
            if (display.style.display === 'block') {
                display.style.display = 'none';
            } else {
                if (currentQuestion && currentQuestion.hint) {
                    display.innerHTML = currentQuestion.hint;
                    display.style.display = 'block';
                }
            }
        }
    },

    showSummary: function() {
        const display = this.elements.summaryText;
        if (!display) return;

        if (display.style.display === 'block') {
            display.style.display = 'none';
        } else {
            let currentQuestion;
            if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
                currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
            } else {
                currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
            }
            const questionTopic = currentQuestion.topic;
            if (questionTopic && this.summaries[questionTopic]) {
                display.textContent = this.summaries[questionTopic];
                display.style.display = 'block';
                if (this.elements.performanceDisplay) this.elements.performanceDisplay.style.display = 'none';
                if (this.elements.hintText) this.elements.hintText.style.display = 'none';
            }
        }
    },

    translateQuestion: function() {
        const button = this.elements.translateButton;
        const display = this.elements.translationDisplay;
        if (!button || !display) return;
        
        let currentQuestion;
        if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
            currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
        } else {
            currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
        }

        if (display.style.display === 'block') {
            display.style.display = 'none';
            button.textContent = 'üåê';
            return;
        }
        
        let textToTranslate;
        if (currentQuestion.type === 'drag-drop' && this.elements.questionText && this.elements.questionText.querySelector('.question-content-text')) {
            textToTranslate = this.elements.questionText.querySelector('.question-content-text').textContent;
        } else if (this.elements.questionText) {
            textToTranslate = this.elements.questionText.textContent;
        } else {
             display.textContent = 'Erro: Texto da quest√£o n√£o encontrado.';
             display.style.display = 'block';
             return;
        }

        display.textContent = 'Traduzindo...';
        display.style.display = 'block';
        button.disabled = true;

        const langPair = 'en|pt'; 
        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=${langPair}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data && data.responseData && data.responseData.translatedText) {
                    display.textContent = data.responseData.translatedText;
                } else {
                    display.textContent = 'Erro ao traduzir. Tente novamente.';
                }
                button.disabled = false;
                button.textContent = 'üôà'; 
            })
            .catch(error => {
                console.error('Translation error:', error);
                display.textContent = 'N√£o foi poss√≠vel conectar ao servi√ßo de tradu√ß√£o.';
                button.disabled = false;
                button.textContent = 'üåê';
            });
    },

    nextQuestion: function() {
        if (this.currentQuestionIndex < this.shuffledQuestions.length) {
            this.currentQuestionIndex++;
        } else {
            this.currentSkippedIndex++;
        }
        if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.currentSkippedIndex >= this.skippedQuestions.length) {
            this.showResults();
        } else {
            this.displayQuestion();
        }
    },

    skipQuestion: function() {
        if (this.currentQuestionIndex < this.shuffledQuestions.length) {
            let currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
            const originalIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
            if (!this.skippedQuestions.includes(originalIndex)) {
                this.skippedQuestions.push(originalIndex);
            }
        }
        this.currentQuestionIndex++;
        if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length === 0) {
            this.showResults();
        } else {
            this.displayQuestion();
        }
    },

    getClassification: function(percentage) {
        if (percentage >= 86) return "Excelente!!!"; if (percentage >= 71) return "Muito Bom!!"; if (percentage >= 51) return "Bom!"; if (percentage >= 0) return "Insatisfat√≥rio!"; return "";
    },
    launchConfetti: function() { confetti({ particleCount: 600, spread: 70, origin: { y: 0.6 } }); },

    showResults: function() {
        const percentage = Math.round((this.score / this.questions.length) * 100);
        const classificationText = this.getClassification(percentage);

        const reportData = {
            isCompleted: true, 
            studentName: this.validatedStudentName,
            studentCode: this.validatedStudentCode,
            score: this.score,
            totalQuestions: this.questions.length,
            percentage: percentage,
            classification: classificationText,
            userAnswers: this.userAnswers,
            originalQuestions: this.questions 
        };

        this.saveCompletedReport(reportData); 
        this.saveFinalReport(reportData);     

        this.displayReport(reportData);

        const dataForGoogle = { 
            nome: this.validatedStudentName, 
            codigo: this.validatedStudentCode, 
            pontuacao: `(GRAMMAR) ${this.score} de ${this.questions.length}`, // Adicionado (GRAMMAR)
            percentual: `${percentage}%`, 
            classificacao: classificationText 
        };
        
        fetch(this.APP_SCRIPT_URL, { method: 'POST', body: JSON.stringify(dataForGoogle), headers: { 'Content-Type': 'application/json' }, mode: 'no-cors' })
            .then(() => { 
                if (this.elements.sendReportLink) {
                    this.elements.sendReportLink.textContent = 'Relat√≥rio Enviado!'; 
                    this.elements.sendReportLink.style.background = '#ccc'; 
                    this.elements.sendReportLink.onclick = (e) => e.preventDefault(); 
                }
            })
            .catch(error => console.error('Erro:', error));
    },

    saveCompletedReport: function(reportData) {
        if (!reportData.studentCode) return;
        try {
            localStorage.setItem(`quizState_${reportData.studentCode}`, JSON.stringify(reportData));
        } catch (e) {
            console.error("N√£o foi poss√≠vel salvar o estado do quiz:", e);
        }
    },

    saveFinalReport: function(reportData) {
        if (!reportData.studentCode) return;
        try {
            localStorage.setItem(`quizReport_${reportData.studentCode}`, JSON.stringify(reportData));
        } catch (e) {
            console.error("N√£o foi poss√≠vel salvar o relat√≥rio final permanente:", e);
        }
    },

    displayReport: function(data) {
        // CORRIGIDO: Mostra o cart√£o de resultados
        showCard('results-card', document.getElementById('results-tab-btn'));

        this.validatedStudentName = data.studentName;
        this.validatedStudentCode = data.studentCode;
        this.score = data.score;
        this.userAnswers = data.userAnswers;
        this.questions = data.originalQuestions; 

        if (this.elements.reportStudentName) this.elements.reportStudentName.textContent = data.studentName;
        if (this.elements.reportStudentCode) this.elements.reportStudentCode.textContent = data.studentCode;
        if (this.elements.scoreDisplay) this.elements.scoreDisplay.textContent = `${data.score} de ${data.totalQuestions}`;
        if (this.elements.percentageDisplay) this.elements.percentageDisplay.textContent = `${data.percentage}%`;
        if (this.elements.classificationDisplay) this.elements.classificationDisplay.textContent = data.classification;
        
        if (data.classification === "Excelente!!!") this.launchConfetti();
        
        if (this.elements.fullReportContainer) this.elements.fullReportContainer.innerHTML = this.generateFullReportHtml();
        if (this.elements.personalReportContainer) this.elements.personalReportContainer.innerHTML = this.generatePersonalReportHtml();
        
        const shareMessage = this.generateShareMessage(data.percentage, data.classification);
        if (this.elements.shareWhatsappLink) this.elements.shareWhatsappLink.href = `https://wa.me/?text=${encodeURIComponent(shareMessage)}`;
        
        // Configura o bot√£o de relat√≥rio para o quiz de gram√°tica
        if (this.elements.sendReportLink) {
            this.elements.sendReportLink.textContent = 'Enviar Relat√≥rio (Grammar)'; 
            this.elements.sendReportLink.style.background = '';
        }
    },

    retrieveReport: function(code) {
        const finalReportJSON = localStorage.getItem(`quizReport_${code}`);
        if (!finalReportJSON) {
            alert('Erro: Relat√≥rio n√£o encontrado.');
            return;
        }
        
        try {
            const state = JSON.parse(finalReportJSON);
            if (state.isCompleted) {
                this.displayReport(state); 
                
                if (this.elements.sendReportLink) {
                    this.elements.sendReportLink.textContent = 'Relat√≥rio J√° Enviado';
                    this.elements.sendReportLink.style.background = '#ccc';
                    this.elements.sendReportLink.onclick = (e) => e.preventDefault();
                }
            } else {
                alert('O relat√≥rio salvo √© inv√°lido.');
            }
        } catch (e) {
            alert('Erro ao carregar relat√≥rio.');
            localStorage.removeItem(`quizReport_${code}`); 
        }
    },

    getCorrectAnswerForQuestion: function(question) {
        if (question.type === 'fill-in') {
            return question.answer[0];
        }
        if (question.type === 'drag-drop') {
            return question.answer;
        }
        if (question.type === 'mcq' || question.type === 'tf' || question.type === 'audio_mcq') { 
            const correctOption = question.options.find(o => o.isCorrect);
            return correctOption ? correctOption.text : 'N/A';
        }
        return 'N/A';
    },

    generateFullReportHtml: function() {
        let reportHtml = '<h3>Relat√≥rio Detalhado</h3>';
        this.questions.forEach((question, index) => {
            const answerData = this.userAnswers[index];
            let questionText = question.question; 
            questionText = questionText.replace(/______/g, '...'); 
            
            if (question.type === 'audio_mcq') {
                // Usa a DICA 1 como texto da frase, se dispon√≠vel
                const hintText = question.hint ? question.hint.replace("DICA 1: A frase √©: ", "").replace("DICA 1:", "").trim() : 'N/A';
                questionText = `${questionText} (Frase de √Åudio: '${hintText}')`;
            }

            if (answerData) {
                const itemClass = answerData.isCorrect ? 'correct' : 'incorrect';
                reportHtml += `
                    <div class="report-question-item">
                        <p><strong>Quest√£o ${index + 1}:</strong> ${questionText}</p>
                        <p><strong>Sua Resposta:</strong> <span class="option-item-report ${itemClass}">${answerData.userAnswer}</span></p>
                        ${!answerData.isCorrect ? `<p><strong>Resposta Correta:</strong> <span class="option-item-report correct">${answerData.correctAnswer}</span></p>` : ''}
                        <p><em>Justificativa: ${answerData.rationale}</em></p>
                    </div>
                `;
            } else {
                const correctAnswer = this.getCorrectAnswerForQuestion(question);
                const rationale = question.rationale || (question.options ? (question.options.find(o => o.isCorrect) || {}).rationale : '');
                reportHtml += `
                    <div class="report-question-item">
                        <p><strong>Quest√£o ${index + 1}:</strong> ${questionText}</p>
                        <p><strong>Sua Resposta:</strong> <span class="option-item-report incorrect">N√£o respondida</span></p>
                        <p><strong>Resposta Correta:</strong> <span class="option-item-report correct">${correctAnswer}</span></p>
                        <p><em>Justificativa: ${rationale}</em></p>
                    </div>
                `;
            }
        });
        return reportHtml;
    },
    
    analyzePerformanceByTopic: function() {
        const topicErrors = {};
        const topicTotals = {};

        this.questions.forEach((question, index) => {
            const topic = question.topic;
            if (!topic) return; 
            if (!topicTotals[topic]) topicTotals[topic] = 0;
            topicTotals[topic]++;

            const answerData = this.userAnswers[index];
            if (!answerData || !answerData.isCorrect) {
                if (!topicErrors[topic]) topicErrors[topic] = 0;
                topicErrors[topic]++;
            }
        });
        
        return { topicErrors, topicTotals };
    },
    
    generatePersonalReportHtml: function() {
        const analysis = this.analyzePerformanceByTopic();
        let html = '<h3>Relat√≥rio Pessoal de Estudos</h3>';
        
        const topicsToReview = [];
        for (const topic in analysis.topicErrors) {
            const errors = analysis.topicErrors[topic];
            if (errors > 0) {
                const total = analysis.topicTotals[topic];
                const errorRate = (errors / total) * 100;
                topicsToReview.push({ topic: topic, errors: errors, total: total, rate: errorRate });
            }
        }

        topicsToReview.sort((a, b) => b.errors - a.errors);

        if (topicsToReview.length === 0) {
            html += '<p style="font-weight: bold; color: #28a745;">Parab√©ns! Voc√™ n√£o errou nenhuma quest√£o. N√£o h√° nada para revisar.</p>';
        } else {
             html += `<p>Aqui est√° seu guia de estudos focado nos t√≥picos que voc√™ precisa revisar, come√ßando pelos mais dif√≠ceis:</p><br>`;
            topicsToReview.forEach(item => {
                const summaryText = this.summaries[item.topic] || "N√£o h√° resumo dispon√≠vel para este t√≥pico.";
                html += `
                    <div class="personal-summary-item">
                        <h4>T√≥pico: ${item.topic}</h4>
                        <p><strong>Seu desempenho:</strong> <span style="color: #dc3545;">${item.errors} de ${item.total} erradas</span> (${item.rate.toFixed(0)}% de erro)</p>
                        <p><strong>Resumo para Revis√£o:</strong><br>${summaryText}</p>
                    </div>
                `;
            });
        }

        return html;
    },
    
    printPersonalReport: function() {
        if (this.elements.fullReportContainer) this.elements.fullReportContainer.style.display = 'none';
        if (this.elements.personalReportContainer) this.elements.personalReportContainer.style.display = 'block';
        window.print();
    },
    
    printReport: function() { 
        if (this.elements.personalReportContainer) this.elements.personalReportContainer.style.display = 'none';
        if (this.elements.fullReportContainer) this.elements.fullReportContainer.style.display = 'block';
        window.print();
    },
    
    generateShareMessage: function(percentage, classificationText) {
        return `Acabei de fazer o quiz "Quiz - Grammar"! Meu resultado: ${percentage}% (${classificationText}).`;
    },
    
    saveQuizState: function() {
        if (!this.validatedStudentCode) return;
        const state = {
            isCompleted: false, 
            currentQuestionIndex: this.currentQuestionIndex,
            score: this.score,
            userAnswers: this.userAnswers,
            skippedQuestions: this.skippedQuestions,
            currentSkippedIndex: this.currentSkippedIndex,
            shuffledQuestions: this.shuffledQuestions
        };
        try {
            localStorage.setItem(`quizState_${this.validatedStudentCode}`, JSON.stringify(state));
        } catch (e) {
            console.error("N√£o foi poss√≠vel salvar o estado do quiz:", e);
        }
    },

    loadQuizState: function(studentCode) {
        try {
            const savedState = localStorage.getItem(`quizState_${studentCode}`);
            if (savedState) {
                const state = JSON.parse(savedState);
                if (!state.isCompleted) {
                    this.currentQuestionIndex = state.currentQuestionIndex;
                    this.score = state.score;
                    this.userAnswers = state.userAnswers;
                    this.skippedQuestions = state.skippedQuestions;
                    this.currentSkippedIndex = state.currentSkippedIndex;
                    this.shuffledQuestions = state.shuffledQuestions; 
                    return true;
                }
            }
        } catch (e) {
            console.error("N√£o foi poss√≠vel carregar o estado do quiz:", e);
            localStorage.removeItem(`quizState_${studentCode}`); 
        }
        return false; 
    },

    updateAttemptsDisplay: function(code) {
        const savedStateJSON = localStorage.getItem(`quizState_${code}`); 
        const finalReportJSON = localStorage.getItem(`quizReport_${code}`); 
        const correctName = this.studentData[code];
        
        if (correctName) {
            if (this.elements.personalizedWelcome) {
                this.elements.personalizedWelcome.textContent = `Seja bem-vindo(a), ${correctName}! Boa sorte!`;
                this.elements.personalizedWelcome.style.display = 'block';
            }
        }

        let state = null;
        let finalReport = null;
        try { if (savedStateJSON) state = JSON.parse(savedStateJSON); } catch (e) { localStorage.removeItem(`quizState_${code}`); }
        try { if (finalReportJSON) finalReport = JSON.parse(finalReportJSON); } catch (e) { localStorage.removeItem(`quizReport_${code}`); }

        let buttonsHtml = '';

        if (state && !state.isCompleted) {
            buttonsHtml = `
                <p style="font-weight: bold; color: #007bff;">Encontramos um progresso salvo para voc√™.</p>
                <button class="btn continue-btn" onclick="quizApp.startQuiz(true)">Continuar Quiz</button>
                <button class="btn restart-btn" style="margin-left: 10px;" onclick="quizApp.startQuiz(false)">Reiniciar (Perder Progresso)</button>
            `;
        } else if (state && state.isCompleted) {
            buttonsHtml = `
                <p style="font-weight: bold; color: #007bff;">Voc√™ j√° completou este quiz.</p>
                <button class="btn restart-btn" onclick="quizApp.startQuiz(false)">Reiniciar Quiz</button>
            `;
        } else {
            buttonsHtml = `
                <button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>
            `;
        }

        if (finalReport) {
            if (state && state.isCompleted) {
                buttonsHtml = `
                    <p style="font-weight: bold; color: #007bff;">Voc√™ j√° completou este quiz.</p>
                    <button class="btn restart-btn" onclick="quizApp.startQuiz(false)">Reiniciar Quiz</button>
                    <button class="btn continue-btn" style="margin-left: 10px;" onclick="quizApp.retrieveReport('${code}')">Resgatar Relat√≥rio</button>
                `;
            } else {
                buttonsHtml += `
                    <button class="btn continue-btn" style="margin-left: 10px;" onclick="quizApp.retrieveReport('${code}')">Resgatar √öltimo Relat√≥rio</button>
                `;
            }
        }
        
        if (this.elements.startActionsDiv) this.elements.startActionsDiv.innerHTML = buttonsHtml;
    },
    
    restartQuiz: function() { 
        showCard('intro-card', document.querySelector("button[onclick*='intro-card']"));
        setupAdminViewRoteiro(false);
        setupAdminViewApostila(false);
    },
    
    saveReport: function() {
        const studentName = this.validatedStudentName;
        const studentCode = this.validatedStudentCode;
        const score = this.elements.scoreDisplay ? this.elements.scoreDisplay.textContent : 'N/A';
        const percentage = this.elements.percentageDisplay ? this.elements.percentageDisplay.textContent : 'N/A';
        const classification = this.elements.classificationDisplay ? this.elements.classificationDisplay.textContent : 'N/A';
        
        const detailedReportHtml = this.generateFullReportHtml();
        const personalReportHtml = this.generatePersonalReportHtml();


        const fullHtmlContent = `
            <!DOCTYPE html>
            <html lang="pt-BR">
            <head>
                <meta charset="UTF-BOM">
                <title>Relat√≥rio - ${studentName}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                    h1, h3 { color: #007bff; }
                    h4 { color: #856404; }
                    p { margin: 5px 0; }
                    .report-question-item { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; page-break-inside: avoid; }
                    .option-item-report.correct { background-color: #d4edda; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                    .option-item-report.incorrect { background-color: #f8d7da; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                    .personal-summary-item { background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; padding: 15px; margin-bottom: 15px; page-break-inside: avoid; }
                    #print-personal-btn { display: none; } 
                </style>
            </head>
            <body>
                <h1>Relat√≥rio Final - Quiz - Grammar</h1>
                <p><strong>Nome:</strong> ${studentName}</p>
                <p><strong>C√≥digo de Acesso:</strong> ${studentCode}</p>
                <p><strong>Pontua√ß√£o:</strong> ${score}</p>
                <p><strong>Percentual de Acerto:</strong> ${percentage}</p>
                <p><strong>Classifica√ß√£o:</strong> ${classification}</p>
                <hr>
                <div id="personal-report-container">
                    ${personalReportHtml}
                </div>
                <hr>
                <div id="full-report-container">
                    ${detailedReportHtml}
                </div>
            </body>
            </html>
        `;

        const blob = new Blob([fullHtmlContent], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Relatorio_Grammar_${studentName.replace(' ', '_')}_${studentCode}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    },

    init: function() {
        setupAdminViewRoteiro(false);
        setupAdminViewApostila(false);
        
        // ADI√á√ÉO DE VERIFICA√á√ïES DE SEGURAN√áA PARA EVITAR TRAVAMENTO
        if (this.elements.studentCodeInput) { 
            this.elements.studentCodeInput.addEventListener('input', (e) => {
                const code = e.target.value.trim().toUpperCase();
                if (this.studentData[code]) { 
                    this.updateAttemptsDisplay(code); 
                } 
                else { 
                    if (this.elements.startActionsDiv) this.elements.startActionsDiv.innerHTML = '<button class=\"start-btn\" onclick=\"quizApp.startQuiz(false)\">Start Quiz</button>'; 
                    if (this.elements.personalizedWelcome) this.elements.personalizedWelcome.style.display = 'none';
                }
            });
        }
        
        if (this.elements.translateButton) this.elements.translateButton.onclick = () => this.translateQuestion();
        if (this.elements.performanceButton) this.elements.performanceButton.onclick = () => this.showPerformance();
        if (this.elements.hintButton) this.elements.hintButton.onclick = () => this.showHint();
        if (this.elements.summaryButton) this.elements.summaryButton.onclick = () => this.showSummary();
        if (this.elements.nextButton) this.elements.nextButton.onclick = () => this.nextQuestion();
        if (this.elements.skipButton) this.elements.skipButton.onclick = () => this.skipQuestion();
    }
};


// --------------------------------------------------------------------
// L√ìGICA DO QUIZ DE VOCABUL√ÅRIO (vocabQuizApp - 1¬∫ M√©dio)
// --------------------------------------------------------------------
const vocabQuizApp = {
    APP_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwtDAlCCBcc3cN3pHX5YTkCZBsYTH--UJbeaczv64av_vIkybVIaEs-nTLKM2ssHND2/exec',
    currentQuestionIndex: 0,
    score: 0,
    userAnswers: {},
    validatedStudentName: '',
    validatedStudentCode: '',
    totalAttempts: "Ilimitadas",
    skippedQuestions: [],
    currentSkippedIndex: 0,
    shuffledQuestions: [],
    hintLevel: 0, 
    dragTouchData: null, // Adicionado para suporte a drag and drop mobile
    
    // Elementos com IDs 'vocab-'
    elements: {
        quizCard: document.getElementById('vocab-quiz-card'),
        questionText: document.getElementById('vocab-question-text'),
        optionsList: document.getElementById('vocab-options-list'),
        justificationContainer: document.getElementById('vocab-justification-container'),
        nextButton: document.getElementById('vocab-next-button'),
        skipButton: document.getElementById('vocab-skip-button'),
        hintButton: document.getElementById('vocab-hint-button'),
        hintText: document.getElementById('vocab-hint-text'),
        attemptsLeftSpan: document.getElementById('vocab-attempts-left'),
        currentQuestionNumSpan: document.getElementById('vocab-current-question-num'),
        summaryButton: document.getElementById('vocab-summary-button'),
        summaryText: document.getElementById('vocab-summary-text'),
        performanceButton: document.getElementById('vocab-performance-btn'),
        performanceDisplay: document.getElementById('vocab-performance-display'),
        progressBar: document.getElementById('vocab-progress-bar'),
        translateButton: document.getElementById('vocab-translate-button'),
        translationDisplay: document.getElementById('vocab-translation-display'),
        audioContainer: document.getElementById('vocab-audio-container'),
        audioPlayContainer: document.getElementById('vocab-audio-play-container'),
        
        // Elementos do resultado (s√£o compartilhados)
        resultsCard: document.getElementById('results-card'),
        scoreDisplay: document.getElementById('score-display'),
        percentageDisplay: document.getElementById('percentage-display'),
        classificationDisplay: document.getElementById('classification-display'),
        reportStudentName: document.getElementById('report-student-name'),
        reportStudentCode: document.getElementById('report-student-code'),
        sendReportLink: document.getElementById('send-report-link'),
        fullReportContainer: document.getElementById('full-report-container'),
        shareWhatsappLink: document.getElementById('share-whatsapp'),
        personalReportContainer: document.getElementById('personal-report-container')
    },

    studentData: quizApp.studentData, 
    summaries: vocabSummaries,
    questions: vocabQuestions, 

    shuffleArray: quizApp.shuffleArray,
    balanceCorrectAnswers: quizApp.balanceCorrectAnswers,
    updateProgressBar: quizApp.updateProgressBar,

    startQuiz: function(continueFromSavedState) {
        if (!this.validatedStudentCode) {
            alert("Erro! Tente fazer login novamente.");
            showCard('intro-card', document.querySelector('.tab-inicio'));
            return;
        }
        
        if (continueFromSavedState) { 
            this.loadQuizState(this.validatedStudentCode); 
        } 
        else {
            this.currentQuestionIndex = 0;
            this.score = 0;
            this.userAnswers = {};
            this.skippedQuestions = [];
            this.currentSkippedIndex = 0;
            this.balanceCorrectAnswers();
            localStorage.removeItem(`vocabQuizState_${this.validatedStudentCode}`); 
            this.shuffledQuestions = this.shuffleArray([...this.questions]);
        }
        
        this.displayQuestion();
    },

    displayQuestion: function() {
        this.updateProgressBar();
        if (this.elements.performanceDisplay) this.elements.performanceDisplay.style.display = 'none';
        if (this.elements.justificationContainer) this.elements.justificationContainer.innerHTML = '';
        if (this.elements.hintText) this.elements.hintText.style.display = 'none';
        if (this.elements.summaryText) this.elements.summaryText.style.display = 'none';
        if (this.elements.summaryButton) this.elements.summaryButton.style.display = 'none';
        if (this.elements.nextButton) this.elements.nextButton.style.display = 'none';

        if (this.elements.translationDisplay) this.elements.translationDisplay.style.display = 'none'; 
        if (this.elements.translateButton) {
            this.elements.translateButton.style.display = 'inline-block'; 
            this.elements.translateButton.disabled = false;
            this.elements.translateButton.textContent = 'üåê'; 
        }
        
        if (this.elements.audioContainer) this.elements.audioContainer.innerHTML = ''; 
        if (this.elements.audioPlayContainer) this.elements.audioPlayContainer.innerHTML = ''; 
        if (this.elements.questionText) this.elements.questionText.style.display = 'flex'; 
        if (this.elements.questionText) this.elements.questionText.classList.remove('question-content'); 

        this.hintLevel = 0; 
        if (this.elements.hintButton) {
            this.elements.hintButton.textContent = 'Dica'; 
            this.elements.hintButton.style.background = ''; 
            this.elements.hintButton.disabled = false; 
            this.elements.hintButton.onclick = () => this.showHint(); 
        }
        
        let questionToDisplay;
        let currentQuestionNumber;
        let totalAnswered = (this.currentQuestionIndex - this.skippedQuestions.length) + this.currentSkippedIndex;

        if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0 && this.currentSkippedIndex < this.skippedQuestions.length) {
            const skippedIndex = this.skippedQuestions[this.currentSkippedIndex];
            questionToDisplay = this.questions[skippedIndex]; 
            currentQuestionNumber = `(Pulada ${this.currentSkippedIndex + 1}/${this.skippedQuestions.length})`
            if (this.elements.skipButton) this.elements.skipButton.style.display = 'none';
        } else if (this.currentQuestionIndex < this.shuffledQuestions.length) {
            questionToDisplay = this.shuffledQuestions[this.currentQuestionIndex];
            currentQuestionNumber = totalAnswered + 1;
            if (this.elements.skipButton) this.elements.skipButton.style.display = 'inline-block';
        } else {
            this.showResults();
            return;
        }
        
        // CORRIGIDO: Adicionado o marcador (topic) da quest√£o
        if (this.elements.currentQuestionNumSpan) {
            const markerText = questionToDisplay.topic ? `<span style="font-weight: bold; color: #155724; display: inline-block; margin-left: 10px;"> - ${questionToDisplay.topic}</span>` : '';
            this.elements.currentQuestionNumSpan.innerHTML = `${currentQuestionNumber} de ${this.questions.length} ${markerText}`; 
        }
        
        if (this.elements.optionsList) this.elements.optionsList.innerHTML = '';

        switch (questionToDisplay.type) {
            case 'fill-in': this.renderFillIn(questionToDisplay); break;
            case 'drag-drop': this.renderDragDrop(questionToDisplay); break;
            case 'tf': this.renderMCQ(questionToDisplay); break;
            case 'audio_mcq': this.renderAudioMCQ(questionToDisplay); break; 
            case 'mcq': default: this.renderMCQ(questionToDisplay); break;
        }
    },

    renderAudioMCQ: function(question) {
        if (this.elements.audioContainer) this.elements.audioContainer.innerHTML = ''; 
        const audioEl = document.createElement('audio');
        audioEl.src = question.audioSrc;
        audioEl.preload = 'auto'; 
        if (this.elements.audioContainer) this.elements.audioContainer.appendChild(audioEl);

        if (this.elements.audioPlayContainer) this.elements.audioPlayContainer.innerHTML = ''; 
        const playBtn = document.createElement('button');
        playBtn.className = 'btn audio-play-btn';
        playBtn.textContent = 'Ouvir Quest√£o üéß';
        playBtn.onclick = () => audioEl.play();
        if (this.elements.audioPlayContainer) this.elements.audioPlayContainer.appendChild(playBtn);
        
        if (this.elements.translateButton) this.elements.translateButton.style.display = 'none';

        this.renderMCQ(question);
    },

    renderMCQ: function(question) {
        if (this.elements.questionText) {
            this.elements.questionText.innerHTML = ''; 
            this.elements.questionText.classList.add('question-content'); 
            this.elements.questionText.textContent = question.question;
        }
        
        if (this.elements.translateButton) {
            if (question.type !== 'audio_mcq') {
                this.elements.translateButton.style.display = 'inline-block';
            } else {
                this.elements.translateButton.style.display = 'none';
            }
        }

        if (this.elements.optionsList) {
            question.options.forEach(option => {
                const li = document.createElement('li');
                li.className = 'option-item';
                li.textContent = option.text;
                li.onclick = () => this.selectOption(li, option);
                this.elements.optionsList.appendChild(li);
            });
        }
    },

    renderFillIn: function(question) {
        if (this.elements.questionText) {
            this.elements.questionText.innerHTML = ''; 
            this.elements.questionText.classList.add('question-content'); 
            this.elements.questionText.textContent = question.question;
        }
        if (this.elements.translateButton) this.elements.translateButton.style.display = 'inline-block'; 
        
        if (this.elements.optionsList) {
            const input = document.createElement('input');
            input.id = 'fill-in-input'; 
            input.placeholder = 'Digite sua resposta...';
            const checkButton = document.createElement('button');
            checkButton.textContent = 'Verificar';
            checkButton.className = 'btn check-btn';
            checkButton.onclick = () => {
                const userAnswer = input.value.trim().toLowerCase();
                const isCorrect = question.answer.map(ans => ans.toLowerCase()).includes(userAnswer);
                this.handleAnswer(isCorrect, question.rationale, input.value.trim(), question.answer[0]);
                input.disabled = true;
                checkButton.style.display = 'none';
                input.classList.add(isCorrect ? 'correct' : 'incorrect');
            };
            this.elements.optionsList.appendChild(input);
            this.elements.optionsList.appendChild(checkButton);
        }
    },

    renderDragDrop: function(question) {
        if (this.elements.questionText) this.elements.questionText.classList.add('question-content'); 

        const dropZone = document.createElement('span');
        dropZone.id = 'drop-zone';
        dropZone.textContent = 'Arraste aqui';
        const questionTextHTML = `<div class="question-content-text">${question.question.replace('______', dropZone.outerHTML)}</div>`;
        if (this.elements.questionText) this.elements.questionText.innerHTML = questionTextHTML; 
        if (this.elements.translateButton) this.elements.translateButton.style.display = 'inline-block'; 
        
        const actualDropZone = this.elements.questionText ? this.elements.questionText.querySelector('#drop-zone') : null;
        
        if (this.elements.optionsList) {
            const dragOptionsWrapper = document.createElement('div');
            dragOptionsWrapper.className = 'drag-options-wrapper';
            this.shuffleArray(question.options).forEach(opt => {
                const optionEl = document.createElement('span');
                optionEl.textContent = opt;
                optionEl.className = 'drag-option';
                optionEl.draggable = true;
                optionEl.dataset.value = opt;
                
                // Adicionado suporte para arrastar e soltar (drag and drop)
                optionEl.ondragstart = (e) => { e.dataTransfer.setData('text/plain', e.target.dataset.value); e.target.classList.add('dragging'); };
                optionEl.ondragend = (e) => e.target.classList.remove('dragging');

                // Suporte b√°sico a touch (mobile)
                optionEl.ontouchstart = (e) => {
                    e.preventDefault(); 
                    e.target.classList.add('dragging');
                    this.dragTouchData = { value: e.target.dataset.value, element: e.target };
                };
                optionEl.ontouchmove = (e) => {
                    if (this.dragTouchData) {
                        const touch = e.touches[0];
                        this.dragTouchData.element.style.position = 'absolute';
                        this.dragTouchData.element.style.zIndex = 1000;
                        this.dragTouchData.element.style.left = `${touch.pageX - this.dragTouchData.element.offsetWidth / 2}px`;
                        this.dragTouchData.element.style.top = `${touch.pageY - this.dragTouchData.element.offsetHeight / 2}px`;
                    }
                };
                optionEl.ontouchend = (e) => {
                    if (this.dragTouchData) {
                        this.dragTouchData.element.classList.remove('dragging');
                        this.dragTouchData.element.style.position = '';
                        this.dragTouchData.element.style.zIndex = '';
                        this.dragTouchData.element.style.left = '';
                        this.dragTouchData.element.style.top = '';

                        const touch = e.changedTouches[0];
                        const target = document.elementFromPoint(touch.clientX, touch.clientY);

                        if (target && target.id === 'drop-zone') {
                            const isCorrect = (this.dragTouchData.value.toLowerCase() === question.answer.toLowerCase());
                            this.handleAnswer(isCorrect, question.rationale, this.dragTouchData.value, question.answer);
                            target.textContent = this.dragTouchData.value;
                            target.classList.add(isCorrect ? 'correct' : 'incorrect');
                            this.elements.optionsList.querySelectorAll('.drag-option').forEach(el => { el.draggable = false; el.style.cursor = 'not-allowed'; el.style.opacity = '0.6'; });
                        }
                        this.dragTouchData = null;
                    }
                };
                
                dragOptionsWrapper.appendChild(optionEl);
            });
            this.elements.optionsList.appendChild(dragOptionsWrapper);
        }
        
        // L√≥gica de Drop (Desktop)
        if (actualDropZone) {
            actualDropZone.ondragover = (e) => { e.preventDefault(); actualDropZone.classList.add('over'); };
            actualDropZone.ondragleave = () => actualDropZone.classList.remove('over');
            actualDropZone.ondrop = (e) => {
                e.preventDefault();
                actualDropZone.classList.remove('over');
                const droppedValue = e.dataTransfer.getData('text/plain');
                const isCorrect = (droppedValue.toLowerCase() === question.answer.toLowerCase());
                this.handleAnswer(isCorrect, question.rationale, droppedValue, question.answer);
                actualDropZone.textContent = droppedValue;
                actualDropZone.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (this.elements.optionsList) this.elements.optionsList.querySelectorAll('.drag-option').forEach(el => { el.draggable = false; el.style.cursor = 'not-allowed'; el.style.opacity = '0.6'; });
            };
        }
    },

    selectOption: function(selectedElement, selectedOption) {
        if (this.elements.optionsList) this.elements.optionsList.querySelectorAll('.option-item').forEach(option => option.style.pointerEvents = 'none');
        const isCorrect = selectedOption.isCorrect;
        
        let currentQuestion;
        if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
            currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
        } else {
            currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
        }
        
        selectedElement.classList.add(isCorrect ? 'correct' : 'incorrect');
        this.handleAnswer(isCorrect, selectedOption.rationale, selectedOption.text, currentQuestion.options.find(o => o.isCorrect).text);

        if (!isCorrect) {
            const correctText = currentQuestion.options.find(opt => opt.isCorrect).text;
            const correctElement = this.elements.optionsList ? Array.from(this.elements.optionsList.querySelectorAll('.option-item')).find(el => el.textContent === correctText) : null;
            if (correctElement) correctElement.classList.add('correct');
        }
    },

    handleAnswer: function(isCorrect, rationale, userAnswer, correctAnswer) {
        if (isCorrect) {
            this.score++;
            if (this.elements.summaryButton) this.elements.summaryButton.style.display = 'none';
        } else {
            if (this.elements.summaryButton) this.elements.summaryButton.style.display = 'inline-block';
        }
        const justificationElement = document.createElement('div');
        justificationElement.className = 'justification';
        justificationElement.innerHTML = rationale; 
        justificationElement.style.borderLeftColor = isCorrect ? '#28a745' : '#dc3545';
        if (this.elements.justificationContainer) this.elements.justificationContainer.appendChild(justificationElement);
        
        let originalQuestionIndex;
        let currentQuestion;
         if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
            originalQuestionIndex = this.skippedQuestions[this.currentSkippedIndex];
            currentQuestion = this.questions[originalQuestionIndex];
        } else {
            currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
            originalQuestionIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
        }
        
        this.userAnswers[originalQuestionIndex] = {
            question: currentQuestion.question, 
            userAnswer: userAnswer,
            isCorrect: isCorrect,
            correctAnswer: correctAnswer,
            rationale: rationale,
            type: currentQuestion.type || 'mcq',
            topic: currentQuestion.topic || 'Geral' 
        };
        
        if (this.elements.nextButton) this.elements.nextButton.style.display = 'block';
        if (this.elements.skipButton) this.elements.skipButton.style.display = 'none';
        this.saveQuizState();
    },

    showPerformance: function() {
        const display = this.elements.performanceDisplay;
        if (!display) return;
        
        if (display.style.display === 'block') {
            display.style.display = 'none';
        } else {
            const answeredCount = Object.keys(this.userAnswers).length;
            const incorrectCount = answeredCount - this.score;
            display.innerHTML = `<strong style="color: #333;">At√© agora:</strong> <span style="color: #28a745;">${this.score} acertos</span> <strong style="color: #333;">e</strong> <span style="color: #dc3545;">${incorrectCount} erros</span><strong style="color: #333;">!</strong>`;
            display.style.display = 'block';
            if (this.elements.hintText) this.elements.hintText.style.display = 'none';
            if (this.elements.summaryText) this.elements.summaryText.style.display = 'none';
        }
    },
    
    showHint: function() {
        const display = this.elements.hintText;
        const button = this.elements.hintButton; 
        if (!display || !button) return;

        let currentQuestion;
        
        if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
            currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
        } else {
            currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
        }

        if (this.elements.performanceDisplay) this.elements.performanceDisplay.style.display = 'none';
        if (this.elements.summaryText) this.elements.summaryText.style.display = 'none';

        let hint1 = currentQuestion.hint || "Sem dica dispon√≠vel.";
        let hint2 = currentQuestion.hint_2 || ""; 

        if (hint2) {
            if (this.hintLevel === 0) { 
                display.innerHTML = hint1; 
                display.style.display = 'block';
                button.textContent = 'DICA 2'; 
                this.hintLevel = 1; 
            } else if (this.hintLevel === 1) { 
                display.innerHTML = hint1 + '<br><br>' + hint2;
                display.style.display = 'block';
                button.textContent = 'Ocultar Dicas'; 
                button.style.background = 'linear-gradient(45deg, #28a745, #218838)';
                this.hintLevel = 2; 
            } else { 
                display.style.display = 'none';
                button.textContent = 'Dica';
                button.style.background = ''; 
                this.hintLevel = 0; 
            }
        } else { 
            if (display.style.display === 'block') {
                display.style.display = 'none';
            } else {
                if (currentQuestion && currentQuestion.hint) {
                    display.innerHTML = currentQuestion.hint;
                    display.style.display = 'block';
                }
            }
        }
    },
    
    showSummary: function() {
        const display = this.elements.summaryText;
        if (!display) return;

        if (display.style.display === 'block') {
            display.style.display = 'none';
        } else {
            let currentQuestion;
            if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
                currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
            } else {
                currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
            }
            const questionTopic = currentQuestion.topic;
            if (questionTopic && this.summaries[questionTopic]) {
                display.textContent = this.summaries[questionTopic];
                display.style.display = 'block';
                if (this.elements.performanceDisplay) this.elements.performanceDisplay.style.display = 'none';
                if (this.elements.hintText) this.elements.hintText.style.display = 'none';
            }
        }
    },

    translateQuestion: function() {
        const button = this.elements.translateButton;
        const display = this.elements.translationDisplay;
        if (!button || !display) return;
        
        let currentQuestion;
        if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
            currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
        } else {
            currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
        }

        if (display.style.display === 'block') {
            display.style.display = 'none';
            button.textContent = 'üåê';
            return;
        }
        
        let textToTranslate;
        if (currentQuestion.type === 'drag-drop' && this.elements.questionText && this.elements.questionText.querySelector('.question-content-text')) {
            textToTranslate = this.elements.questionText.querySelector('.question-content-text').textContent;
        } else if (this.elements.questionText) {
            textToTranslate = this.elements.questionText.textContent;
        } else {
             display.textContent = 'Erro: Texto da quest√£o n√£o encontrado.';
             display.style.display = 'block';
             return;
        }


        display.textContent = 'Traduzindo...';
        display.style.display = 'block';
        button.disabled = true;

        const langPair = 'en|pt'; 
        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=${langPair}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data && data.responseData && data.responseData.translatedText) {
                    display.textContent = data.responseData.translatedText;
                } else {
                    display.textContent = 'Erro ao traduzir. Tente novamente.';
                }
                button.disabled = false;
                button.textContent = 'üôà'; 
            })
            .catch(error => {
                console.error('Translation error:', error);
                display.textContent = 'N√£o foi poss√≠vel conectar ao servi√ßo de tradu√ß√£o.';
                button.disabled = false;
                button.textContent = 'üåê';
            });
    },

    nextQuestion: function() {
        if (this.currentQuestionIndex < this.shuffledQuestions.length) {
            this.currentQuestionIndex++;
        } else {
            this.currentSkippedIndex++;
        }
        if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.currentSkippedIndex >= this.skippedQuestions.length) {
            this.showResults();
        } else {
            this.displayQuestion();
        }
    },

    skipQuestion: function() {
        if (this.currentQuestionIndex < this.shuffledQuestions.length) {
            let currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
            const originalIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
            if (!this.skippedQuestions.includes(originalIndex)) {
                this.skippedQuestions.push(originalIndex);
            }
        }
        this.currentQuestionIndex++;
        if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length === 0) {
            this.showResults();
        } else {
            this.displayQuestion();
        }
    },

    getClassification: function(percentage) {
        if (percentage >= 86) return "Excelente!!!"; if (percentage >= 71) return "Muito Bom!!"; if (percentage >= 51) return "Bom!"; if (percentage >= 0) return "Insatisfat√≥rio!"; return "";
    },
    launchConfetti: function() { confetti({ particleCount: 600, spread: 70, origin: { y: 0.6 } }); },

    showResults: function() {
        const percentage = Math.round((this.score / this.questions.length) * 100);
        const classificationText = this.getClassification(percentage);

        const reportData = {
            isCompleted: true, 
            studentName: this.validatedStudentName,
            studentCode: this.validatedStudentCode,
            score: this.score,
            totalQuestions: this.questions.length,
            percentage: percentage,
            classification: classificationText,
            userAnswers: this.userAnswers,
            originalQuestions: this.questions,
            quizTitle: "VOCABULARY QUIZ"
        };

        this.saveCompletedReport(reportData); 
        this.saveFinalReport(reportData);     
        this.displayReport(reportData);

        const dataForGoogle = { 
            nome: this.validatedStudentName, 
            codigo: this.validatedStudentCode, 
            pontuacao: `(VOCAB) ${this.score} de ${this.questions.length}`, 
            percentual: `${percentage}%`, 
            classificacao: classificationText 
        };
        
        fetch(this.APP_SCRIPT_URL, { method: 'POST', body: JSON.stringify(dataForGoogle), headers: { 'Content-Type': 'application/json' }, mode: 'no-cors' })
            .catch(error => console.error('Erro no Vocab Quiz:', error));
    },

    saveCompletedReport: function(reportData) {
        if (!reportData.studentCode) return;
        try {
            localStorage.setItem(`vocabQuizState_${reportData.studentCode}`, JSON.stringify(reportData));
        } catch (e) {
            console.error("N√£o foi poss√≠vel salvar o estado do quiz:", e);
        }
    },

    saveFinalReport: function(reportData) {
        if (!reportData.studentCode) return;
        try {
            localStorage.setItem(`vocabQuizReport_${reportData.studentCode}`, JSON.stringify(reportData));
        } catch (e) {
            console.error("N√£o foi poss√≠vel salvar o relat√≥rio final permanente:", e);
        }
    },

    displayReport: function(data) {
        showCard('results-card', document.getElementById('results-tab-btn'));

        this.validatedStudentName = data.studentName;
        this.validatedStudentCode = data.studentCode;
        this.score = data.score;
        this.userAnswers = data.userAnswers;
        this.questions = data.originalQuestions; 

        if (this.elements.reportStudentName) this.elements.reportStudentName.textContent = data.studentName;
        if (this.elements.reportStudentCode) this.elements.reportStudentCode.textContent = data.studentCode;
        if (this.elements.scoreDisplay) this.elements.scoreDisplay.textContent = `${data.score} de ${data.totalQuestions}`;
        if (this.elements.percentageDisplay) this.elements.percentageDisplay.textContent = `${data.percentage}%`;
        if (this.elements.classificationDisplay) this.elements.classificationDisplay.textContent = data.classification;
        
        if (data.classification === "Excelente!!!") this.launchConfetti();
        
        if (this.elements.fullReportContainer) this.elements.fullReportContainer.innerHTML = quizApp.generateFullReportHtml.call(this); 
        if (this.elements.personalReportContainer) this.elements.personalReportContainer.innerHTML = quizApp.generatePersonalReportHtml.call(this); 
        
        const shareMessage = this.generateShareMessage(data.percentage, data.classification);
        if (this.elements.shareWhatsappLink) this.elements.shareWhatsappLink.href = `https://wa.me/?text=${encodeURIComponent(shareMessage)}`;
        
        if (this.elements.sendReportLink) {
            this.elements.sendReportLink.textContent = 'Relat√≥rio Enviado (Vocab)'; 
            this.elements.sendReportLink.style.background = 'linear-gradient(45deg, #155724, #28a745)';
            this.elements.sendReportLink.onclick = (e) => {
                 e.preventDefault();
                 alert('Envio autom√°tico j√° realizado. Clique em "Reiniciar Teste" para voltar.');
            };
        }
    },

    retrieveReport: function(code) {
        const finalReportJSON = localStorage.getItem(`vocabQuizReport_${code}`);
        if (!finalReportJSON) {
            alert('Erro: Relat√≥rio de vocabul√°rio n√£o encontrado.');
            return;
        }
        
        try {
            const state = JSON.parse(finalReportJSON);
            if (state.isCompleted) {
                this.displayReport(state); 
                
                if (this.elements.sendReportLink) {
                    this.elements.sendReportLink.textContent = 'Relat√≥rio J√° Enviado';
                    this.elements.sendReportLink.style.background = '#ccc';
                    this.elements.sendReportLink.onclick = (e) => e.preventDefault();
                }
            } else {
                alert('O relat√≥rio salvo √© inv√°lido.');
            }
        } catch (e) {
            alert('Erro ao carregar relat√≥rio.');
            localStorage.removeItem(`vocabQuizReport_${code}`); 
        }
    },

    getCorrectAnswerForQuestion: quizApp.getCorrectAnswerForQuestion, 
    generateFullReportHtml: quizApp.generateFullReportHtml, 
    analyzePerformanceByTopic: quizApp.analyzePerformanceByTopic, 
    generatePersonalReportHtml: quizApp.generatePersonalReportHtml, 
    printPersonalReport: quizApp.printPersonalReport, 
    printReport: quizApp.printReport, 
    
    generateShareMessage: function(percentage, classificationText) {
        return `Acabei de fazer o quiz "Quiz - Vocabulary"! Meu resultado: ${percentage}% (${classificationText}).`;
    },
    
    saveQuizState: function() {
        if (!this.validatedStudentCode) return;
        const state = {
            isCompleted: false, 
            currentQuestionIndex: this.currentQuestionIndex,
            score: this.score,
            userAnswers: this.userAnswers,
            skippedQuestions: this.skippedQuestions,
            currentSkippedIndex: this.currentSkippedIndex,
            shuffledQuestions: this.shuffledQuestions
        };
        try {
            localStorage.setItem(`vocabQuizState_${this.validatedStudentCode}`, JSON.stringify(state));
        } catch (e) {
            console.error("N√£o foi poss√≠vel salvar o estado do quiz:", e);
        }
    },

    loadQuizState: function(studentCode) {
        try {
            const savedState = localStorage.getItem(`vocabQuizState_${studentCode}`);
            if (savedState) {
                const state = JSON.parse(savedState);
                if (!state.isCompleted) {
                    this.currentQuestionIndex = state.currentQuestionIndex;
                    this.score = state.score;
                    this.userAnswers = state.userAnswers;
                    this.skippedQuestions = state.skippedQuestions;
                    this.currentSkippedIndex = state.currentSkippedIndex;
                    this.shuffledQuestions = state.shuffledQuestions; 
                    return true;
                }
            }
        } catch (e) {
            console.error("N√£o foi poss√≠vel carregar o estado do quiz:", e);
            localStorage.removeItem(`vocabQuizState_${studentCode}`); 
        }
        return false; 
    },
    
    restartQuiz: quizApp.restartQuiz, 
    saveReport: function() {
        const studentName = this.validatedStudentName;
        const studentCode = this.validatedStudentCode;
        const score = this.elements.scoreDisplay ? this.elements.scoreDisplay.textContent : 'N/A';
        const percentage = this.elements.percentageDisplay ? this.elements.percentageDisplay.textContent : 'N/A';
        const classification = this.elements.classificationDisplay ? this.elements.classificationDisplay.textContent : 'N/A';
        
        const detailedReportHtml = quizApp.generateFullReportHtml.call(this);
        const personalReportHtml = quizApp.generatePersonalReportHtml.call(this);


        const fullHtmlContent = `
            <!DOCTYPE html>
            <html lang="pt-BR">
            <head>
                <meta charset="UTF-BOM">
                <title>Relat√≥rio - ${studentName}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                    h1, h3 { color: #155724; }
                    h4 { color: #856404; }
                    p { margin: 5px 0; }
                    .report-question-item { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; page-break-inside: avoid; }
                    .option-item-report.correct { background-color: #d4edda; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                    .option-item-report.incorrect { background-color: #f8d7da; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                    .personal-summary-item { background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; padding: 15px; margin-bottom: 15px; page-break-inside: avoid; }
                    #print-personal-btn { display: none; } 
                </style>
            </head>
            <body>
                <h1>Relat√≥rio Final - Quiz - Vocabulary</h1>
                <p><strong>Nome:</strong> ${studentName}</p>
                <p><strong>C√≥digo de Acesso:</strong> ${studentCode}</p>
                <p><strong>Pontua√ß√£o:</strong> ${score}</p>
                <p><strong>Percentual de Acerto:</strong> ${percentage}</p>
                <p><strong>Classifica√ß√£o:</strong> ${classification}</p>
                <hr>
                <div id="personal-report-container">
                    ${personalReportHtml}
                </div>
                <hr>
                <div id="full-report-container">
                    ${detailedReportHtml}
                </div>
            </body>
            </html>
        `;

        const blob = new Blob([fullHtmlContent], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Relatorio_Vocab_${studentName.replace(' ', '_')}_${studentCode}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    },
    
    init: function() {
        // ADI√á√ÉO DE VERIFICA√á√ïES DE SEGURAN√áA PARA EVITAR TRAVAMENTO
        if (this.elements.translateButton) this.elements.translateButton.onclick = () => this.translateQuestion();
        if (this.elements.performanceButton) this.elements.performanceButton.onclick = () => this.showPerformance();
        if (this.elements.hintButton) this.elements.hintButton.onclick = () => this.showHint();
        if (this.elements.summaryButton) this.elements.summaryButton.onclick = () => this.showSummary();
        if (this.elements.nextButton) this.elements.nextButton.onclick = () => this.nextQuestion();
        if (this.elements.skipButton) this.elements.skipButton.onclick = () => this.skipQuestion();
    }
};


// --- FUN√á√ïES DO MODAL DE CONTE√öDO (PDF) ---

function openReadModal(pdfLink, title) {
    const modalBody = document.getElementById('modal-body');
    const modalTitle = document.getElementById('modal-title');
    if (modalBody) modalBody.innerHTML = ''; 
    if (modalTitle) modalTitle.textContent = title || 'Material de Estudo';
    
    if (pdfLink && pdfLink !== 'COLE_O_LINK_DA_APOSTILA_AQUI' && pdfLink !== 'COLE_O_LINK_DO_ROTEIRO_AQUI') {
        const iframe = document.createElement('iframe');
        iframe.src = pdfLink;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        if (modalBody) modalBody.appendChild(iframe);
    } else {
        if (modalBody) modalBody.innerHTML = '<p style="padding: 20px; text-align: center;">Erro: Link do PDF n√£o encontrado ou n√£o configurado.</p>';
    }
    
    const modalOverlay = document.getElementById('modal-overlay');
    if (modalOverlay) modalOverlay.style.display = 'flex';
}

function closeReadModal() {
    const modalOverlay = document.getElementById('modal-overlay');
    const modalBody = document.getElementById('modal-body');
    const modalContent = document.getElementById('modal-content');
    const btn = document.getElementById('night-mode-toggle');

    if (modalOverlay) modalOverlay.style.display = 'none';
    if (modalBody) modalBody.innerHTML = ''; // Limpa o iframe
    if (modalContent) modalContent.classList.remove('night-mode');
    if (btn) btn.textContent = 'Modo Noturno üåô';
}

function toggleNightMode() {
    const modalContent = document.getElementById('modal-content');
    const btn = document.getElementById('night-mode-toggle');
    
    if (modalContent) modalContent.classList.toggle('night-mode');
    
    if (btn && modalContent) {
        if (modalContent.classList.contains('night-mode')) {
            btn.textContent = 'Modo Claro ‚òÄÔ∏è';
        } else {
            btn.textContent = 'Modo Noturno üåô';
        }
    }
}

function downloadContent(pdfLink) {
     if (pdfLink && pdfLink !== 'COLE_O_LINK_DA_APOSTILA_AQUI' && pdfLink !== 'COLE_O_LINK_DO_ROTEIRO_AQUI') {
        let downloadLink = pdfLink.replace("/preview", "/view"); 
        
        if (pdfLink.includes('archive.org')) {
            downloadLink = pdfLink;
        } else if (pdfLink.includes('drive.google.com')) {
             downloadLink = pdfLink.replace("/preview", "/view?usp=sharing"); 
        }
        
        const a = document.createElement('a');
        a.href = downloadLink; 
        a.target = '_blank'; 
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    } else {
        alert('Nenhum material em PDF dispon√≠vel para download.');
    }
}


// --- INICIALIZA√á√ÉO ---

document.addEventListener("DOMContentLoaded", function() {
    const intro = document.getElementById("intro-card");
    if (intro) {
        intro.style.display = "flex";
        intro.style.flexDirection = "column";
    }
});

window.onload = function() {
    quizApp.init(); 
    vocabQuizApp.init(); 
    
    if (document.getElementById('modal-close-btn')) document.getElementById('modal-close-btn').onclick = closeReadModal;
    if (document.getElementById('night-mode-toggle')) document.getElementById('night-mode-toggle').onclick = toggleNightMode;
    
    const modalOverlay = document.getElementById('modal-overlay');
    if (modalOverlay) {
        modalOverlay.onclick = function(event) {
            if (event.target == modalOverlay) {
                closeReadModal();
            }
        };
    }

    const firstBtn = document.querySelector('.tablinks');
    if (firstBtn) {
        showCard('intro-card', firstBtn);
    } else {
        showCard('intro-card', null); 
    }
};
// --------------------------------------------------------------------
// FIM DO BLOCO DE C√ìDIGO DO QUIZ
// --------------------------------------------------------------------
    </script>
</body>

</html>
