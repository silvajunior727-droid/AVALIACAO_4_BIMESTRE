<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Estudos - 3¬∫ Ano (Pronouns & Family)</title>
    <style>
        /* CSS COMPLETO DO PROT√ìTIPO M√âDIO/ALTO */
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f1f8 100%);
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px;
            min-height: 400px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            background: linear-gradient(45deg, #dc3545, #d90429);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 20px;
        }
        h2 { text-align: center; color: #444; }

        /* --- Controle de Abas e Cards --- */
        .question-card, .results-card, .intro-card, #roteiro-content-tab, #apostila-content-tab, #vocab-quiz-card { 
            display: none; 
            flex-direction: column; 
        }
        
        .intro-card { 
            text-align: center; 
        }
        .intro-card input { padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; }
        
        #student-code {
            text-transform: uppercase;
        }

        /* --- (NOVO) Estilo de Abas de Navega√ß√£o (Colorido) --- */
        .tab-buttons {
            display: flex;
            flex-wrap: wrap; /* Permite quebra de linha */
            justify-content: space-around;
            margin-bottom: 25px;
            gap: 8px; /* Espa√ßamento entre os bot√µes */
        }
        .tab-buttons button {
            border: 1px solid transparent; /* Borda sutil */
            font-weight: 600;
            padding: 12px 10px; /* Mais preenchimento */
            border-radius: 8px;
            transition: all 0.3s ease;
            flex-grow: 1; /* Ocupa espa√ßo igual */
            flex-basis: 180px; /* Largura m√≠nima (cria 2 ou 3 colunas) */
            text-align: center;
            cursor: pointer;
            font-size: 0.95rem; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Cores Espec√≠ficas das Abas (Inativas) */
        .tab-buttons .tab-inicio { 
            background-color: #e9ecef; /* Cinza claro */
            color: #495057; /* Cinza escuro */
            border-color: #dee2e6;
        }
        .tab-buttons .tab-quiz-g { 
            background-color: #e6f2ff; /* Azul claro */
            color: #0056b3; /* Azul escuro */
            border-color: #b3d7ff;
        }
        .tab-buttons .tab-quiz-v { 
            background-color: #eafff0; /* Verde claro */
            color: #155724; /* Verde escuro */
            border-color: #b9f0c8;
        }
        .tab-buttons .tab-roteiro { 
            background-color: #fdf5e6; /* Creme */
            color: #c55a11; /* Laranja escuro */
            border-color: #fce3c0;
        }
        .tab-buttons .tab-apostila { 
            background-color: #f4efff; /* Lil√°s claro */
            color: #3b1c6b; /* Roxo escuro */
            border-color: #dcd0ff;
        }
        .tab-buttons .tab-resultados { 
            background-color: #ffeef0; /* Rosa claro */
            color: #721c24; /* Vermelho escuro */
            border-color: #ffd0d6;
        }
        
        .tab-buttons button:hover {
            opacity: 0.85; /* Leve transpar√™ncia */
            transform: translateY(-2px); /* Efeito de levantar */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* O bot√£o ATIVO fica branco e destacado */
        .tab-buttons button.active {
            background-color: #fff; /* Fundo branco */
            color: #007bff; /* Texto azul */
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.25); /* Sombra azul */
            transform: translateY(-3px);
            opacity: 1;
            border-color: #007bff; /* Borda azul */
        }

        /* --- Estilos do Quiz --- */
        .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 25px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { width: 0%; height: 20px; background: linear-gradient(90deg, #007bff, #0056b3); text-align: center; line-height: 20px; color: white; font-weight: bold; transition: width 0.4s ease-in-out; }

        .audio-container {
            width: 100%;
            margin-bottom: 15px;
        }
        .audio-container audio {
            display: none;
        }
        
        #audio-play-container, #vocab-audio-play-container {
            width: 100%;
            text-align: center; 
            margin-bottom: 15px;
        }
        .audio-play-btn {
            background: linear-gradient(45deg, #17a2b8, #117a8b);
            color: white;
            font-size: 1.1rem;
            width: 80%;
            max-width: 300px;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .audio-play-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        /* Bot√£o de V√≠deo (estilo mantido e integrado) */
        .video-trigger-container {
            width: 100%;
            text-align: center;
            margin-bottom: 25px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px dashed #ccc;
        }
        .video-play-btn-custom { /* Novo nome para evitar conflito com .audio-play-btn */
            background-color: #FF0000;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(255, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-decoration: none;
            max-width: 100%; 
            font-family: Arial, sans-serif;
        }
        .video-play-btn-custom:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(255, 0, 0, 0.4);
            background-color: #cc0000;
        }
        .play-icon {
            width: 0; 
            height: 0; 
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 14px solid white;
        }


        .question-text-wrapper {
            display: flex;
            align-items: center; 
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.2rem;
            flex-grow: 1; 
            min-height: 50px; 
            display: flex;
            justify-content: flex-start; 
            align-items: center;
            text-align: left; 
        }

        .translate-btn {
            background: transparent; 
            border: none;            
            color: #007bff;          
            font-size: 2.5rem;       
            cursor: pointer;
            flex-shrink: 0;
            padding: 0;
            margin: 0;
            line-height: 1;
            transition: transform 0.2s; 
        }
        .translate-btn:hover {
            transform: scale(1.15); 
        }
        .translate-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }


        .translation-text {
            margin-top: -15px; 
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 5px solid #ffc107; 
            border-radius: 5px;
            font-style: italic;
            display: none; 
        }


        .options-list { list-style: none; padding: 0; margin: 0; }

        .option-item { 
            background-color: #fff;
            border: 2px solid #ccc;
            padding: 16px; 
            margin-bottom: 10px; 
            border-radius: 8px;
            cursor: pointer; 
            font-weight: 500;
            transition: all 0.2s ease; 
        }
        .option-item:hover { 
            background-color: #f8f9fa; 
            border-color: #007bff;
            color: #007bff;
            transform: scale(1.01);
        }
        .option-item.correct { 
            background-color: #d4edda; 
            border-color: #28a745; 
            color: #155724; 
            transform: scale(1.02); 
            font-weight: 700;
        }
        .option-item.incorrect { 
            background-color: #f8d7da; 
            border-color: #dc3545; 
            color: #721c24; 
            animation: shake 0.5s ease-in-out; 
            font-weight: 700;
        }

        .justification { margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-left: 5px solid #007bff; border-radius: 5px; display: block; }

        /* --- Estilo de Bot√£o Geral Aprimorado --- */
        .btn, .next-btn, .skip-btn, .hint-btn { 
            border: none; 
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer; 
            font-size: 1rem;
            font-weight: 600;
            margin-top: 20px; 
            text-decoration: none; 
            display: inline-block; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover, .next-btn:hover, .skip-btn:hover, .hint-btn:hover,
        .start-btn:hover, .restart-btn:hover, .send-report-btn:hover, 
        .print-btn:hover, .share-btn:hover, .save-report-btn:hover, 
        .continue-btn:hover, .check-btn:hover, .performance-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        
        .next-btn, .skip-btn { float: right; margin-left: 10px; }
        
        /* Gradientes nos Bot√µes */
        .next-btn { background: linear-gradient(45deg, #007bff, #0056b3); color: white; display: none; }
        .skip-btn { background: linear-gradient(45deg, #ffc107, #e0a800); color: #333; display: none; }
        .hint-btn { background: linear-gradient(45deg, #6a0dad, #510a83); color: white; float: none; }
        .hint-btn:disabled { background: #ccc; }

        .hint-text { margin-top: 15px; padding: 10px; background-color: #e9ecef; border-left: 5px solid #6c757d; border-radius: 5px; font-style: italic; display: none; white-space: pre-wrap; }

        .question-actions { display: flex; justify-content: flex-end; align-items: center; flex-wrap: wrap; margin-top: 15px; }
        
        .start-btn, .restart-btn, .send-report-btn, .print-btn, .share-btn, .save-report-btn, .continue-btn, .check-btn { 
            display: inline-block; 
            color: white; 
            border: none; 
            padding: 14px 28px; 
            border-radius: 8px;
            cursor: pointer; 
            font-size: 1rem;
            font-weight: 600;
            margin-top: 20px; 
            text-align: center; 
            text-decoration: none; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .start-btn, .continue-btn { 
            background: linear-gradient(45deg, #28a745, #218838); /* Gradiente Verde */
            animation: pulse 2s infinite; 
        }
        
        .restart-btn { 
            background: linear-gradient(45deg, #dc3545, #c82333); /* Gradiente Vermelho */
        }
        .send-report-btn { 
            background: linear-gradient(45deg, #6c757d, #5a6268); /* Gradiente Cinza */
        }
        .print-btn { 
            background: linear-gradient(45deg, #17a2b8, #117a8b); /* Gradiente Ciano */
        } 
        .share-btn { 
            background: linear-gradient(45deg, #25d366, #128C7E); /* Gradiente WhatsApp */
        }
        .share-btn img { width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; }
        .save-report-btn { 
            background: linear-gradient(45deg, #007bff, #0056b3); /* Gradiente Azul */
        }

        .results-actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        .results-card h2 { margin-bottom: 20px; }
        .results-card p { font-size: 1.1rem; line-height: 1.5; }
        .results-card .score-display { font-size: 2.2rem; font-weight: bold; color: #007bff; }

        .question-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; color: #555; }
        
        .full-report-list { margin-top: 30px; padding-top: 20px; border-top: 2px solid #ccc; }
        .full-report-list h3 { color: #007bff; }
        .report-question-item { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .report-question-item p { margin: 5px 0; }
        .report-question-item .option-item-report.correct { background-color: #d4edda; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
        .report-question-item .option-item-report.incorrect { background-color: #f8d7da; padding: 2px 5px; border-radius: 3px; font-weight: bold; }

        .classification-red { color: red; }
        .classification-blue { color: #007bff; }
        .classification-orange { color: #FFA500; font-weight: bold; animation: blink-text 1s linear infinite; }

        .performance-btn { 
            background: linear-gradient(45deg, #FFA500, #e08e00);
            color: white; 
            margin-right: auto; 
        }
        .performance-display { width: 100%; margin-top: 10px; padding: 10px; background-color: #fff3cd; border-left: 5px solid #ffc107; border-radius: 5px; font-weight: bold; color: #856404; text-align: left; display: none; }

        #fill-in-input { padding: 12px; width: 100%; border-radius: 8px; border: 2px solid #ccc; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; transition: border-color 0.2s; }
        #fill-in-input:focus { border-color: #007bff; outline: none; }
        #fill-in-input.correct { border: 2px solid #28a745; background-color: #f0fffb; }
        #fill-in-input.incorrect { border: 2px solid #dc3545; background-color: #fff5f5; }
        .check-btn { 
            background: linear-gradient(45deg, #fca311, #e69100);
            color: #14213d; 
            float: left; 
        }
        
        #drop-zone { padding: 15px 25px; border: 2px dashed #007bff; border-radius: 8px; background-color: #f8f9fa; display: inline-block; margin: 0 5px; transition: background-color 0.3s; min-width: 150px; text-align: center; font-style: italic; color: #6c757d; vertical-align: middle; }
        #drop-zone.over { background-color: #e0e9ed; }
        #drop-zone.correct { border-style: solid; border-color: #28a745; background-color: #d4edda; font-style: normal; color: #155724; }
        #drop-zone.incorrect { border-style: solid; border-color: #dc3545; background-color: #f8d7da; font-style: normal; color: #721c24; }
        
        .drag-options-wrapper { margin-top: 20px; text-align: center; }
        .drag-option { padding: 10px 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #e9ecef; cursor: move; margin: 5px; display: inline-block; user-select: none; transition: background-color 0.2s; }
        .drag-option:hover { background-color: #d1e0e6; }
        .drag-option.dragging { opacity: 0.5; }
        
        .personal-summary-item {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .personal-summary-item h4 {
            margin-top: 0;
            color: #856404;
        }
        .personal-summary-item p {
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        /* --- ESTILOS DA ABA DE CONTE√öDO (PDF) --- */
        #roteiro-content-tab, #apostila-content-tab {
            text-align: left; /* Alinhamento padr√£o */
            padding: 10px;
            line-height: 1.6;
        }

        /* Painel de Admin (Deixado para flexibilidade, mas oculto por padr√£o) */
        .admin-panel { display: none; }
        
        /* --- ESTILOS DO MODAL DE LEITURA --- */
        .modal-overlay {
            display: none; /* Escondido por padr√£o */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .modal-header h2 {
            margin: 0;
            color: #007bff;
        }
        .modal-close-btn {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #333;
        }
        .btn-night-mode {
            background: #495047;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-night-mode:hover {
            background: #343a40;
        }
        .modal-body {
            padding: 0;
            height: 70vh;
            overflow: hidden;
            line-height: 1.6;
            text-align: left;
        }
        
        /* ESTILOS DO MODO NOTURNO */
        .modal-content.night-mode {
            background-color: #2c2c2c;
            color: #f1f1f1;
            border-color: #555;
        }
        .modal-content.night-mode .modal-header { border-bottom-color: #555; }
        .modal-content.night-mode .modal-header h2 { color: #58a6ff; }
        .modal-content.night-mode .modal-close-btn { color: #999; }
        .modal-content.night-mode .modal-close-btn:hover { color: #f1f1f1; }
        

        /* --- Anima√ß√µes e Mobile (Totalmente compat√≠vel com o prot√≥tipo m√©dio/alto) --- */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); } 50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5); } 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); } }
        @keyframes blink-text { 50% { opacity: 0; } }

        @media (max-width: 600px) {
            body { padding-top: 15px; }
            .container { width: 95%; padding: 15px; min-height: 0; }
            h1 { font-size: 2.2rem; }
            .tab-buttons button { padding: 10px 5px; font-size: 0.8rem; flex-basis: 100px; }
            .question-text { font-size: 1.1rem; }
            .translate-btn { font-size: 2.0rem; padding-left: 10px; }
            .option-item { padding: 12px; }
            .btn, .next-btn, .skip-btn, .hint-btn, .check-btn { padding: 14px 20px; font-size: 1rem; }
            
            .question-actions { flex-direction: column; align-items: stretch; gap: 5px; } /* Ajuste gap para mobile */

            .next-btn, .skip-btn { float: none; width: 100%; margin-left: 0; margin-top: 10px; box-sizing: border-box; }
            .check-btn { float: none; width: 100%; margin-top: 10px; box-sizing: border-box; }

            #performance-btn, #summary-button, #hint-button, #vocab-performance-btn, #vocab-summary-button, #vocab-hint-button { width: 100%; margin-top: 10px; box-sizing: border-box; }
            #performance-btn, #vocab-performance-btn { margin-right: 0; order: 3; }
            #summary-button, #vocab-summary-button { order: 2; }
            #hint-button, #vocab-hint-button { order: 1; }
            
            .results-actions { flex-direction: column; gap: 10px; }
            .results-actions .btn, .results-actions .send-report-btn, .results-actions .restart-btn, .results-actions .share-btn { width: 100%; margin: 5px 0; box-sizing: border-box; }
        }
        
    </style>
</head>
<body>

    <div class="container">
        
        <h1>AVALIA√á√ÉO DO 4¬∫ BIMESTRE!!!</h1>

        <div class="tab-buttons">
            <button class="tablinks tab-inicio" onclick="showCard('intro-card', this)">In√≠cio</button>
            <button class="tablinks tab-quiz-g" onclick="checkLoginAndShow('question-card', this)">Quiz - Grammar</button>
            <button class="tablinks tab-quiz-v" onclick="startVocabQuiz(this)">Quiz - Vocabulary</button>
            <button class="tablinks tab-roteiro" onclick="checkLoginAndShow('roteiro-content-tab', this)">Roteiro de Estudos</button>
            <button class="tablinks tab-apostila" onclick="checkLoginAndShow('apostila-content-tab', this)">Apostila Conclu√≠da</button>
            <button id="results-tab-btn" class="tablinks tab-resultados" onclick="checkLoginAndShowResults('results-card', this)">Resultados</button>
        </div>

        <div class="video-trigger-container">
            <p style="margin-top: 0; color: #555; font-size: 0.9rem; margin-bottom: 10px; font-weight: bold;">Material Complementar de Apoio:</p>
            <button class="video-play-btn-custom" onclick="openVideoLink()">
                <div class="play-icon"></div> ASSISTIR V√çDEO AULA
            </button>
        </div>
        <div id="intro-card" class="intro-card">
            <h2>English Grammar and Vocabulary Quiz</h2> 
            <p id="personalized-welcome" style="font-size: 1.2rem; font-weight: bold; margin-top: 10px; display: none; color: #dc3545;">Seja bem-vindo(a) e boa sorte!</p>
            <p id="quiz-description">Por favor, insira seu c√≥digo de acesso para iniciar o teste. Voc√™ tem tentativas <span id="intro-attempts-left">ilimitadas</span> para fazer este teste.</p>
            <input type="text" id="student-code" placeholder="Your Access Code!">
            <div id="start-actions">
                <button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>
            </div>
        </div>

        <div id="question-card" class="question-card">
<h2 style="text-align:center; color:#0056b3; margin-bottom:20px;">Quiz - Grammar</h2>
            <div id="progress-bar-container" class="progress-bar-container">
                <div id="progress-bar" class="progress-bar">0%</div>
            </div>
            <div class="question-header">
                <span class="question-counter"><span id="current-question-num">1</span> de 20</span>
                <span class="attempts-counter" style="display: none;">Tentativas restantes: <span id="attempts-left">Ilimitadas</span></span>
            </div>
            
            <div id="audio-container" class="audio-container"></div>
            
            <div class="question-text-wrapper">
                <div id="question-text" class="question-text"></div>
                <button id="translate-button" class="translate-btn" title="Traduzir Quest√£o">üåê</button>
            </div>
            <div id="translation-display" class="translation-text"></div>
            
            <div id="audio-play-container"></div> 
            
            <div id="options-list" class="options-list"></div>
            <div id="justification-container"></div>
            <div id="hint-container" style="margin-top: 15px;">
                <button id="hint-button" class="btn hint-btn">Dica</button>
                <div id="hint-text" class="hint-text"></div>
                <div id="summary-text" class="hint-text" style="border-left-color: #28a745;"></div>
            </div>
            <div class="question-actions">
                 <button id="performance-btn" class="btn performance-btn">DESEMPENHO</button>
                <button id="summary-button" class="start-btn" style="background-color: #28a745; display: none;">Resumo</button>
                <button id="skip-button" class="btn skip-btn">Pular Quest√£o</button>
                <button id="next-button" class="btn next-btn">Pr√≥xima Quest√£o</button>
                <div id="performance-display" class="performance-display"></div>
            </div>
        </div>
        
        <div id="vocab-quiz-card" class="question-card">
            <h2 style="color: #155724; text-align: center;">Quiz - Vocabulary</h2>
            
            <div id="vocab-progress-bar-container" class="progress-bar-container">
                <div id="vocab-progress-bar" class="progress-bar" style="width: 0%; background: linear-gradient(90deg, #155724, #28a745);">0%</div>
            </div>
            <div class="question-header">
                <span class="question-counter"><span id="vocab-current-question-num">1</span> de 20</span>
                <span class="attempts-counter" style="display: none;">Tentativas: <span id="vocab-attempts-left">Ilimitadas</span></span>
            </div>
            <div id="vocab-audio-play-container"></div>
            <div id="vocab-audio-container" class="audio-container"></div>
            <div class="question-text-wrapper">
                <div id="vocab-question-text" class="question-text"></div>
                <button id="vocab-translate-button" class="translate-btn" title="Traduzir Quest√£o">üåê</button>
            </div>
            <div id="vocab-translation-display" class="translation-text"></div>
            <div id="vocab-options-list" class="options-list"></div>
            <div id="vocab-justification-container"></div>
            <div id="vocab-hint-container" style="margin-top: 15px;">
                <button id="vocab-hint-button" class="btn hint-btn">Dica</button>
                <div id="vocab-hint-text" class="hint-text"></div>
                <div id="vocab-summary-text" class="hint-text" style="border-left-color: #28a745;"></div>
            </div>
            <div class="question-actions">
                 <button id="vocab-performance-btn" class="btn performance-btn">DESEMPENHO</button>
                <button id="vocab-summary-button" class="start-btn" style="background-color: #28a745; display: none;">Resumo</button>
                <button id="vocab-skip-button" class="btn skip-btn">Pular Quest√£o</button>
                <button id="vocab-next-button" class="btn next-btn">Pr√≥xima Quest√£o</button>
                <div id="vocab-performance-display" class="performance-display"></div>
            </div>
        </div>
        <div id="results-card" class="results-card">
            <h1>Relat√≥rio Final</h1>
            <p><strong>Nome:</strong> <span id="report-student-name"></span></p>
            <p><strong>C√≥digo de Acesso:</strong> <span id="report-student-code"></span></p>
            <p><strong>Pontua√ß√£o:</strong> <span id="score-display" class="score-display"></span></p>
            <p><strong>Percentual de Acerto:</strong> <span id="percentage-display"></span></p>
            <p><strong>Classifica√ß√£o:</strong> <span id="classification-display"></span></p>
            <div class="results-actions">
                <a id="send-report-link" class="send-report-btn" href="#" target="_blank">Enviar Relat√≥rio ao Professor</a>
                <button class="restart-btn" onclick="quizApp.restartQuiz()">Reiniciar Teste</button>
                <a id="share-whatsapp" class="share-btn" href="#" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"> Compartilhar
                </a>
                <button class="btn save-report-btn" onclick="quizApp.saveReport()">Salvar Relat√≥rio</button>
                <button class="btn print-btn" onclick="quizApp.printReport()">Imprimir Relat√≥rio Detalhado</button>
                <button class="btn skip-btn" style="float: none; display: inline-block;" onclick="quizApp.printPersonalReport()">Imprimir Resumo Pessoal</button>
            </div>
            <div id="full-report-container" class="full-report-list" style="display: none;"></div>
            <div id="personal-report-container" class="full-report-list" style="display: none; border-top: 2px solid #ffc107; margin-top: 20px;"></div>
        </div>

        <div id="roteiro-content-tab" class="tabcontent" style="text-align: left; display: none;">
            <div id="admin-panel-roteiro" class="admin-panel"></div> 
            
            <div id="student-content-view-roteiro" class="student-content-view">
                <h2 style="text-align: center;">Roteiro de Estudos</h2>
                <p style="text-align: center;">Acesse o material de revis√£o em PDF usando os bot√µes abaixo.</p>
                <div id="content-buttons-roteiro"></div>
            </div>
        </div>
        
        <div id="apostila-content-tab" class="tabcontent" style="text-align: left; display: none;">
            <div id="admin-panel-apostila" class="admin-panel"></div> 
            
            <div id="student-content-view-apostila" class="student-content-view">
                <h2 style="text-align: center;">Apostila Conclu√≠da</h2>
                <p style="text-align: center;">Acesse a apostila completa em PDF usando os bot√µes abaixo.</p>
                <div id="content-buttons-apostila"></div>
            </div>
        </div>

    </div>
    
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Material de Estudo</h2>
                <button id="night-mode-toggle" class="btn-night-mode">Modo Noturno üåô</button>
                <span id="modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>

    <script>
        
        // --- DADOS E LINKS DO PROT√ìTIPO CRIAN√áA (3¬∫ ANO) ---
        const PDF_LINK_ROTEIRO = 'https://drive.google.com/file/d/1GVSdjc5_de_385OJidSGuOA9k0HnC8bb/view?usp=drive_link'; 
        const PDF_LINK_APOSTILA = 'https://drive.google.com/file/d/1KjDcp18G2Cx8w1vCyFnFHHTzLfMk7cku/view?usp=drive_link';
        const VIDEO_LINK = 'https://drive.google.com/file/d/1GevGYozoymcrHZkD_90HSaYjYbPDpR-k/view?usp=drive_link'; 
        
        const STUDENT_DATA = {
            "284AG": "ANA JULIA GOMES",
"519BM": "BIANCA DA SILVA MORAES",
"732DW": "DAVI LUCCA DA COSTA WENING",
"165FR": "FABIO GAEL TEIXEIRA RIBEIRO",
"941GB": "GUILHERME FERREIRA BARBOSA",
"327HS": "HUGO SERRANO SILOTTO",
"608JM": "JOAQUIM FERREIRA DE MORAIS",
"493LO": "LEONARDO FERRAZ DE OLIVEIRA",
"852LA": "LET√çCIA VIEIRA DA SILVA AUKSTAKOJIS",
"174LM": "LILLY FRATOGIANNI MONTEIRO",
"536LS": "LIVIA SOARES DE SOUZA",
"291LS": "LUIZA ALVES DE MACEDO SOUSA",
"684LC": "LUIZA CABRAL CORREA",
"417LR": "LUNA ARAG√ÉO DE RESENDE",
"902MC": "MARCOS HENRIQUE CORREA CAPARELLI",
"358MS": "MAYARA PORFIRIO DE SOUSA",
"726MS": "MIGUEL DA SILVA SANTOS",
"149NS": "NICOLAS LINHARES SANTANA",
"835RM": "RAFAELA MAGALH√ÉES DE MATOS",
"561TD": "TEO ALMEIDA DIAS",
"JR123": "J√öNIOR"
        };
        
        const TOPIC_SUMMARIES = {
    "Body Parts": "Aprendemos as partes do corpo: 'Head' (Cabe√ßa), 'Eye' (Olho), 'Mouth' (Boca), 'Arm' (Bra√ßo), 'Leg' (Perna) e 'Foot' (P√©).",
    "Pronouns & Possessives": "Usamos 'He' (Ele) e 'His' (Dele) para meninos. Usamos 'She' (Ela) e 'Her' (Dela) para meninas.",
    "Demonstratives": "Para apontar coisas: 'This' (Isto - Perto/Singular), 'That' (Aquilo - Longe/Singular), 'These' (Estes - Perto/Plural), 'Those' (Aqueles - Longe/Plural).",
    "There Is / There Are": "O verbo haver/ter: 'There Is' para um s√≥ (Singular) e 'There Are' para v√°rios (Plural).",
    "School & Food": "Vocabul√°rio de escola (Glue, Ruler) e comida (Bread, Cake, Eggs)."
};

const GRAMMAR_QUESTIONS = [
    // --- PRONOUNS (He/She/His/Her) ---
    { type: 'mcq', question: "Look at the boy. ___ is happy.", topic: "Pronouns", hint: "DICA 1: Menino.", hint_2: "DICA 2: Ele.", options: [ { text: "He", isCorrect: true, rationale: "Correto! He √© usado para meninos." }, { text: "She", isCorrect: false, rationale: "Incorreto. She √© para meninas." }, { text: "It", isCorrect: false, rationale: "Incorreto." }, { text: "They", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "This is Maria. ___ hair is long.", topic: "Possessives", hint: "DICA 1: O cabelo DELA.", hint_2: "DICA 2: Possessivo para meninas (She).", options: [ { text: "Her", isCorrect: true, rationale: "Correto! 'Her' significa 'Dela'." }, { text: "His", isCorrect: false, rationale: "Incorreto. His √© 'Dele'." }, { text: "He", isCorrect: false, rationale: "Incorreto." }, { text: "She", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "___ is my brother.", topic: "Pronouns", hint: "DICA 1: Brother = Irm√£o.", hint_2: "DICA 2: Ele.", options: [ { text: "He", isCorrect: true, rationale: "Correto! He √© usado para o irm√£o." }, { text: "She", isCorrect: false, rationale: "Incorreto." }, { text: "Her", isCorrect: false, rationale: "Incorreto." }, { text: "It", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "Look at Pedro. ___ eyes are brown.", topic: "Possessives", hint: "DICA 1: Os olhos DELE.", hint_2: "DICA 2: Possessivo para meninos (He).", options: [ { text: "His", isCorrect: true, rationale: "Correto! 'His' significa 'Dele'." }, { text: "Her", isCorrect: false, rationale: "Incorreto." }, { text: "She", isCorrect: false, rationale: "Incorreto." }, { text: "He", isCorrect: false, rationale: "Incorreto." } ] },

    // --- DEMONSTRATIVES (This/That/These/Those) ---
    { type: 'mcq', question: "___ is my pen. (Perto / Singular)", topic: "Demonstratives", hint: "DICA 1: Est√° na minha m√£o.", hint_2: "DICA 2: Come√ßa com T e termina com S.", options: [ { text: "This", isCorrect: true, rationale: "Correto! 'This' √© para singular e perto." }, { text: "That", isCorrect: false, rationale: "Incorreto. That √© para longe." }, { text: "These", isCorrect: false, rationale: "Incorreto." }, { text: "Those", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "___ are stars in the sky. (Longe / Plural)", topic: "Demonstratives", hint: "DICA 1: Est√£o longe.", hint_2: "DICA 2: S√£o muitas.", options: [ { text: "Those", isCorrect: true, rationale: "Correto! 'Those' √© para plural e longe." }, { text: "That", isCorrect: false, rationale: "Incorreto. That √© singular." }, { text: "This", isCorrect: false, rationale: "Incorreto." }, { text: "These", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "___ is a bird in the tree. (Longe / Singular)", topic: "Demonstratives", hint: "DICA 1: Aquele p√°ssaro.", hint_2: "DICA 2: Um s√≥, longe.", options: [ { text: "That", isCorrect: true, rationale: "Correto! 'That' √© para singular e longe." }, { text: "This", isCorrect: false, rationale: "Incorreto." }, { text: "These", isCorrect: false, rationale: "Incorreto." }, { text: "Those", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "___ are my books here. (Perto / Plural)", topic: "Demonstratives", hint: "DICA 1: Estes livros.", hint_2: "DICA 2: Mais de um, perto.", options: [ { text: "These", isCorrect: true, rationale: "Correto! 'These' √© para plural e perto." }, { text: "This", isCorrect: false, rationale: "Incorreto." }, { text: "That", isCorrect: false, rationale: "Incorreto." }, { text: "Those", isCorrect: false, rationale: "Incorreto." } ] },

    // --- THERE IS / THERE ARE ---
    { type: 'mcq', question: "___ a cake on the table.", topic: "There Be", hint: "DICA 1: Um bolo s√≥.", hint_2: "DICA 2: Singular.", options: [ { text: "There is", isCorrect: true, rationale: "Correto! Singular usa 'There is'." }, { text: "There are", isCorrect: false, rationale: "Incorreto. Are √© plural." }, { text: "Is there", isCorrect: false, rationale: "Incorreto. Ordem de pergunta." }, { text: "There aren't", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "___ five dogs in the house.", topic: "There Be", hint: "DICA 1: Cinco cachorros.", hint_2: "DICA 2: Plural.", options: [ { text: "There are", isCorrect: true, rationale: "Correto! Plural usa 'There are'." }, { text: "There is", isCorrect: false, rationale: "Incorreto. Is √© singular." }, { text: "There isn't", isCorrect: false, rationale: "Incorreto." }, { text: "That is", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "___ a pizza here? (Pergunta)", topic: "There Be", hint: "DICA 1: Ordem de interroga√ß√£o.", hint_2: "DICA 2: O verbo vem antes.", options: [ { text: "Is there", isCorrect: true, rationale: "Correto! Na pergunta invertemos: Is there...?" }, { text: "There is", isCorrect: false, rationale: "Incorreto." }, { text: "Are there", isCorrect: false, rationale: "Incorreto." }, { text: "There are", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "___ two cats under the bed. (Negativa)", topic: "There Be", hint: "DICA 1: N√£o h√° dois gatos.", hint_2: "DICA 2: Plural negativo.", options: [ { text: "There aren't", isCorrect: true, rationale: "Correto! 'Aren't' √© o negativo plural." }, { text: "There isn't", isCorrect: false, rationale: "Incorreto. Isn't √© singular." }, { text: "There is", isCorrect: false, rationale: "Incorreto." }, { text: "There not", isCorrect: false, rationale: "Incorreto." } ] },

    // --- TRUE OR FALSE (Gram√°tica) ---
    { type: 'tf', question: "'There is' is used for Plural.", topic: "There Be", hint: "DICA 1: Is = √â/Est√° (Singular).", hint_2: "DICA 2: Falso.", options: [ { text: "Verdadeiro", isCorrect: false, rationale: "Falso. 'There is' √© singular." }, { text: "Falso", isCorrect: true, rationale: "Correto. Plural √© There Are." } ], answer: false },
    { type: 'tf', question: "'These' means 'Estes' (Plural Perto).", topic: "Demonstratives", hint: "DICA 1: Plural de This.", hint_2: "DICA 2: Verdadeiro.", options: [ { text: "Verdadeiro", isCorrect: true, rationale: "Verdadeiro." }, { text: "Falso", isCorrect: false, rationale: "Incorreto." } ], answer: true },
    { type: 'tf', question: "We say 'Her Name' for a boy.", topic: "Possessives", hint: "DICA 1: Boy = Menino.", hint_2: "DICA 2: Para menino usamos His.", options: [ { text: "Verdadeiro", isCorrect: false, rationale: "Falso. Para menino √© 'His Name'." }, { text: "Falso", isCorrect: true, rationale: "Correto." } ], answer: false },
    { type: 'tf', question: "'There aren't' is the negative of 'There are'.", topic: "There Be", hint: "DICA 1: Nega√ß√£o.", hint_2: "DICA 2: Verdadeiro.", options: [ { text: "Verdadeiro", isCorrect: true, rationale: "Verdadeiro." }, { text: "Falso", isCorrect: false, rationale: "Incorreto." } ], answer: true },

    // --- DRAG AND DROP (Gram√°tica) ---
    { type: 'drag-drop', question: "Singular Perto: ______", topic: "Demonstratives", hint: "DICA 1: Este/Isto.", hint_2: "DICA 2: T...s", options: ["This", "That", "Those"], answer: "This", rationale: "Correto. This." },
    { type: 'drag-drop', question: "Plural Longe: ______", topic: "Demonstratives", hint: "DICA 1: Aqueles.", hint_2: "DICA 2: T...se", options: ["Those", "These", "This"], answer: "Those", rationale: "Correto. Those." },
    { type: 'drag-drop', question: "Possessivo (Ela): ______", topic: "Possessives", hint: "DICA 1: Dela.", hint_2: "DICA 2: H...", options: ["Her", "His", "He"], answer: "Her", rationale: "Correto. Her." },
    { type: 'drag-drop', question: "Verbo Haver (Plural): ______", topic: "There Be", hint: "DICA 1: Tem (muitos).", hint_2: "DICA 2: There ...", options: ["There are", "There is", "It is"], answer: "There are", rationale: "Correto. There are." }
];

const VOCAB_QUESTIONS = [
    // --- BODY PARTS ---
    { type: 'mcq', question: "What do you use to see?", topic: "Body Parts", hint: "DICA 1: Olhos.", hint_2: "DICA 2: E...s", options: [ { text: "Eyes", isCorrect: true, rationale: "Correto! Eyes (Olhos)." }, { text: "Nose", isCorrect: false, rationale: "Incorreto. Nose √© nariz." }, { text: "Mouth", isCorrect: false, rationale: "Incorreto." }, { text: "Leg", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "What is 'Mouth'?", topic: "Body Parts", hint: "DICA 1: Usada para comer e falar.", hint_2: "DICA 2: Come√ßa com B.", options: [ { text: "Boca", isCorrect: true, rationale: "Correto! Mouth √© boca." }, { text: "M√£o", isCorrect: false, rationale: "Incorreto." }, { text: "P√©", isCorrect: false, rationale: "Incorreto." }, { text: "Orelha", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "What connects the hand to the body?", topic: "Body Parts", hint: "DICA 1: Membro superior.", hint_2: "DICA 2: Bra√ßo.", options: [ { text: "Arm", isCorrect: true, rationale: "Correto! Arm √© bra√ßo." }, { text: "Leg", isCorrect: false, rationale: "Incorreto." }, { text: "Foot", isCorrect: false, rationale: "Incorreto." }, { text: "Head", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "What is 'Head'?", topic: "Body Parts", hint: "DICA 1: Onde fica o c√©rebro.", hint_2: "DICA 2: Cabe√ßa.", options: [ { text: "Cabe√ßa", isCorrect: true, rationale: "Correto! Head √© cabe√ßa." }, { text: "Ombro", isCorrect: false, rationale: "Incorreto." }, { text: "Joelho", isCorrect: false, rationale: "Incorreto." }, { text: "Dedo", isCorrect: false, rationale: "Incorreto." } ] },

    // --- SCHOOL SUPPLIES ---
    { type: 'mcq', question: "What do we use to measure things?", topic: "School Supplies", hint: "DICA 1: Ver o tamanho em cm.", hint_2: "DICA 2: R√©gua.", options: [ { text: "Ruler", isCorrect: true, rationale: "Correto! Ruler √© r√©gua." }, { text: "Glue", isCorrect: false, rationale: "Incorreto. Glue √© cola." }, { text: "Book", isCorrect: false, rationale: "Incorreto." }, { text: "Pen", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "What is 'Glue'?", topic: "School Supplies", hint: "DICA 1: Grudar pap√©is.", hint_2: "DICA 2: Cola.", options: [ { text: "Cola", isCorrect: true, rationale: "Correto! Glue √© cola." }, { text: "L√°pis", isCorrect: false, rationale: "Incorreto." }, { text: "Caneta", isCorrect: false, rationale: "Incorreto." }, { text: "Borracha", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "Where do you put your pencils?", topic: "School Supplies", hint: "DICA 1: Estojo.", hint_2: "DICA 2: P... Case.", options: [ { text: "Pencil Case", isCorrect: true, rationale: "Correto! Pencil Case √© estojo." }, { text: "Sharpener", isCorrect: false, rationale: "Incorreto." }, { text: "Ruler", isCorrect: false, rationale: "Incorreto." }, { text: "Notebook", isCorrect: false, rationale: "Incorreto." } ] },

    // --- FOOD ---
    { type: 'mcq', question: "What is 'Bread'?", topic: "Food", hint: "DICA 1: Comemos no caf√© da manh√£.", hint_2: "DICA 2: P√£o.", options: [ { text: "P√£o", isCorrect: true, rationale: "Correto! Bread √© p√£o." }, { text: "Bolo", isCorrect: false, rationale: "Incorreto." }, { text: "Queijo", isCorrect: false, rationale: "Incorreto." }, { text: "Presunto", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "Which one is a vegetable?", topic: "Food", hint: "DICA 1: Cenoura.", hint_2: "DICA 2: Laranja e comprida.", options: [ { text: "Carrot", isCorrect: true, rationale: "Correto! Carrot √© cenoura." }, { text: "Cake", isCorrect: false, rationale: "Incorreto." }, { text: "Milk", isCorrect: false, rationale: "Incorreto." }, { text: "Ham", isCorrect: false, rationale: "Incorreto." } ] },
    { type: 'mcq', question: "What is 'Pumpkin'?", topic: "Food", hint: "DICA 1: Usada no Halloween.", hint_2: "DICA 2: Ab√≥bora.", options: [ { text: "Ab√≥bora", isCorrect: true, rationale: "Correto! Pumpkin √© ab√≥bora." }, { text: "Milho", isCorrect: false, rationale: "Incorreto." }, { text: "Batata", isCorrect: false, rationale: "Incorreto." }, { text: "Ma√ß√£", isCorrect: false, rationale: "Incorreto." } ] },

    // --- TRUE OR FALSE (Vocabul√°rio) ---
    { type: 'tf', question: "'Foot' means 'M√£o'.", topic: "Body Parts", hint: "DICA 1: Foot = Futebol.", hint_2: "DICA 2: Falso.", options: [ { text: "Verdadeiro", isCorrect: false, rationale: "Falso. Foot √© P√©. M√£o √© Hand." }, { text: "Falso", isCorrect: true, rationale: "Correto." } ], answer: false },
    { type: 'tf', question: "'Turkey' is a bird we eat.", topic: "Food", hint: "DICA 1: Peru de Natal.", hint_2: "DICA 2: Verdadeiro.", options: [ { text: "Verdadeiro", isCorrect: true, rationale: "Verdadeiro. Turkey √© Peru." }, { text: "Falso", isCorrect: false, rationale: "Incorreto." } ], answer: true },
    { type: 'tf', question: "'Eraser' is used to write.", topic: "School Supplies", hint: "DICA 1: Eraser = Borracha.", hint_2: "DICA 2: Falso, serve para apagar.", options: [ { text: "Verdadeiro", isCorrect: false, rationale: "Falso. Eraser apaga (erase)." }, { text: "Falso", isCorrect: true, rationale: "Correto." } ], answer: false },
    { type: 'tf', question: "'Onion' makes you cry.", topic: "Food", hint: "DICA 1: Cebola.", hint_2: "DICA 2: Verdadeiro.", options: [ { text: "Verdadeiro", isCorrect: true, rationale: "Verdadeiro. Cebola faz chorar." }, { text: "Falso", isCorrect: false, rationale: "Incorreto." } ], answer: true },
    { type: 'tf', question: "'Hair' is on your head.", topic: "Body Parts", hint: "DICA 1: Cabelo.", hint_2: "DICA 2: Verdadeiro.", options: [ { text: "Verdadeiro", isCorrect: true, rationale: "Verdadeiro." }, { text: "Falso", isCorrect: false, rationale: "Incorreto." } ], answer: true },

    // --- DRAG AND DROP ---
    { type: 'drag-drop', question: "Parte do rosto: ______", topic: "Body Parts", hint: "DICA 1: Nariz.", hint_2: "DICA 2: N...se", options: ["Nose", "Hand", "Leg"], answer: "Nose", rationale: "Correto. Nose (Nariz)." },
    { type: 'drag-drop', question: "Alimento doce: ______", topic: "Food", hint: "DICA 1: Bolo.", hint_2: "DICA 2: C...ke", options: ["Cake", "Onion", "Corn"], answer: "Cake", rationale: "Correto. Cake (Bolo)." },
    { type: 'drag-drop', question: "Material escolar: ______", topic: "School Supplies", hint: "DICA 1: Apontador.", hint_2: "DICA 2: Shar...", options: ["Sharpener", "Bread", "Eye"], answer: "Sharpener", rationale: "Correto. Sharpener." },
    { type: 'drag-drop', question: "Legume amarelo: ______", topic: "Food", hint: "DICA 1: Milho.", hint_2: "DICA 2: C...rn", options: ["Corn", "Apple", "Egg"], answer: "Corn", rationale: "Correto. Corn (Milho)." },

    // --- FILL IN ---
    { type: 'fill-in', question: "My ______ (Perna) is long.", topic: "Body Parts", hint: "DICA 1: Membro inferior.", hint_2: "DICA 2: L...g", answer: ["leg"], rationale: "Correto. Leg." },
    { type: 'fill-in', question: "I like ______ (Ovos).", topic: "Food", hint: "DICA 1: Vem da galinha.", hint_2: "DICA 2: E...gs", answer: ["eggs"], rationale: "Correto. Eggs." }
];

        
        // --- FUN√á√ïES COMPARTILHADAS DE L√ìGICA (HERDADAS DO PROT√ìTIPO M√âDIO/ALTO) ---

        function shuffleArray(array) {
             for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getCorrectAnswerForQuestion(question) {
            if (question.type === 'fill-in') return question.answer[0];
            if (question.type === 'drag-drop') return question.answer;
            if (question.options) { 
                const correctOption = question.options.find(o => o.isCorrect);
                return correctOption ? correctOption.text : 'N/A';
            }
            return 'N/A';
        }
        
        function analyzePerformanceByTopic(details, questions) {
            const topicErrors = {};
            const topicTotals = {};

            questions.forEach((question, index) => {
                const topic = question.topic || "Geral";
                if (!topicTotals[topic]) topicTotals[topic] = 0;
                topicTotals[topic]++;

                const answerData = details[index];
                if (!answerData || !answerData.isCorrect) {
                    if (!topicErrors[topic]) topicErrors[topic] = 0;
                    topicErrors[topic]++;
                }
            });
            return { topicErrors, topicTotals };
        }
        
        function generateFullReportHtml(reportApp) {
            let reportHtml = '<h3>Relat√≥rio Detalhado</h3>';
            reportApp.questions.forEach((question, index) => {
                const answerData = reportApp.userAnswers[index];
                let questionText = question.question.replace(/______/g, '...'); 
                
                if (question.type === 'audio_mcq' && question.hint) {
                    const hintText = question.hint.replace("DICA 1:", "").trim();
                    questionText = `${questionText} (Frase de √Åudio: '${hintText}')`;
                }

                if (answerData) {
                    const itemClass = answerData.isCorrect ? 'correct' : 'incorrect';
                    reportHtml += `
                        <div class="report-question-item">
                            <p><strong>Quest√£o ${index + 1}:</strong> ${questionText}</p>
                            <p><strong>Sua Resposta:</strong> <span class="option-item-report ${itemClass}">${answerData.userAns}</span></p>
                            ${!answerData.isCorrect ? `<p><strong>Resposta Correta:</strong> <span class="option-item-report correct">${answerData.correctAns}</span></p>` : ''}
                            <p><em>Justificativa: ${answerData.rationale}</em></p>
                        </div>
                    `;
                } else {
                    const correctAnswer = getCorrectAnswerForQuestion(question);
                    const rationale = question.rationale || (question.options ? (question.options.find(o => o.isCorrect) || {}).rationale : 'N/A');
                    reportHtml += `
                        <div class="report-question-item">
                            <p><strong>Quest√£o ${index + 1}:</strong> ${questionText}</p>
                            <p><strong>Sua Resposta:</strong> <span class="option-item-report incorrect">N√£o respondida</span></p>
                            <p><strong>Resposta Correta:</strong> <span class="option-item-report correct">${correctAnswer}</span></p>
                            <p><em>Justificativa: ${rationale}</em></p>
                        </div>
                    `;
                }
            });
            return reportHtml;
        }
        
        function generatePersonalReportHtml(reportApp) {
            const analysis = analyzePerformanceByTopic(reportApp.userAnswers, reportApp.questions);
            let html = '<h3>Relat√≥rio Pessoal de Estudos</h3>';
            
            const topicsToReview = [];
            for (const topic in analysis.topicErrors) {
                const errors = analysis.topicErrors[topic];
                if (errors > 0) {
                    const total = analysis.topicTotals[topic];
                    const errorRate = (errors / total) * 100;
                    topicsToReview.push({ topic: topic, errors: errors, total: total, rate: errorRate });
                }
            }

            topicsToReview.sort((a, b) => b.errors - a.errors);

            if (topicsToReview.length === 0) {
                html += '<p style="font-weight: bold; color: #28a745;">Parab√©ns! Voc√™ n√£o errou nenhuma quest√£o. N√£o h√° nada para revisar.</p>';
            } else {
                 html += `<p>Aqui est√° seu guia de estudos focado nos t√≥picos que voc√™ precisa revisar, come√ßando pelos mais dif√≠ceis:</p><br>`;
                topicsToReview.forEach(item => {
                    const summaryText = reportApp.summaries[item.topic] || "N√£o h√° resumo dispon√≠vel para este t√≥pico.";
                    html += `
                        <div class="personal-summary-item">
                            <h4>T√≥pico: ${item.topic}</h4>
                            <p><strong>Seu desempenho:</strong> <span style="color: #dc3545;">${item.errors} de ${item.total} erradas</span> (${item.rate.toFixed(0)}% de erro)</p>
                            <p><strong>Resumo para Revis√£o:</strong><br>${summaryText}</p>
                        </div>
                    `;
                });
            }
            return html;
        }


        // --- ESTRUTURA BASE DO QUIZ (HERDANDO TODAS AS FUN√á√ïES AVAN√áADAS) ---
        
        const quizBase = {
            currentQuestionIndex: 0, score: 0, userAnswers: {},
            validatedStudentName: '', validatedStudentCode: '',
            questions: [], 
            shuffledQuestions: [],
            hintLevel: 0, 
            summaries: TOPIC_SUMMARIES, 
            
            elements: {}, // Ser√° preenchido por quizApp e vocabQuizApp
            
            shuffleArray,
            getCorrectAnswerForQuestion,
            generateFullReportHtml,
            generatePersonalReportHtml,
            
            // Reimplementa√ß√£o da l√≥gica principal (Herdada do PROT√ìTIPO M√âDIO/ALTO)
            updateProgressBar: function() {
                const totalQuestions = this.questions.length;
                const answeredCount = Object.keys(this.userAnswers).length;
                const percentage = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;
                this.elements.progressBar.style.width = percentage + '%';
                this.elements.progressBar.textContent = percentage + '%';
            },

            startQuiz: function(continueSaved) {
                const code = this.elements.studentCodeInput ? this.elements.studentCodeInput.value.trim().toUpperCase() : this.validatedStudentCode;
                
                if (!STUDENT_DATA[code]) { 
                    alert("C√≥digo inv√°lido ou quiz n√£o iniciado corretamente."); 
                    showCard('intro-card', document.querySelector('.tab-inicio'));
                    return; 
                }
                
                this.validatedStudentCode = code;
                this.validatedStudentName = STUDENT_DATA[code];
                
                if (code === '123') { setupAdminLinks(true); } else { setupAdminLinks(false); }
                
                this.currentQuestionIndex = 0; this.score = 0; this.userAnswers = {};
                // --- ALEATORIEDADE ---
                // Garantimos que as perguntas sejam embaralhadas aqui
                this.shuffledQuestions = this.shuffleArray([...this.initialQuestions]);
                this.questions = this.shuffledQuestions; 

                if(this.elements.quizCard.id === 'question-card') {
                    showCard('question-card', document.querySelector('.tab-quiz-g'));
                } else {
                     showCard('vocab-quiz-card', document.querySelector('.tab-quiz-v'));
                }

                this.displayQuestion();
            },

            displayQuestion: function() {
                this.updateProgressBar();
                this.elements.performanceDisplay.style.display = 'none';
                this.elements.justificationContainer.innerHTML = '';
                this.elements.hintText.style.display = 'none';
                this.elements.summaryText.style.display = 'none';
                this.elements.summaryButton.style.display = 'none';
                this.elements.nextButton.style.display = 'none';

                this.elements.translationDisplay.style.display = 'none'; 
                this.elements.translateButton.style.display = 'inline-block'; 
                this.elements.translateButton.disabled = false;
                this.elements.translateButton.textContent = 'üåê'; 
                
                this.elements.audioContainer.innerHTML = ''; 
                this.elements.audioPlayContainer.innerHTML = ''; 
                this.elements.questionText.style.display = 'flex'; 

                this.hintLevel = 0; 
                this.elements.hintButton.textContent = 'Dica'; 
                this.elements.hintButton.style.background = '';
                this.elements.hintButton.disabled = false;
                
                if (this.currentQuestionIndex >= this.questions.length) { this.showResults(); return; }
                
                const q = this.questions[this.currentQuestionIndex];
                
                // --- CONTADOR ---
                // Aqui colocamos apenas o n√∫mero atual, pois o HTML j√° tem "de 20".
                this.elements.currentQuestionNumSpan.textContent = this.currentQuestionIndex + 1;
                
                this.elements.optionsList.innerHTML = '';

                if (q.type === 'mcq' || q.type === 'tf') this.renderMCQ(q);
                else if (q.type === 'fill-in') this.renderFillIn(q);
                else if (q.type === 'drag-drop') this.renderDragDrop(q);
                else if (q.type === 'audio_mcq') this.renderAudioMCQ(q);

                // Rebind event listeners 
                this.elements.hintButton.onclick = () => this.showHint(); 
            },
            
            renderMCQ: function(q) {
                // --- NUMERA√á√ÉO NA PERGUNTA ---
                // Aqui adicionamos o n√∫mero sequencial e o espa√ßo que voc√™ pediu.
                this.elements.questionText.innerHTML = `<strong>${this.currentQuestionIndex + 1}.</strong>&nbsp;${q.question}`;
                
                if (q.type !== 'audio_mcq') this.elements.translateButton.style.display = 'inline-block';

                this.shuffleArray(q.options).forEach(opt => {
                    const li = document.createElement('li');
                    li.className = 'option-item';
                    li.textContent = opt.text;
                    li.onclick = () => this.selectOption(li, opt, q);
                    this.elements.optionsList.appendChild(li);
                });
            },
            
            renderFillIn: function(q) {
                // --- NUMERA√á√ÉO NA PERGUNTA ---
                this.elements.questionText.innerHTML = `<strong>${this.currentQuestionIndex + 1}.</strong>&nbsp;${q.question}`;
                this.elements.translateButton.style.display = 'inline-block'; 
                
                const input = document.createElement('input');
                input.id = 'fill-in-input';
                input.placeholder = "Digite sua resposta...";
                const checkButton = document.createElement('button');
                checkButton.textContent = 'Verificar';
                checkButton.className = 'btn check-btn';
                checkButton.onclick = () => {
                    const userAnswer = input.value.trim().toLowerCase();
                    const isCorrect = q.answer.map(ans => ans.toLowerCase()).includes(userAnswer);
                    this.handleAnswer(isCorrect, q.rationale, input.value.trim(), q.answer[0]);
                    input.disabled = true;
                    checkButton.style.display = 'none';
                    input.classList.add(isCorrect ? 'correct' : 'incorrect');
                };
                this.elements.optionsList.appendChild(input);
                this.elements.optionsList.appendChild(checkButton);
            },
            
            renderDragDrop: function(q) {
                const dropZone = document.createElement('span');
                dropZone.id = 'drop-zone';
                dropZone.textContent = 'Arraste aqui';
                
                // --- NUMERA√á√ÉO NA PERGUNTA ---
                // Adicionamos o n√∫mero antes de substituir o '______' pelo drop zone
                const questionNumber = `<strong>${this.currentQuestionIndex + 1}.</strong>&nbsp;`;
                const questionTextHTML = questionNumber + q.question.replace('______', dropZone.outerHTML);
                
                this.elements.questionText.innerHTML = questionTextHTML; 
                this.elements.translateButton.style.display = 'inline-block'; 
                
                const actualDropZone = this.elements.questionText.querySelector('#drop-zone');
                const dragOptionsWrapper = document.createElement('div');
                dragOptionsWrapper.className = 'drag-options-wrapper';
                this.shuffleArray(q.options).forEach(opt => {
                    const optionEl = document.createElement('span');
                    optionEl.textContent = opt;
                    optionEl.className = 'drag-option';
                    optionEl.draggable = true;
                    optionEl.dataset.value = opt;
                    optionEl.ondragstart = (e) => { e.dataTransfer.setData('text/plain', e.target.dataset.value); e.target.classList.add('dragging'); };
                    dragOptionsWrapper.appendChild(optionEl);
                });
                this.elements.optionsList.appendChild(dragOptionsWrapper);
                
                actualDropZone.ondragover = (e) => { e.preventDefault(); actualDropZone.classList.add('over'); };
                actualDropZone.ondragleave = () => actualDropZone.classList.remove('over');
                actualDropZone.ondrop = (e) => {
                    e.preventDefault();
                    actualDropZone.classList.remove('over');
                    const droppedValue = e.dataTransfer.getData('text/plain');
                    const isCorrect = (droppedValue.toLowerCase() === q.answer.toLowerCase());
                    this.handleAnswer(isCorrect, q.rationale, droppedValue, q.answer);
                    actualDropZone.textContent = droppedValue;
                    actualDropZone.classList.add(isCorrect ? 'correct' : 'incorrect');
                    this.elements.optionsList.querySelectorAll('.drag-option').forEach(el => { el.draggable = false; el.style.cursor = 'not-allowed'; el.style.opacity = '0.6'; });
                };
            },
            
            renderAudioMCQ: function(q) {
                this.elements.audioContainer.innerHTML = ''; 
                const audioEl = document.createElement('audio');
                audioEl.src = q.audioSrc;
                audioEl.preload = 'auto'; 
                this.elements.audioContainer.appendChild(audioEl);

                this.elements.audioPlayContainer.innerHTML = ''; 
                const playBtn = document.createElement('button');
                playBtn.className = 'btn audio-play-btn';
                playBtn.textContent = 'Ouvir Quest√£o üéß';
                playBtn.onclick = () => audioEl.play();
                this.elements.audioPlayContainer.appendChild(playBtn);
                
                this.elements.translateButton.style.display = 'none';
                this.renderMCQ(q);
            },
            
            selectOption: function(selectedElement, selectedOption, currentQuestion) {
                this.elements.optionsList.querySelectorAll('.option-item').forEach(option => option.style.pointerEvents = 'none');
                const isCorrect = selectedOption.isCorrect;
                
                selectedElement.classList.add(isCorrect ? 'correct' : 'incorrect');
                this.handleAnswer(isCorrect, selectedOption.rationale, selectedOption.text, currentQuestion.options.find(o => o.isCorrect).text);

                if (!isCorrect) {
                    const correctText = currentQuestion.options.find(opt => opt.isCorrect).text;
                    const correctElement = Array.from(this.elements.optionsList.querySelectorAll('.option-item')).find(el => el.textContent === correctText);
                    if (correctElement) correctElement.classList.add('correct');
                }
            },

            handleAnswer: function(isCorrect, rationale, userAns, correctAns) {
                 if (isCorrect) {
                    this.score++;
                    this.elements.summaryButton.style.display = 'none'; 
                } else {
                    this.elements.summaryButton.style.display = 'inline-block'; 
                }
                
                const q = this.questions[this.currentQuestionIndex];
                const originalIndex = this.initialQuestions.findIndex(iQ => iQ.question === q.question); // Para relat√≥rio final

                this.userAnswers[originalIndex] = { 
                    question: q.question, 
                    isCorrect, 
                    userAns, 
                    correctAns, 
                    rationale, 
                    topic: q.topic 
                };
                
                const div = document.createElement('div');
                div.className = 'justification';
                div.innerHTML = rationale;
                div.style.borderLeftColor = isCorrect ? '#28a745' : '#dc3545';
                this.elements.justificationContainer.appendChild(div);
                
                this.elements.nextButton.style.display = 'block';
                this.elements.skipButton.style.display = 'none';
                this.saveQuizState();
            },
            
            nextQuestion: function() {
                this.currentQuestionIndex++;
                this.displayQuestion();
            },

            skipQuestion: function() {
                // Remove a quest√£o da posi√ß√£o atual e coloca no final (simples)
                this.questions.push(this.questions.splice(this.currentQuestionIndex, 1)[0]);
                this.displayQuestion();
            },
            
            showHint: function() {
                const display = this.elements.hintText;
                const button = this.elements.hintButton; 
                const currentQuestion = this.questions[this.currentQuestionIndex];

                this.elements.performanceDisplay.style.display = 'none';
                this.elements.summaryText.style.display = 'none';

                // L√≥gica de 2 N√≠veis para quest√µes com hint_2 (MCQ, TF, Fill-in, Audio)
                if (currentQuestion.hint_2) { 
                    
                    let hint1 = currentQuestion.hint;
                    let hint2 = currentQuestion.hint_2;

                    if (this.hintLevel === 0) { 
                        display.innerHTML = hint1; 
                        display.style.display = 'block';
                        button.textContent = 'DICA 2';
                        this.hintLevel = 1; 
                    } else if (this.hintLevel === 1) { 
                        display.innerHTML = hint1 + '<br><br>' + hint2; 
                        display.style.display = 'block';
                        button.textContent = 'Ocultar Dicas'; 
                        button.style.background = 'linear-gradient(45deg, #28a745, #218838)';
                        this.hintLevel = 2; 
                    } else if (this.hintLevel === 2) { 
                        display.style.display = 'none';
                        button.textContent = 'Mostrar Dicas';
                        button.style.background = '';
                        this.hintLevel = 3; 
                    } else if (this.hintLevel === 3) { 
                        display.innerHTML = hint1 + '<br><br>' + hint2; 
                        display.style.display = 'block';
                        button.textContent = 'Ocultar Dicas';
                        button.style.background = 'linear-gradient(45deg, #28a745, #218838)';
                        this.hintLevel = 2; 
                    }
                } 
                else { // L√≥gica de dica simples (1 clique)
                    if (display.style.display === 'block') {
                        display.style.display = 'none';
                    } else {
                        if (currentQuestion && currentQuestion.hint) {
                            display.innerText = currentQuestion.hint;
                            display.style.display = 'block';
                        }
                    }
                }
            },

            showSummary: function() {
                const display = this.elements.summaryText;
                if (display.style.display === 'block') {
                    display.style.display = 'none';
                } else {
                    const q = this.questions[this.currentQuestionIndex];
                    const topic = q.topic;
                    if (topic && this.summaries[topic]) {
                        display.textContent = this.summaries[topic];
                        display.style.display = 'block';
                        this.elements.performanceDisplay.style.display = 'none';
                        this.elements.hintText.style.display = 'none';
                    } else {
                        display.textContent = "Sem resumo dispon√≠vel para este t√≥pico.";
                        display.style.display = 'block';
                    }
                }
            },
            
            showPerformance: function() {
                const display = this.elements.performanceDisplay;
                if (display.style.display === 'block') {
                    display.style.display = 'none';
                } else {
                    const answeredCount = Object.keys(this.userAnswers).length;
                    const incorrectCount = answeredCount - this.score;
                    display.innerHTML = `<strong style="color: #333;">At√© agora:</strong> <span style="color: #28a745;">${this.score} acertos</span> <strong style="color: #333;">e</strong> <span style="color: #dc3545;">${incorrectCount} erros</span>!`;
                    display.style.display = 'block';
                    this.elements.hintText.style.display = 'none';
                    this.elements.summaryText.style.display = 'none';
                }
            },

            translateQuestion: function() {
                const button = this.elements.translateButton;
                const display = this.elements.translationDisplay;
                
                if (display.style.display === 'block') { display.style.display = 'none'; button.textContent = 'üåê'; return; }
                
                let textToTranslate = this.elements.questionText.textContent;
                display.textContent = 'Traduzindo...'; display.style.display = 'block';
                button.disabled = true;

                fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=en|pt`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.responseData && data.responseData.translatedText) {
                            display.textContent = data.responseData.translatedText;
                        } else {
                            display.textContent = 'Erro ao traduzir. Tente novamente.';
                        }
                        button.disabled = false;
                        button.textContent = 'üôà'; 
                    })
                    .catch(() => {
                        display.textContent = 'N√£o foi poss√≠vel conectar ao servi√ßo de tradu√ß√£o.';
                        button.disabled = false;
                        button.textContent = 'üåê';
                    });
            },

            showResults: function() {
                showCard('results-card', document.getElementById('results-tab-btn'));
                const pct = Math.round((this.score / this.questions.length) * 100);
                
                let classification = "Insatisfat√≥rio!";
                if(pct >= 86) { classification = "Excelente!!!"; confetti({ particleCount: 600, spread: 70, origin: { y: 0.6 } }); }
                else if(pct >= 71) classification = "Muito Bom!!";
                else if(pct >= 51) classification = "Bom!";
                
                this.elements.reportStudentName.textContent = this.validatedStudentName;
                this.elements.reportStudentCode.textContent = this.validatedStudentCode;
                this.elements.scoreDisplay.textContent = `${this.score} de ${this.questions.length}`;
                this.elements.percentageDisplay.textContent = `${pct}%`;
                this.elements.classificationDisplay.textContent = classification;

                const reportData = {
                    studentName: this.validatedStudentName, studentCode: this.validatedStudentCode,
                    score: this.score, totalQuestions: this.questions.length, percentage: pct, classification, 
                    userAnswers: this.userAnswers, isCompleted: true, originalQuestions: this.initialQuestions // Usa initialQuestions
                };
                localStorage.setItem(`${this.storagePrefix}_${this.validatedStudentCode}`, JSON.stringify(reportData));
                
                this.elements.fullReportContainer.innerHTML = this.generateFullReportHtml(this);
                this.elements.personalReportContainer.innerHTML = this.generatePersonalReportHtml(this);
                
                // Configura√ß√£o do bot√£o de envio (apenas Gram√°tica envia no prot√≥tipo original)
                if (this.elements.quizCard.id === 'question-card') {
                    this.elements.sendReportLink.textContent = 'Relat√≥rio Enviado (Grammar)'; 
                } else {
                    this.elements.sendReportLink.textContent = 'Relat√≥rio Enviado (Vocab)'; 
                }
                this.elements.sendReportLink.style.background = '#ccc';
                this.elements.sendReportLink.onclick = (e) => e.preventDefault();
            },
            
            retrieveReport: function(code) {
                const storageKey = this.storagePrefix + '_' + code;
                const r = JSON.parse(localStorage.getItem(storageKey));
                if(r && r.isCompleted) {
                    this.validatedStudentName = r.studentName;
                    this.validatedStudentCode = r.studentCode;
                    this.score = r.score;
                    this.userAnswers = r.userAnswers;
                    this.initialQuestions = r.originalQuestions;
                    this.questions = r.originalQuestions;
                    this.showResults(); 
                } else {
                    alert('Erro ao carregar relat√≥rio ou quiz incompleto.');
                }
            },
            
            printPersonalReport: function() { 
                this.elements.fullReportContainer.style.display = 'none';
                this.elements.personalReportContainer.style.display = 'block';
                window.print();
            },
            printReport: function() { 
                this.elements.personalReportContainer.style.display = 'none';
                this.elements.fullReportContainer.style.display = 'block';
                window.print();
            },
            
            saveQuizState: function() { 
                if (!this.validatedStudentCode) return;
                const state = {
                    isCompleted: false, 
                    currentQuestionIndex: this.currentQuestionIndex,
                    score: this.score,
                    userAnswers: this.userAnswers,
                    shuffledQuestions: this.shuffledQuestions
                };
                localStorage.setItem(this.statePrefix + '_' + this.validatedStudentCode, JSON.stringify(state));
            },
            
            loadQuizState: function(studentCode) {
                 try {
                    const savedState = localStorage.getItem(this.statePrefix + '_' + studentCode);
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        if (!state.isCompleted) {
                            this.currentQuestionIndex = state.currentQuestionIndex;
                            this.score = state.score;
                            this.userAnswers = state.userAnswers;
                            this.shuffledQuestions = state.shuffledQuestions;
                            this.questions = state.shuffledQuestions; 
                            return true;
                        }
                    }
                } catch (e) {
                    console.error("N√£o foi poss√≠vel carregar o estado do quiz:", e);
                    localStorage.removeItem(this.statePrefix + '_' + studentCode); 
                }
                return false; 
            },
            
            updateAttemptsDisplay: function(code) {
                 const stateKey = this.statePrefix + '_' + code;
                 const reportKey = this.storagePrefix + '_' + code;
                 const savedStateJSON = localStorage.getItem(stateKey); 
                 const finalReportJSON = localStorage.getItem(reportKey); 
                 const correctName = STUDENT_DATA[code];

                if (correctName) {
                    this.elements.personalizedWelcome.textContent = `Seja bem-vindo(a), ${correctName}! Boa sorte!`;
                    this.elements.personalizedWelcome.style.display = 'block';
                }

                let state = null;
                let finalReport = null;
                try { if (savedStateJSON) state = JSON.parse(savedStateJSON); } catch (e) { localStorage.removeItem(stateKey); }
                try { if (finalReportJSON) finalReport = JSON.parse(finalReportJSON); } catch (e) { localStorage.removeItem(reportKey); }

                let buttonsHtml = '';

                if (state && !state.isCompleted) {
                    buttonsHtml = `
                        <p style="font-weight: bold; color: #007bff;">Encontramos um progresso salvo para voc√™.</p>
                        <button class="btn continue-btn" onclick="quizApp.startQuiz(true)">Continuar Quiz</button>
                        <button class="btn restart-btn" style="margin-left: 10px;" onclick="quizApp.startQuiz(false)">Reiniciar (Perder Progresso)</button>
                    `;
                } else if (state && state.isCompleted) {
                    buttonsHtml = `
                        <p style="font-weight: bold; color: #007bff;">Voc√™ j√° completou este quiz.</p>
                        <button class="btn restart-btn" onclick="quizApp.startQuiz(false)">Reiniciar Quiz</button>
                    `;
                } else {
                    buttonsHtml = `
                        <button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>
                    `;
                }

                if (finalReport) {
                    if (state && state.isCompleted) {
                        buttonsHtml = `
                            <p style="font-weight: bold; color: #007bff;">Voc√™ j√° completou este quiz.</p>
                            <button class="btn restart-btn" onclick="quizApp.startQuiz(false)">Reiniciar Quiz</button>
                            <button class="btn continue-btn" style="margin-left: 10px;" onclick="quizApp.retrieveReport('${code}')">Resgatar Relat√≥rio</button>
                        `;
                    } else {
                        buttonsHtml += `
                            <button class="btn continue-btn" style="margin-left: 10px;" onclick="quizApp.retrieveReport('${code}')">Resgatar √öltimo Relat√≥rio</button>
                        `;
                    }
                }
                
                this.elements.startActionsDiv.innerHTML = buttonsHtml;
            },
            
            restartQuiz: function() { location.reload(); },
            saveReport: function() {
                const reportApp = this.elements.quizCard.id === 'question-card' ? quizApp : vocabQuizApp;
                
                const studentName = reportApp.validatedStudentName;
                const studentCode = reportApp.validatedStudentCode;
                const score = reportApp.elements.scoreDisplay.textContent;
                const percentage = reportApp.elements.percentageDisplay.textContent;
                const classification = reportApp.elements.classificationDisplay.textContent;
                
                const detailedReportHtml = reportApp.generateFullReportHtml(reportApp);
                const personalReportHtml = reportApp.generatePersonalReportHtml(reportApp);

                // ... C√≥digo para salvar em HTML (Mantido do prot√≥tipo M√©dio/Alto)
                const fullHtmlContent = `
                    <!DOCTYPE html>
                    <html lang="pt-BR">
                    <head>
                        <meta charset="UTF-8">
                        <title>Relat√≥rio - ${studentName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                            h1, h3 { color: #007bff; }
                            h4 { color: #856404; }
                            p { margin: 5px 0; }
                            .report-question-item { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; page-break-inside: avoid; }
                            .option-item-report.correct { background-color: #d4edda; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                            .option-item-report.incorrect { background-color: #f8d7da; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                            .personal-summary-item { background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; padding: 15px; margin-bottom: 15px; page-break-inside: avoid; }
                        </style>
                    </head>
                    <body>
                        <h1>Relat√≥rio Final - Quiz de ${reportApp.elements.quizCard.id === 'question-card' ? 'Gram√°tica' : 'Vocabul√°rio'}</h1>
                        <p><strong>Nome:</strong> ${studentName}</p>
                        <p><strong>C√≥digo de Acesso:</strong> ${studentCode}</p>
                        <p><strong>Pontua√ß√£o:</strong> ${score}</p>
                        <p><strong>Percentual de Acerto:</strong> ${percentage}</p>
                        <p><strong>Classifica√ß√£o:</strong> ${classification}</p>
                        <hr>
                        <div id="personal-report-container">${personalReportHtml}</div>
                        <hr>
                        <div id="full-report-container">${detailedReportHtml}</div>
                    </body>
                    </html>
                `;

                const blob = new Blob([fullHtmlContent], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Relatorio_${studentName.replace(' ', '_')}_${studentCode}_${reportApp.elements.quizCard.id === 'question-card' ? 'G' : 'V'}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            }
        };

        // --- INST√ÇNCIAS ESPEC√çFICAS (GRAMMAR E VOCABULARY) ---

        // 1. QUIZ DE GRAM√ÅTICA (quizApp)
        const quizApp = Object.assign(Object.create(quizBase), {
            initialQuestions: GRAMMAR_QUESTIONS,
            storagePrefix: 'quizReport',
            statePrefix: 'quizState',
            elements: {
                studentCodeInput: document.getElementById('student-code'),
                quizCard: document.getElementById('question-card'),
                questionText: document.getElementById('question-text'), optionsList: document.getElementById('options-list'),
                justificationContainer: document.getElementById('justification-container'), nextButton: document.getElementById('next-button'),
                skipButton: document.getElementById('skip-button'), hintButton: document.getElementById('hint-button'),
                hintText: document.getElementById('hint-text'), summaryButton: document.getElementById('summary-button'), 
                summaryText: document.getElementById('summary-text'), performanceButton: document.getElementById('performance-btn'), 
                performanceDisplay: document.getElementById('performance-display'), currentQuestionNumSpan: document.getElementById('current-question-num'),
                scoreDisplay: document.getElementById('score-display'), percentageDisplay: document.getElementById('percentage-display'),
                classificationDisplay: document.getElementById('classification-display'), reportStudentName: document.getElementById('report-student-name'),
                reportStudentCode: document.getElementById('report-student-code'), sendReportLink: document.getElementById('send-report-link'),
                introAttemptsLeftSpan: document.getElementById('intro-attempts-left'), fullReportContainer: document.getElementById('full-report-container'),
                personalizedWelcome: document.getElementById('personalized-welcome'), startActionsDiv: document.getElementById('start-actions'),
                progressBar: document.getElementById('progress-bar'), translateButton: document.getElementById('translate-button'),
                translationDisplay: document.getElementById('translation-display'), personalReportContainer: document.getElementById('personal-report-container'),
                audioContainer: document.getElementById('audio-container'), audioPlayContainer: document.getElementById('audio-play-container')
            }
        });

        // 2. QUIZ DE VOCABUL√ÅRIO (vocabQuizApp)
        const vocabQuizApp = Object.assign(Object.create(quizBase), {
            initialQuestions: VOCAB_QUESTIONS,
            storagePrefix: 'vocabQuizReport',
            statePrefix: 'vocabQuizState',
            elements: {
                quizCard: document.getElementById('vocab-quiz-card'),
                questionText: document.getElementById('vocab-question-text'), optionsList: document.getElementById('vocab-options-list'),
                justificationContainer: document.getElementById('vocab-justification-container'), nextButton: document.getElementById('vocab-next-button'),
                skipButton: document.getElementById('vocab-skip-button'), hintButton: document.getElementById('vocab-hint-button'),
                hintText: document.getElementById('vocab-hint-text'), summaryButton: document.getElementById('vocab-summary-button'), 
                summaryText: document.getElementById('vocab-summary-text'), performanceButton: document.getElementById('vocab-performance-btn'), 
                performanceDisplay: document.getElementById('vocab-performance-display'), currentQuestionNumSpan: document.getElementById('vocab-current-question-num'),
                progressBar: document.getElementById('vocab-progress-bar'), translateButton: document.getElementById('vocab-translate-button'),
                translationDisplay: document.getElementById('vocab-translation-display'),
                audioContainer: document.getElementById('vocab-audio-container'), audioPlayContainer: document.getElementById('vocab-audio-play-container'),
                
                // Elementos de resultado (compartilhados)
                scoreDisplay: document.getElementById('score-display'), percentageDisplay: document.getElementById('percentage-display'),
                classificationDisplay: document.getElementById('classification-display'), reportStudentName: document.getElementById('report-student-name'),
                reportStudentCode: document.getElementById('report-student-code'), sendReportLink: document.getElementById('send-report-link'),
                fullReportContainer: document.getElementById('full-report-container'), personalReportContainer: document.getElementById('personal-report-container')
            }
        });
        
        // --- FUN√á√ïES GLOBAIS DE NAVEGA√á√ÉO E MODAL ---
        
        function showCard(cardId, element) {
            const validIds = ['intro-card', 'question-card', 'vocab-quiz-card', 'results-card', 'roteiro-content-tab', 'apostila-content-tab'];
            validIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            const buttons = document.querySelectorAll('.tablinks');
            buttons.forEach(btn => btn.classList.remove('active'));

            const card = document.getElementById(cardId);
            if (card) {
                card.style.display = ['intro-card', 'question-card', 'vocab-quiz-card', 'results-card'].includes(cardId) ? 'flex' : 'block';
                card.style.flexDirection = 'column';
            }
            if (element) element.classList.add('active');
        }

        function checkLoginAndShow(cardId, element) {
            if (!quizApp.validatedStudentCode) {
                alert('Por favor, fa√ßa o login na aba "In√≠cio" primeiro!');
                showCard('intro-card', document.querySelector('.tab-inicio'));
                return;
            }
            showCard(cardId, element);
        }

        function checkLoginAndShowResults(cardId, element) {
            if (!quizApp.validatedStudentCode) {
                alert('Por favor, fa√ßa o login na aba "In√≠cio" primeiro!');
                showCard('intro-card', document.querySelector('.tab-inicio'));
                return;
            }

            const code = quizApp.validatedStudentCode;
            const grammarReportJSON = localStorage.getItem(`quizReport_${code}`);
            const vocabReportJSON = localStorage.getItem(`vocabQuizReport_${code}`);

            if (grammarReportJSON) {
                quizApp.retrieveReport(code);
            } else if (vocabReportJSON) {
                vocabQuizApp.retrieveReport(code);
            } else {
                alert("Voc√™ ainda n√£o completou nenhum quiz para ver os resultados. Termine um quiz primeiro!");
                showCard('intro-card', document.querySelector('.tab-inicio'));
            }
        }

        function startVocabQuiz(element) {
            if (!quizApp.validatedStudentCode) {
                alert('Por favor, fa√ßa o login na aba "In√≠cio" primeiro!');
                showCard('intro-card', document.querySelector('.tab-inicio'));
                return;
            }
            vocabQuizApp.validatedStudentName = quizApp.validatedStudentName;
            vocabQuizApp.validatedStudentCode = quizApp.validatedStudentCode;
            showCard('vocab-quiz-card', element);
            vocabQuizApp.startQuiz(false);
        }
        
        // --- FUN√á√ïES DE CONTE√öDO E MODAL (ADAPTADAS DO PROT√ìTIPO M√âDIO/ALTO) ---
        
        function openVideoLink() { window.open(VIDEO_LINK, '_blank'); }

        function setupAdminLinks(isAdmin) {
            const roteiroDiv = document.getElementById('content-buttons-roteiro');
            const apostilaDiv = document.getElementById('content-buttons-apostila');
            
            const roteiroPreview = PDF_LINK_ROTEIRO.replace('/view?usp=drive_link', '/preview');
            const apostilaPreview = PDF_LINK_APOSTILA.replace('/view?usp=drive_link', '/preview');
            
            const roteiroDownload = PDF_LINK_ROTEIRO.replace('/view?usp=drive_link', '/view');
            const apostilaDownload = PDF_LINK_APOSTILA.replace('/view?usp=drive_link', '/view');

            roteiroDiv.innerHTML = `
                <button class="btn save-report-btn" onclick="openReadModal('${roteiroPreview}', 'Roteiro de Estudos')">Ler Roteiro Online üìñ</button>
                <button class="btn start-btn" onclick="window.open('${roteiroDownload}', '_blank')">Baixar Roteiro üíæ</button>
            `;
            apostilaDiv.innerHTML = `
                <button class="btn save-report-btn" onclick="openReadModal('${apostilaPreview}', 'Apostila Conclu√≠da')">Ler Apostila Online üìñ</button>
                <button class="btn start-btn" onclick="window.open('${apostilaDownload}', '_blank')">Baixar Apostila üíæ</button>
            `;
            // Adiciona o painel de admin se for o professor
            const adminR = document.getElementById('admin-panel-roteiro');
            const adminA = document.getElementById('admin-panel-apostila');
             if(adminR) adminR.style.display = isAdmin ? 'block' : 'none';
             if(adminA) adminA.style.display = isAdmin ? 'block' : 'none';
        }
        
        function openReadModal(pdfLink, title) {
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');
            modalBody.innerHTML = ''; 
            modalTitle.textContent = title || 'Material de Estudo';
            
            if (pdfLink) {
                const iframe = document.createElement('iframe');
                iframe.src = pdfLink;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                modalBody.appendChild(iframe);
            } else {
                modalBody.innerHTML = '<p style="padding: 20px; text-align: center;">Erro: Link do PDF n√£o encontrado ou n√£o configurado.</p>';
            }
            
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeReadModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('modal-body').innerHTML = ''; 
            document.getElementById('modal-content').classList.remove('night-mode');
            document.getElementById('night-mode-toggle').textContent = 'Modo Noturno üåô';
        }

        function toggleNightMode() {
            const modalContent = document.getElementById('modal-content');
            modalContent.classList.toggle('night-mode');
            
            const btn = document.getElementById('night-mode-toggle');
            if (modalContent.classList.contains('night-mode')) {
                btn.textContent = 'Modo Claro ‚òÄÔ∏è';
            } else {
                btn.textContent = 'Modo Noturno üåô';
            }
        }


        // --- INICIALIZA√á√ÉO E BINDING DE EVENTOS ---
        
        window.onload = function() {
            
            // BINDINGS DO QUIZ DE GRAM√ÅTICA (j√° feito nas inst√¢ncias, mas aqui para garantir)
            quizApp.elements.nextButton.onclick = () => quizApp.nextQuestion();
            quizApp.elements.skipButton.onclick = () => quizApp.skipQuestion();
            quizApp.elements.hintButton.onclick = () => quizApp.showHint();
            quizApp.elements.translateButton.onclick = () => quizApp.translateQuestion();
            quizApp.elements.performanceButton.onclick = () => quizApp.showPerformance();
            quizApp.elements.summaryButton.onclick = () => quizApp.showSummary();

            // BINDINGS DO QUIZ DE VOCABUL√ÅRIO (j√° feito nas inst√¢ncias)
            vocabQuizApp.elements.nextButton.onclick = () => vocabQuizApp.nextQuestion();
            vocabQuizApp.elements.skipButton.onclick = () => vocabQuizApp.skipQuestion();
            vocabQuizApp.elements.hintButton.onclick = () => vocabQuizApp.showHint();
            vocabQuizApp.elements.translateButton.onclick = () => vocabQuizApp.translateQuestion();
            vocabQuizApp.elements.performanceButton.onclick = () => vocabQuizApp.showPerformance();
            vocabQuizApp.elements.summaryButton.onclick = () => vocabQuizApp.showSummary();
            
            // BINDINGS DO MODAL PDF
            document.getElementById('modal-close-btn').onclick = closeReadModal;
            document.getElementById('night-mode-toggle').onclick = toggleNightMode;
            
            const modalOverlay = document.getElementById('modal-overlay');
            modalOverlay.onclick = function(event) {
                if (event.target == modalOverlay) {
                    closeReadModal();
                }
            };

            // L√≥gica de Login (Adaptada do PROT√ìTIPO M√âDIO/ALTO)
            document.getElementById('student-code').addEventListener('input', (e) => {
                const code = e.target.value.trim().toUpperCase();
                if (STUDENT_DATA[code]) { 
                    quizApp.validatedStudentCode = code; // Define para Gram√°tica
                    vocabQuizApp.validatedStudentCode = code; // Define para Vocabul√°rio
                    quizApp.updateAttemptsDisplay(code); 
                    setupAdminLinks(code === '123');
                } 
                else { 
                    quizApp.elements.startActionsDiv.innerHTML = '<button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>'; 
                    quizApp.elements.personalizedWelcome.style.display = 'none';
                    quizApp.validatedStudentCode = '';
                    setupAdminLinks(false);
                }
            });
            
            setupAdminLinks(false); 
            showCard('intro-card', document.querySelector('.tab-inicio'));
        };
    </script>
</body>
</html>